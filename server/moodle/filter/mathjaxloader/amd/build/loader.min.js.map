{"version":3,"file":"loader.min.js","sources":["../src/loader.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/ //\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Mathjax JS Loader.\r\n *\r\n * @module filter_mathjaxloader/loader\r\n * @copyright 2014 Damyon Wiese  <damyon@moodle.com>\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\nimport {\r\n    eventTypes,\r\n    notifyFilterContentRenderingComplete,\r\n} from 'core_filters/events';\r\n\r\n/**\r\n * The users current language - this can't be set until MathJax is loaded - so we need to store it.\r\n * @property {string} lang\r\n * @default ''\r\n * @private\r\n */\r\nlet lang = '';\r\n\r\n/**\r\n * Used to prevent configuring MathJax twice.\r\n * @property {boolean} configured\r\n * @default false\r\n * @private\r\n */\r\nlet configured = false;\r\n\r\n/**\r\n * Called by the filter when it is active on any page.\r\n * This does not load MathJAX yet - it addes the configuration to the head incase it gets loaded later.\r\n * It also subscribes to the filter-content-updated event so MathJax can respond to content loaded by Ajax.\r\n *\r\n * @param {Object} params List of configuration params containing mathjaxconfig (text) and lang\r\n */\r\nexport const configure = (params) => {\r\n    // Add a js configuration object to the head.\r\n    // See \"https://docs.mathjax.org/en/v2.7-latest/advanced/dynamic.html\"\r\n    const script = document.createElement(\"script\");\r\n    script.type = \"text/x-mathjax-config\";\r\n    script[(window.opera ? \"innerHTML\" : \"text\")] = params.mathjaxconfig;\r\n    document.getElementsByTagName(\"head\")[0].appendChild(script);\r\n\r\n    // Save the lang config until MathJax is actually loaded.\r\n    lang = params.lang;\r\n\r\n    // Listen for events triggered when new text is added to a page that needs\r\n    // processing by a filter.\r\n    document.addEventListener(eventTypes.filterContentUpdated, contentUpdated);\r\n};\r\n\r\n/**\r\n * Set the correct language for the MathJax menus. Only do this once.\r\n *\r\n * @private\r\n */\r\nconst setLocale = () => {\r\n    if (!configured) {\r\n        if (typeof window.MathJax !== \"undefined\") {\r\n            window.MathJax.Hub.Queue(function() {\r\n                window.MathJax.Localization.setLocale(lang);\r\n            });\r\n            window.MathJax.Hub.Configured();\r\n            configured = true;\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Add the node to the typeset queue.\r\n *\r\n * @param {HTMLElement} node The Node to be processed by MathJax\r\n * @private\r\n */\r\nconst typesetNode = (node) => {\r\n    if (!(node instanceof HTMLElement)) {\r\n        // We may have been passed a #text node.\r\n        // These cannot be formatted.\r\n        return;\r\n    }\r\n\r\n    // MathJax 2.X does not notify when complete. The best we can do, according to their docs, is to queue a callback.\r\n    // See https://docs.mathjax.org/en/v2.7-latest/advanced/typeset.html\r\n    // Note that the MathJax.Hub.Queue() method will return immediately, regardless of whether the typesetting has taken place\r\n    // or not, so you can not assume that the mathematics is visible after you make this call.\r\n    // That means that things like the size of the container for the mathematics may not yet reflect the size of the\r\n    // typeset mathematics. If you need to perform actions that depend on the mathematics being typeset, you should push those\r\n    // actions onto the MathJax.Hub.queue as well.\r\n    window.MathJax.Hub.Queue([\"Typeset\", window.MathJax.Hub, node]);\r\n    window.MathJax.Hub.Queue([(node) => {\r\n        // The notifyFilterContentRenderingComplete event takes an Array of NodeElements or a NodeList.\r\n        // We cannot create a NodeList so we use an HTMLElement[].\r\n        notifyFilterContentRenderingComplete([node]);\r\n    }, node]);\r\n};\r\n\r\n/**\r\n * Called by the filter when an equation is found while rendering the page.\r\n */\r\nexport const typeset = () => {\r\n    if (!configured) {\r\n        setLocale();\r\n        const elements = document.getElementsByClassName('filter_mathjaxloader_equation');\r\n        for (const element of elements) {\r\n            if (typeof window.MathJax !== \"undefined\") {\r\n                typesetNode(element);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Handle content updated events - typeset the new content.\r\n *\r\n * @param {CustomEvent} event - Custom event with \"nodes\" indicating the root of the updated nodes.\r\n */\r\nexport const contentUpdated = (event) => {\r\n    if (typeof window.MathJax === \"undefined\") {\r\n        return;\r\n    }\r\n\r\n    let listOfElementContainMathJax = [];\r\n    let hasMathJax = false;\r\n    // The list of HTMLElements in an Array.\r\n    event.detail.nodes.forEach((node) => {\r\n        if (!(node instanceof HTMLElement)) {\r\n            // We may have been passed a #text node.\r\n            return;\r\n        }\r\n        const mathjaxElements = node.querySelectorAll('.filter_mathjaxloader_equation');\r\n        if (mathjaxElements.length > 0) {\r\n            hasMathJax = true;\r\n        }\r\n        listOfElementContainMathJax.push(mathjaxElements);\r\n    });\r\n    if (!hasMathJax) {\r\n        return;\r\n    }\r\n    const processDelay = window.MathJax.Hub.processSectionDelay;\r\n    // Set the process section delay to 0 when updating the formula.\r\n    window.MathJax.Hub.processSectionDelay = 0;\r\n    // When content is updated never position to hash, it may cause unexpected document scrolling.\r\n    window.MathJax.Hub.Config({positionToHash: false});\r\n    setLocale();\r\n    listOfElementContainMathJax.forEach((mathjaxElements) => {\r\n        mathjaxElements.forEach((node) => typesetNode(node));\r\n    });\r\n    window.MathJax.Hub.processSectionDelay = processDelay;\r\n};\r\n"],"names":["lang","configured","_exports","configure","params","script","document","createElement","type","window","opera","mathjaxconfig","getElementsByTagName","appendChild","addEventListener","eventTypes","filterContentUpdated","contentUpdated","setLocale","MathJax","Hub","Queue","Localization","Configured","typesetNode","node","HTMLElement","notifyFilterContentRenderingComplete","typeset","elements","getElementsByClassName","element","event","listOfElementContainMathJax","hasMathJax","detail","nodes","forEach","mathjaxElements","querySelectorAll","length","push","processDelay","processSectionDelay","Config","positionToHash"],"mappings":";;;;;;;;AAgCA,IAAIA,KAAO,GAQPC,YAAa,EAuBfC,SAAAC,UAdwBC,SAGtB,MAAMC,OAASC,SAASC,cAAc,UACtCF,OAAOG,KAAO,wBACdH,OAAQI,OAAOC,MAAQ,YAAc,QAAWN,OAAOO,cACvDL,SAASM,qBAAqB,QAAQ,GAAGC,YAAYR,QAGrDL,KAAOI,OAAOJ,KAIdM,SAASQ,iBAAiBC,QAAAA,WAAWC,qBAAsBC,eAAe,EAQ9E,MAAMC,UAAYA,KACTjB,iBAC6B,IAAnBQ,OAAOU,UACdV,OAAOU,QAAQC,IAAIC,OAAM,WACrBZ,OAAOU,QAAQG,aAAaJ,UAAUlB,KAC1C,IACAS,OAAOU,QAAQC,IAAIG,aACnBtB,YAAa,EAErB,EASEuB,YAAeC,OACXA,gBAAgBC,cAatBjB,OAAOU,QAAQC,IAAIC,MAAM,CAAC,UAAWZ,OAAOU,QAAQC,IAAKK,OACzDhB,OAAOU,QAAQC,IAAIC,MAAM,CAAEI,QAGvB,EAAAE,QAAoCA,sCAAC,CAACF,MAAM,EAC7CA,OAAM,EAgBXvB,SAAA0B,QAVqBA,KACnB,IAAK3B,WAAY,CACbiB,YACA,MAAMW,SAAWvB,SAASwB,uBAAuB,iCACjD,IAAK,MAAMC,WAAWF,cACY,IAAnBpB,OAAOU,SACdK,YAAYO,QAGxB,GAQG,MAAMd,eAAkBe,QAC3B,QAA8B,IAAnBvB,OAAOU,QACd,OAGJ,IAAIc,4BAA8B,GAC9BC,YAAa,EAajB,GAXAF,MAAMG,OAAOC,MAAMC,SAASZ,OACxB,KAAMA,gBAAgBC,aAElB,OAEJ,MAAMY,gBAAkBb,KAAKc,iBAAiB,kCAC1CD,gBAAgBE,OAAS,IACzBN,YAAa,GAEjBD,4BAA4BQ,KAAKH,gBAAgB,KAEhDJ,WACD,OAEJ,MAAMQ,aAAejC,OAAOU,QAAQC,IAAIuB,oBAExClC,OAAOU,QAAQC,IAAIuB,oBAAsB,EAEzClC,OAAOU,QAAQC,IAAIwB,OAAO,CAACC,gBAAgB,IAC3C3B,YACAe,4BAA4BI,SAASC,kBACjCA,gBAAgBD,SAASZ,MAASD,YAAYC,OAAM,IAExDhB,OAAOU,QAAQC,IAAIuB,oBAAsBD,YAAY,EACvDxC,SAAAe,eAAAA,cAAA"}