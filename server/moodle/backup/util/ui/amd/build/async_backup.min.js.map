{"version":3,"file":"async_backup.min.js","sources":["../src/async_backup.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * This module updates the UI during an asynchronous\r\n * backup or restore process.\r\n *\r\n * @module     core_backup/async_backup\r\n * @copyright  2018 Matt Porritt <mattp@catalyst-au.net>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      3.7\r\n */\r\ndefine(['jquery', 'core/ajax', 'core/str', 'core/notification', 'core/templates'],\r\n        function($, ajax, Str, notification, Templates) {\r\n\r\n    /**\r\n     * Module level constants.\r\n     *\r\n     * Using var instead of const as ES6 isn't fully supported yet.\r\n     */\r\n    var STATUS_EXECUTING = 800;\r\n    var STATUS_FINISHED_ERR = 900;\r\n    var STATUS_FINISHED_OK = 1000;\r\n\r\n    /**\r\n     * Module level variables.\r\n     */\r\n    var Asyncbackup = {};\r\n    var checkdelayoriginal = 15000; // This is the default time to use.\r\n    var checkdelay = 15000; // How often we should check for progress updates.\r\n    var checkdelaymultipler = 1.5; // If a request fails this multiplier will be used to increase the checkdelay value\r\n    var backupid; //  The backup id to get the progress for.\r\n    var contextid; //  The course this backup progress is for.\r\n    var restoreurl; //  The URL to view course restores.\r\n    var typeid; //  The type of operation backup or restore.\r\n    var backupintervalid; //  The id of the setInterval function.\r\n    var allbackupintervalid; //  The id of the setInterval function.\r\n    var allcopyintervalid; //  The id of the setInterval function.\r\n    var timeout = 2000; // Timeout for ajax requests.\r\n\r\n    /**\r\n     * Helper function to update UI components.\r\n     *\r\n     * @param {string} backupid The id to match elements on.\r\n     * @param {string} type The type of operation, backup or restore.\r\n     * @param {number} percentage The completion percentage to apply.\r\n     */\r\n    function updateElement(backupid, type, percentage) {\r\n        var percentagewidth = Math.round(percentage) + '%';\r\n        var elementbar = document.querySelectorAll(\"[data-\" + type + \"id=\" + CSS.escape(backupid) + \"]\")[0];\r\n        var percentagetext = percentage.toFixed(2) + '%';\r\n\r\n        // Set progress bar percentage indicators\r\n        elementbar.setAttribute('aria-valuenow', percentagewidth);\r\n        elementbar.style.width = percentagewidth;\r\n        elementbar.innerHTML = percentagetext;\r\n    }\r\n\r\n    /**\r\n     * Updates the interval we use to check for backup progress.\r\n     *\r\n     * @param {Number} intervalid The id of the interval\r\n     * @param {Function} callback The function to use in setInterval\r\n     * @param {Number} value The specified interval (in milliseconds)\r\n     * @returns {Number}\r\n     */\r\n    function updateInterval(intervalid, callback, value) {\r\n        clearInterval(intervalid);\r\n        return setInterval(callback, value);\r\n    }\r\n\r\n    /**\r\n     * Update backup table row when an async backup completes.\r\n     *\r\n     * @param {string} backupid The id to match elements on.\r\n     */\r\n    function updateBackupTableRow(backupid) {\r\n        var statuscell = $('#' + backupid + '_bar').parent().parent();\r\n        var tablerow = statuscell.parent();\r\n        var cellsiblings = statuscell.siblings();\r\n        var timecell = cellsiblings[1];\r\n        var timevalue = $(timecell).text();\r\n        var filenamecell = cellsiblings[0];\r\n        var filename = $(filenamecell).text();\r\n\r\n        ajax.call([{\r\n            // Get the table data via webservice.\r\n            methodname: 'core_backup_get_async_backup_links_backup',\r\n            args: {\r\n                'filename': filename,\r\n                'contextid': contextid,\r\n                'backupid': backupid\r\n            },\r\n        }])[0].done(function(response) {\r\n            // We have the data now update the UI.\r\n            var context = {\r\n                    filename: filename,\r\n                    time: timevalue,\r\n                    size: response.filesize,\r\n                    fileurl: response.fileurl,\r\n                    restoreurl: response.restoreurl\r\n                    };\r\n\r\n            Templates.render('core/async_backup_progress_row', context).then(function(html, js) {\r\n                Templates.replaceNodeContents(tablerow, html, js);\r\n                return;\r\n            }).fail(function() {\r\n                notification.exception(new Error('Failed to load table row'));\r\n                return;\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Update restore table row when an async restore completes.\r\n     *\r\n     * @param {string} backupid The id to match elements on.\r\n     */\r\n    function updateRestoreTableRow(backupid) {\r\n        var statuscell = $('#' + backupid + '_bar').parent().parent();\r\n        var tablerow = statuscell.parent();\r\n        var cellsiblings = statuscell.siblings();\r\n        var coursecell = cellsiblings[0];\r\n        var timecell = cellsiblings[1];\r\n        var timevalue = $(timecell).text();\r\n\r\n        ajax.call([{\r\n            // Get the table data via webservice.\r\n            methodname: 'core_backup_get_async_backup_links_restore',\r\n            args: {\r\n                'backupid': backupid,\r\n                'contextid': contextid\r\n            },\r\n        }])[0].done(function(response) {\r\n         // We have the data now update the UI.\r\n            var resourcename = $(coursecell).text();\r\n            var context = {\r\n                    resourcename: resourcename,\r\n                    restoreurl: response.restoreurl,\r\n                    time: timevalue\r\n                    };\r\n\r\n            Templates.render('core/async_restore_progress_row', context).then(function(html, js) {\r\n                Templates.replaceNodeContents(tablerow, html, js);\r\n                return;\r\n            }).fail(function() {\r\n                notification.exception(new Error('Failed to load table row'));\r\n                return;\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Update copy table row when an course copy completes.\r\n     *\r\n     * @param {string} backupid The id to match elements on.\r\n     */\r\n    function updateCopyTableRow(backupid) {\r\n        var elementbar = document.querySelectorAll(\"[data-restoreid=\" + CSS.escape(backupid) + \"]\")[0];\r\n        var restorecourse = elementbar.closest('tr').children[1];\r\n        var coursename = restorecourse.innerHTML;\r\n        var courselink = document.createElement('a');\r\n        var elementbarparent = elementbar.closest('td');\r\n        var operation = elementbarparent.previousElementSibling;\r\n\r\n        // Replace the prgress bar.\r\n        Str.get_string('complete').then(function(content) {\r\n            operation.innerHTML = content;\r\n            return;\r\n        }).catch(function() {\r\n            notification.exception(new Error('Failed to load string: complete'));\r\n            return;\r\n        });\r\n\r\n        Templates.render('core/async_copy_complete_cell', {}).then(function(html, js) {\r\n            Templates.replaceNodeContents(elementbarparent, html, js);\r\n            return;\r\n        }).fail(function() {\r\n            notification.exception(new Error('Failed to load table cell'));\r\n            return;\r\n        });\r\n\r\n        // Update the destination course name to a link to that course.\r\n        ajax.call([{\r\n            methodname: 'core_backup_get_async_backup_links_restore',\r\n            args: {\r\n                'backupid': backupid,\r\n                'contextid': 0\r\n            },\r\n        }])[0].done(function(response) {\r\n            courselink.setAttribute('href', response.restoreurl);\r\n            courselink.innerHTML = coursename;\r\n            restorecourse.innerHTML = null;\r\n            restorecourse.appendChild(courselink);\r\n\r\n            return;\r\n        }).fail(function() {\r\n            notification.exception(new Error('Failed to update table row'));\r\n            return;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Update the Moodle user interface with the progress of\r\n     * the backup process.\r\n     *\r\n     * @param {object} progress The progress and status of the process.\r\n     */\r\n    function updateProgress(progress) {\r\n        var percentage = progress.progress * 100;\r\n        var type = 'backup';\r\n        var elementbar = document.querySelectorAll(\"[data-\" + type + \"id=\" + CSS.escape(backupid) + \"]\")[0];\r\n        var elementstatus = $('#' + backupid + '_status');\r\n        var elementdetail = $('#' + backupid + '_detail');\r\n        var elementbutton = $('#' + backupid + '_button');\r\n        var stringRequests;\r\n\r\n        if (progress.status == STATUS_EXECUTING) {\r\n            // Process is in progress.\r\n            // Add in progress class color to bar.\r\n            elementbar.classList.add('bg-success');\r\n\r\n            updateElement(backupid, type, percentage);\r\n\r\n            // Change heading.\r\n            var strProcessing = 'async' + typeid + 'processing';\r\n            Str.get_string(strProcessing, 'backup').then(function(title) {\r\n                elementstatus.text(title);\r\n                return;\r\n            }).catch(function() {\r\n                notification.exception(new Error('Failed to load string: backup ' + strProcessing));\r\n            });\r\n\r\n        } else if (progress.status == STATUS_FINISHED_ERR) {\r\n            // Process completed with error.\r\n\r\n            // Add in fail class color to bar.\r\n            elementbar.classList.add('bg-danger');\r\n\r\n            // Remove in progress class color to bar.\r\n            elementbar.classList.remove('bg-success');\r\n\r\n            updateElement(backupid, type, 100);\r\n\r\n            // Change heading and text.\r\n            var strStatus = 'async' + typeid + 'error';\r\n            var strStatusDetail = 'async' + typeid + 'errordetail';\r\n            stringRequests = [\r\n                {key: strStatus, component: 'backup'},\r\n                {key: strStatusDetail, component: 'backup'}\r\n            ];\r\n            Str.get_strings(stringRequests).then(function(strings) {\r\n                elementstatus.text(strings[0]);\r\n                elementdetail.text(strings[1]);\r\n\r\n                return;\r\n            })\r\n            .catch(function() {\r\n                notification.exception(new Error('Failed to load string'));\r\n                return;\r\n            });\r\n\r\n            $('.backup_progress').children('span').removeClass('backup_stage_current');\r\n            $('.backup_progress').children('span').last().addClass('backup_stage_current');\r\n\r\n            // Stop checking when we either have an error or a completion.\r\n            clearInterval(backupintervalid);\r\n\r\n        } else if (progress.status == STATUS_FINISHED_OK) {\r\n            // Process completed successfully.\r\n\r\n            // Add in progress class color to bar\r\n            elementbar.classList.add('bg-success');\r\n\r\n            updateElement(backupid, type, 100);\r\n\r\n            // Change heading and text\r\n            var strComplete = 'async' + typeid + 'complete';\r\n            Str.get_string(strComplete, 'backup').then(function(title) {\r\n                elementstatus.text(title);\r\n                return;\r\n            }).catch(function() {\r\n                notification.exception(new Error('Failed to load string: backup ' + strComplete));\r\n            });\r\n\r\n            if (typeid == 'restore') {\r\n                ajax.call([{\r\n                    // Get the table data via webservice.\r\n                    methodname: 'core_backup_get_async_backup_links_restore',\r\n                    args: {\r\n                        'backupid': backupid,\r\n                        'contextid': contextid\r\n                    },\r\n                }])[0].done(function(response) {\r\n                    var strDetail = 'async' + typeid + 'completedetail';\r\n                    var strButton = 'async' + typeid + 'completebutton';\r\n                    var stringRequests = [\r\n                        {key: strDetail, component: 'backup', param: response.restoreurl},\r\n                        {key: strButton, component: 'backup'}\r\n                    ];\r\n                    Str.get_strings(stringRequests).then(function(strings) {\r\n                        elementdetail.html(strings[0]);\r\n                        elementbutton.text(strings[1]);\r\n                        elementbutton.attr('href', response.restoreurl);\r\n\r\n                        return;\r\n                    })\r\n                    .catch(function() {\r\n                        notification.exception(new Error('Failed to load string'));\r\n                        return;\r\n                    });\r\n\r\n                });\r\n            } else {\r\n                var strDetail = 'async' + typeid + 'completedetail';\r\n                var strButton = 'async' + typeid + 'completebutton';\r\n                stringRequests = [\r\n                    {key: strDetail, component: 'backup', param: restoreurl},\r\n                    {key: strButton, component: 'backup'}\r\n                ];\r\n                Str.get_strings(stringRequests).then(function(strings) {\r\n                    elementdetail.html(strings[0]);\r\n                    elementbutton.text(strings[1]);\r\n                    elementbutton.attr('href', restoreurl);\r\n\r\n                    return;\r\n                })\r\n                .catch(function() {\r\n                    notification.exception(new Error('Failed to load string'));\r\n                    return;\r\n                });\r\n\r\n            }\r\n\r\n            $('.backup_progress').children('span').removeClass('backup_stage_current');\r\n            $('.backup_progress').children('span').last().addClass('backup_stage_current');\r\n\r\n            // Stop checking when we either have an error or a completion.\r\n            clearInterval(backupintervalid);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update the Moodle user interface with the progress of\r\n     * all the pending processes for backup and restore operations.\r\n     *\r\n     * @param {object} progress The progress and status of the process.\r\n     */\r\n    function updateProgressAll(progress) {\r\n        progress.forEach(function(element) {\r\n            var percentage = element.progress * 100;\r\n            var backupid = element.backupid;\r\n            var type = element.operation;\r\n            var elementbar = document.querySelectorAll(\"[data-\" + type + \"id=\" + CSS.escape(backupid) + \"]\")[0];\r\n\r\n            if (element.status == STATUS_EXECUTING) {\r\n                // Process is in element.\r\n\r\n                // Add in element class color to bar\r\n                elementbar.classList.add('bg-success');\r\n\r\n                updateElement(backupid, type, percentage);\r\n\r\n            } else if (element.status == STATUS_FINISHED_ERR) {\r\n                // Process completed with error.\r\n\r\n                // Add in fail class color to bar\r\n                elementbar.classList.add('bg-danger');\r\n                elementbar.classList.add('complete');\r\n\r\n                // Remove in element class color to bar\r\n                elementbar.classList.remove('bg-success');\r\n\r\n                updateElement(backupid, type, 100);\r\n\r\n            } else if (element.status == STATUS_FINISHED_OK) {\r\n                // Process completed successfully.\r\n\r\n                // Add in element class color to bar\r\n                elementbar.classList.add('bg-success');\r\n                elementbar.classList.add('complete');\r\n\r\n                updateElement(backupid, type, 100);\r\n\r\n                // We have a successful backup. Update the UI with download and file details.\r\n                if (type == 'backup') {\r\n                    updateBackupTableRow(backupid);\r\n                } else {\r\n                    updateRestoreTableRow(backupid);\r\n                }\r\n\r\n            }\r\n\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Update the Moodle user interface with the progress of\r\n     * all the pending processes for copy operations.\r\n     *\r\n     * @param {object} progress The progress and status of the process.\r\n     */\r\n    function updateProgressCopy(progress) {\r\n        progress.forEach(function(element) {\r\n            var percentage = element.progress * 100;\r\n            var backupid = element.backupid;\r\n            var type = element.operation;\r\n            var elementbar = document.querySelectorAll(\"[data-\" + type + \"id=\" + CSS.escape(backupid) + \"]\")[0];\r\n\r\n            if (type == 'restore') {\r\n                 let restorecell = elementbar.closest('tr').children[3];\r\n                 Str.get_string('restore').then(function(content) {\r\n                     restorecell.innerHTML = content;\r\n                     return;\r\n                 }).catch(function() {\r\n                     notification.exception(new Error('Failed to load string: restore'));\r\n                 });\r\n            }\r\n\r\n            if (element.status == STATUS_EXECUTING) {\r\n                // Process is in element.\r\n\r\n                // Add in element class color to bar\r\n                elementbar.classList.add('bg-success');\r\n\r\n                updateElement(backupid, type, percentage);\r\n\r\n            } else if (element.status == STATUS_FINISHED_ERR) {\r\n                // Process completed with error.\r\n\r\n                // Add in fail class color to bar\r\n                elementbar.classList.add('bg-danger');\r\n                elementbar.classList.add('complete');\r\n\r\n                // Remove in element class color to bar\r\n                elementbar.classList.remove('bg-success');\r\n\r\n                updateElement(backupid, type, 100);\r\n\r\n            } else if ((element.status == STATUS_FINISHED_OK) && (type == 'restore')) {\r\n                // Process completed successfully.\r\n\r\n                // Add in element class color to bar\r\n                elementbar.classList.add('bg-success');\r\n                elementbar.classList.add('complete');\r\n\r\n                updateElement(backupid, type, 100);\r\n\r\n                // We have a successful copy. Update the UI link to copied course.\r\n                updateCopyTableRow(backupid);\r\n            }\r\n\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get the progress of the backup process via ajax.\r\n     */\r\n    function getBackupProgress() {\r\n        ajax.call([{\r\n            // Get the backup progress via webservice.\r\n            methodname: 'core_backup_get_async_backup_progress',\r\n            args: {\r\n                'backupids': [backupid],\r\n                'contextid': contextid\r\n            },\r\n        }], true, true, false, timeout)[0].done(function(response) {\r\n            // We have the progress now update the UI.\r\n            updateProgress(response[0]);\r\n            checkdelay = checkdelayoriginal;\r\n            backupintervalid = updateInterval(backupintervalid, getBackupProgress, checkdelayoriginal);\r\n        }).fail(function() {\r\n            checkdelay = checkdelay * checkdelaymultipler;\r\n            backupintervalid = updateInterval(backupintervalid, getBackupProgress, checkdelay);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get the progress of all backup processes via ajax.\r\n     */\r\n    function getAllBackupProgress() {\r\n        var backupids = [];\r\n        var progressbars = $('.progress').find('.progress-bar').not('.complete');\r\n\r\n        progressbars.each(function() {\r\n            backupids.push((this.id).substring(0, 32));\r\n        });\r\n\r\n        if (backupids.length > 0) {\r\n            ajax.call([{\r\n                // Get the backup progress via webservice.\r\n                methodname: 'core_backup_get_async_backup_progress',\r\n                args: {\r\n                    'backupids': backupids,\r\n                    'contextid': contextid\r\n                },\r\n            }], true, true, false, timeout)[0].done(function(response) {\r\n                updateProgressAll(response);\r\n                checkdelay = checkdelayoriginal;\r\n                allbackupintervalid = updateInterval(allbackupintervalid, getAllBackupProgress, checkdelayoriginal);\r\n            }).fail(function() {\r\n                checkdelay = checkdelay * checkdelaymultipler;\r\n                allbackupintervalid = updateInterval(allbackupintervalid, getAllBackupProgress, checkdelay);\r\n            });\r\n        } else {\r\n            clearInterval(allbackupintervalid); // No more progress bars to update, stop checking.\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the progress of all copy processes via ajax.\r\n     */\r\n    function getAllCopyProgress() {\r\n        var copyids = [];\r\n        var progressbars = $('.progress').find('.progress-bar[data-operation][data-backupid][data-restoreid]').not('.complete');\r\n\r\n        progressbars.each(function() {\r\n            let progressvars = {\r\n                    'backupid': this.dataset.backupid,\r\n                    'restoreid': this.dataset.restoreid,\r\n                    'operation': this.dataset.operation,\r\n            };\r\n            copyids.push(progressvars);\r\n        });\r\n\r\n        if (copyids.length > 0) {\r\n            ajax.call([{\r\n                // Get the copy progress via webservice.\r\n                methodname: 'core_backup_get_copy_progress',\r\n                args: {\r\n                    'copies': copyids\r\n                },\r\n            }], true, true, false, timeout)[0].done(function(response) {\r\n                updateProgressCopy(response);\r\n                checkdelay = checkdelayoriginal;\r\n                allcopyintervalid = updateInterval(allcopyintervalid, getAllCopyProgress, checkdelayoriginal);\r\n            }).fail(function() {\r\n                checkdelay = checkdelay * checkdelaymultipler;\r\n                allcopyintervalid = updateInterval(allcopyintervalid, getAllCopyProgress, checkdelay);\r\n            });\r\n        } else {\r\n            clearInterval(allcopyintervalid); // No more progress bars to update, stop checking.\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get status updates for all backups.\r\n     *\r\n     * @public\r\n     * @param {number} context The context id.\r\n     */\r\n    Asyncbackup.asyncBackupAllStatus = function(context) {\r\n        contextid = context;\r\n        allbackupintervalid = setInterval(getAllBackupProgress, checkdelay);\r\n    };\r\n\r\n    /**\r\n     * Get status updates for all course copies.\r\n     *\r\n     * @public\r\n     */\r\n    Asyncbackup.asyncCopyAllStatus = function() {\r\n        allcopyintervalid = setInterval(getAllCopyProgress, checkdelay);\r\n    };\r\n\r\n    /**\r\n     * Get status updates for backup.\r\n     *\r\n     * @public\r\n     * @param {string} backup The backup record id.\r\n     * @param {number} context The context id.\r\n     * @param {string} restore The restore link.\r\n     * @param {string} type The operation type (backup or restore).\r\n     */\r\n    Asyncbackup.asyncBackupStatus = function(backup, context, restore, type) {\r\n        backupid = backup;\r\n        contextid = context;\r\n        restoreurl = restore;\r\n\r\n        if (type == 'backup') {\r\n            typeid = 'backup';\r\n        } else {\r\n            typeid = 'restore';\r\n        }\r\n\r\n        // Remove the links from the progress bar, no going back now.\r\n        $('.backup_progress').children('a').removeAttr('href');\r\n\r\n        //  Periodically check for progress updates and update the UI as required.\r\n        backupintervalid = setInterval(getBackupProgress, checkdelay);\r\n\r\n      };\r\n\r\n      return Asyncbackup;\r\n});\r\n"],"names":["define","$","ajax","Str","notification","Templates","backupid","contextid","restoreurl","typeid","backupintervalid","allbackupintervalid","allcopyintervalid","Asyncbackup","checkdelay","updateElement","type","percentage","percentagewidth","Math","round","elementbar","document","querySelectorAll","CSS","escape","percentagetext","toFixed","setAttribute","style","width","innerHTML","updateInterval","intervalid","callback","value","clearInterval","setInterval","updateProgressAll","progress","forEach","element","operation","status","classList","add","remove","statuscell","parent","tablerow","cellsiblings","siblings","timecell","timevalue","text","filenamecell","filename","call","methodname","args","done","response","context","time","size","filesize","fileurl","render","then","html","js","replaceNodeContents","fail","exception","Error","updateBackupTableRow","coursecell","resourcename","updateRestoreTableRow","updateProgressCopy","restorecell","closest","children","get_string","content","catch","restorecourse","coursename","courselink","createElement","elementbarparent","previousElementSibling","appendChild","updateCopyTableRow","getBackupProgress","backupids","stringRequests","elementstatus","elementdetail","elementbutton","strProcessing","title","key","component","get_strings","strings","removeClass","last","addClass","strComplete","strButton","param","attr","updateProgress","getAllBackupProgress","find","not","each","push","this","id","substring","length","getAllCopyProgress","copyids","progressvars","dataset","restoreid","copies","asyncBackupAllStatus","asyncCopyAllStatus","asyncBackupStatus","backup","restore","removeAttr"],"mappings":"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"}