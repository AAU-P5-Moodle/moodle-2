define("mod_homework/homeworkchooseredit",["exports","jquery","core/ajax","mod_homework/modal_homework","core/modal_events","core/dropzone"],(function(_exports,_jquery,_ajax,_modal_homework,_modal_events,_dropzone){function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_modal_homework=_interopRequireDefault(_modal_homework),_modal_events=_interopRequireDefault(_modal_events),_dropzone=_interopRequireDefault(_dropzone);let dropZoneFiles=[],uploadedFileIds=[];_exports.init=async(cmid,title,currentHomework,homeworkids)=>{Object.values(homeworkids).forEach((homeworkid=>{(0,_jquery.default)("#edit-homework-chooser-"+homeworkid.id).on("click",(()=>{_ajax.default.call([{methodname:"mod_homework_get_homework_chooser",args:{cmid:cmid},done:async function(response){const modal=await _modal_homework.default.create({title:title,body:`${response.html}`,large:!0,removeOnClose:!0});modal.show(),modal.getRoot().on(_modal_events.default.shown,(()=>{const dropzoneContainer=modal.getRoot().find("#dropzone-container")[0];modal.getRoot().find("#inputField")[0].value=homeworkid.description,modal.getRoot().find("#link")[0].value=homeworkid.link,modal.getRoot().find("#startPage")[0].value=homeworkid.startpage,modal.getRoot().find("#endPage")[0].value=homeworkid.endpage,modal.getRoot().find("#startTime")[0].value=homeworkid.starttime,modal.getRoot().find("#endTime")[0].value=homeworkid.endtime,homeworkid.file_id&&uploadedFileIds.push(homeworkid.file_id),initializeDropzone(dropzoneContainer),displayUploadedFile(homeworkid)})),modal.getRoot().on(_modal_events.default.hidden,(()=>{console.log("Modal closed!")})),modal.getRoot().on("click",'[data-action="submit"]',(e=>{e.preventDefault(),handleFormSubmit(modal,currentHomework,homeworkid.id)})),modal.getRoot().on("click",'[data-action="cancel"]',(e=>{e.preventDefault(),modal.destroy(),location.reload()}))},fail:error=>{console.error("Failed to load homework chooser content:",error)}}])}))}))};const initializeDropzone=container=>{const dropZone=new _dropzone.default(container,"*/*",(files=>{dropZoneFiles.push(files[0]),displayUploadedFile(files[0])}));dropZone.setLabel("Drop file here (Optional)"),dropZone.init()},displayUploadedFile=file=>{const previewContainer=document.getElementById("file-content");if(previewContainer.innerHTML="",file.name||file.filename){const fileWrapper=document.createElement("div");fileWrapper.style.position="relative",fileWrapper.style.display="ruby";const paragraph=document.createElement("p");file.name?paragraph.textContent=`${file.name}`:file.filename&&(paragraph.textContent=`${file.filename}`),fileWrapper.appendChild(paragraph);const deleteButton=document.createElement("span");deleteButton.textContent="X",deleteButton.style.cursor="pointer",deleteButton.style.background="red",deleteButton.style.color="white",deleteButton.style.padding="2px 5px",deleteButton.style.fontWeight="bold",deleteButton.style.marginLeft="5px",deleteButton.addEventListener("click",(()=>{confirm("Are you sure you want to delete this file?")&&_ajax.default.call([{methodname:"mod_homework_delete_file",args:{id:file.id,file_id:file.file_id},done:function(response){console.log("File deleted successfully"),dropZoneFiles=[],previewContainer.innerHTML="",uploadedFileIds=[]},fail:function(error){console.error("Failed to delete file:",error)}}])})),fileWrapper.appendChild(deleteButton),previewContainer.appendChild(fileWrapper)}},handleFormSubmit=async(modal,currentHomework,homeworkid)=>{let inputField=modal.getRoot().find("#inputField")[0],linkField=modal.getRoot().find("#link")[0],startPageInput=modal.getRoot().find("#startPage")[0],endPageInput=modal.getRoot().find("#endPage")[0],startTimeInput=modal.getRoot().find("#startTime")[0],endTimeInput=modal.getRoot().find("#endTime")[0];""===inputField.value.trim()?inputField.setCustomValidity("Input field must not be empty"):inputField.setCustomValidity(""),inputField.reportValidity(),inputField.checkValidity()&&function(startPageInput,endPageInput){const startPage=parseInt(startPageInput.value,10),endPage=parseInt(endPageInput.value,10);if(""!==endPageInput.value&&""!==startPageInput.value){if(endPage<startPage)return endPageInput.setCustomValidity("End Page must be greater than or equal to Start Page"),endPageInput.reportValidity(),!1;endPageInput.setCustomValidity("")}else endPageInput.setCustomValidity("");return endPageInput.reportValidity(),endPageInput.checkValidity()}(startPageInput,endPageInput)&&function(startTimeInput,endTimeInput){const startTime=parseInt(startTimeInput.value,10),endTime=parseInt(endTimeInput.value,10);if(""!==endTimeInput.value&&""!==startTimeInput.value){if(endTime<startTime)return endTimeInput.setCustomValidity("End Time must be greater than or equal to Start Time"),endTimeInput.reportValidity(),!1;endTimeInput.setCustomValidity("")}else endTimeInput.setCustomValidity("");return endTimeInput.reportValidity(),endTimeInput.checkValidity()}(startTimeInput,endTimeInput)&&(await(async()=>{for(let file of dropZoneFiles)try{const formData=new FormData;formData.append("file",file);const response=await fetch("/mod/homework/upload_file.php",{method:"POST",body:formData}),result=await response.json();response.ok&&"success"===result.status?(console.log("File uploaded successfully:",file.name),console.log(result),uploadedFileIds.push(result.fileid)):console.error("Failed to upload file:",file.name)}catch(error){console.error("Error uploading file:",file.name,error)}dropZoneFiles=[]})(),_ajax.default.call([{methodname:"mod_homework_edit_homework_material",args:{id:homeworkid,inputfield:inputField.value,link:""!==linkField.value.trim()?linkField.value.trim():null,startpage:""!==startPageInput.value.trim()?startPageInput.value.trim():null,endpage:""!==endPageInput.value.trim()?endPageInput.value.trim():null,starttime:""!==startTimeInput.value.trim()?startTimeInput.value.trim():null,endtime:""!==endTimeInput.value.trim()?endTimeInput.value.trim():null,homeworkid:currentHomework,fileid:uploadedFileIds.length?uploadedFileIds[0]:null},done:function(response){console.log("Data saved successfully:",response),modal.destroy(),location.reload()},fail:function(error){console.error("Failed to save data:",error)}}]))}}));

//# sourceMappingURL=homeworkchooseredit.min.js.map