define("mod_homework/homeworkchooser",["exports","jquery","core/ajax","mod_homework/modal_homework","core/modal_events","core/dropzone"],(function(_exports,_jquery,_ajax,_modal_homework,_modal_events,_dropzone){function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_modal_homework=_interopRequireDefault(_modal_homework),_modal_events=_interopRequireDefault(_modal_events),_dropzone=_interopRequireDefault(_dropzone);let dropZoneFiles=[],uploadedFileIds=[];_exports.init=async(cmid,title,currentHomework)=>{(0,_jquery.default)("#open-homework-chooser").on("click",(()=>{_ajax.default.call([{methodname:"mod_homework_get_homework_chooser",args:{cmid:cmid},done:async function(response){const modal=await _modal_homework.default.create({title:title,body:`${response.html}`,large:!0,removeOnClose:!0});modal.show(),modal.getRoot().on(_modal_events.default.shown,(()=>{const radioButtons=modal.getRoot().find('input[name="option"]'),pageRangeInput=modal.getRoot().find("#page-range-input")[0],videoTimeInput=modal.getRoot().find("#video-time-input")[0],linkDiv=modal.getRoot().find("#linkDiv")[0],dropzonePdfContainer=modal.getRoot().find("#dropzone-pdf-container")[0],dropzoneVideoContainer=modal.getRoot().find("#dropzone-video-container")[0];function toggleInputs(){document.getElementById("option1").checked?(pageRangeInput.style.display="block",videoTimeInput.style.display="none",linkDiv.style.display="none",dropzonePdfContainer.style.display="block",dropzoneVideoContainer.style.display="none",dropZoneFiles=[],uploadedFileIds=[]):document.getElementById("option2").checked?(pageRangeInput.style.display="none",videoTimeInput.style.display="none",linkDiv.style.display="block",dropzonePdfContainer.style.display="none",dropzoneVideoContainer.style.display="none",dropZoneFiles=[],uploadedFileIds=[]):document.getElementById("option3").checked&&(pageRangeInput.style.display="none",videoTimeInput.style.display="block",linkDiv.style.display="none",dropzonePdfContainer.style.display="none",dropzoneVideoContainer.style.display="block",dropZoneFiles=[],uploadedFileIds=[])}radioButtons.each(((_,radio)=>{radio.addEventListener("change",toggleInputs)})),initializePDFDropzone(dropzonePdfContainer),initializeVideoDropzone(dropzoneVideoContainer)})),modal.getRoot().on(_modal_events.default.hidden,(()=>{console.log("Modal closed!")})),modal.getRoot().on("click",'[data-action="submit"]',(e=>{e.preventDefault(),handleFormSubmit(modal,currentHomework)})),modal.getRoot().on("click",'[data-action="cancel"]',(e=>{e.preventDefault(),modal.destroy()}))},fail:error=>{console.error("Failed to load homework chooser content:",error)}}])}))};const initializePDFDropzone=container=>{const dropZone=new _dropzone.default(container,"application/pdf",(files=>{for(let file of files)"application/pdf"===file.type?dropZoneFiles.push(file):console.warn("Invalid file type:",file.type)}));dropZone.setLabel("Drop PDF files here (Optional)"),dropZone.init()},initializeVideoDropzone=container=>{const dropZone=new _dropzone.default(container,"video/*",(files=>{for(let file of files)file.type.startsWith("video/")?dropZoneFiles.push(file):console.warn("Invalid file type:",file.type)}));dropZone.setLabel("Drop video files here (Optional)"),dropZone.init()},uploadDropzoneFiles=async()=>{for(let file of dropZoneFiles)try{const formData=new FormData;formData.append("file",file);const response=await fetch("/mod/homework/upload_file.php",{method:"POST",body:formData}),result=await response.json();response.ok&&"success"===result.status?(console.log("File uploaded successfully:",file.name),console.log(result),uploadedFileIds.push(result.fileid)):console.error("Failed to upload file:",file.name)}catch(error){console.error("Error uploading file:",file.name,error)}dropZoneFiles=[]},handleFormSubmit=async(modal,currentHomework)=>{let inputField=modal.getRoot().find("#inputField")[0];if(""===inputField.value.trim()?inputField.setCustomValidity("Input field must not be empty"):inputField.setCustomValidity(""),inputField.reportValidity(),inputField.checkValidity())if(modal.getRoot().find("#option1").is(":checked")){let startPageInput=modal.getRoot().find("#startPage")[0],endPageInput=modal.getRoot().find("#endPage")[0];if(!function(startPageInput,endPageInput){const startPage=parseInt(startPageInput.value,10),endPage=parseInt(endPageInput.value,10);if(""!==endPageInput.value&&""!==startPageInput.value){if(endPage<startPage)return endPageInput.setCustomValidity("End Page must be greater than or equal to Start Page"),endPageInput.reportValidity(),!1;endPageInput.setCustomValidity("")}else endPageInput.setCustomValidity("");return endPageInput.reportValidity(),endPageInput.checkValidity()}(startPageInput,endPageInput))return;let startPage=startPageInput.value,endPage=endPageInput.value;await uploadDropzoneFiles(),_ajax.default.call([{methodname:"mod_homework_save_homework_literature",args:{inputfield:inputField.value,startpage:startPage,endpage:endPage,homeworkid:currentHomework,fileid:uploadedFileIds.length?uploadedFileIds[0]:null},done:function(response){console.log("Data saved successfully:",response),dropZoneFiles=[],uploadedFileIds=[],modal.destroy()},fail:function(error){console.error("Failed to save data:",error)}}])}else if(modal.getRoot().find("#option2").is(":checked")){let link=modal.getRoot().find("#link").val();_ajax.default.call([{methodname:"mod_homework_save_homework_link",args:{inputfield:inputField.value,link:link,homeworkid:currentHomework},done:function(response){console.log("Data saved successfully:",response),modal.destroy()},fail:function(error){console.error("Failed to save data:",error)}}])}else if(modal.getRoot().find("#option3").is(":checked")){let startTimeInput=modal.getRoot().find("#startTime")[0],endTimeInput=modal.getRoot().find("#endTime")[0];if(!function(startTimeInput,endTimeInput){const startTime=parseInt(startTimeInput.value,10),endTime=parseInt(endTimeInput.value,10);if(""!==endTimeInput.value&&""!==startTimeInput.value){if(endTime<startTime)return endTimeInput.setCustomValidity("End Time must be greater than or equal to Start Time"),endTimeInput.reportValidity(),!1;endTimeInput.setCustomValidity("")}else endTimeInput.setCustomValidity("");return endTimeInput.reportValidity(),endTimeInput.checkValidity()}(startTimeInput,endTimeInput))return;let startTime=startTimeInput.value,endTime=endTimeInput.value;await uploadDropzoneFiles(),_ajax.default.call([{methodname:"mod_homework_save_homework_video",args:{inputfield:inputField.value,starttime:startTime,endtime:endTime,homeworkid:currentHomework,fileid:uploadedFileIds.length?uploadedFileIds[0]:null},done:function(response){console.log("Data saved successfully:",response),modal.destroy()},fail:function(error){console.error("Failed to save data:",error)}}])}}}));

//# sourceMappingURL=homeworkchooser.min.js.map