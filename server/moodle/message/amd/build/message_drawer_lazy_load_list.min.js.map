{"version":3,"file":"message_drawer_lazy_load_list.min.js","sources":["../src/message_drawer_lazy_load_list.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Lazy loaded list of items.\r\n *\r\n * @module     core_message/message_drawer_lazy_load_list\r\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(\r\n[\r\n    'jquery',\r\n    'core/custom_interaction_events',\r\n    'core/pending',\r\n],\r\nfunction(\r\n    $,\r\n    CustomEvents,\r\n    PendingPromise,\r\n) {\r\n\r\n    var SELECTORS = {\r\n        ROOT: '[data-region=\"lazy-load-list\"]',\r\n        LOADING_ICON_CONTAINER: '[data-region=\"loading-icon-container\"]',\r\n        CONTENT_CONTAINER: '[data-region=\"content-container\"]',\r\n        EMPTY_MESSAGE: '[data-region=\"empty-message-container\"]',\r\n        PLACEHOLDER: '[data-region=\"placeholder-container\"]'\r\n    };\r\n\r\n    /**\r\n     * Flag element as loading.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var startLoading = function(root) {\r\n        root.attr('data-loading', true);\r\n    };\r\n\r\n    /**\r\n     * Flag element as not loading.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var stopLoading = function(root) {\r\n        root.attr('data-loading', false);\r\n    };\r\n\r\n    /**\r\n     * Check if the element is loading.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     * @return {Bool}\r\n     */\r\n    var isLoading = function(root) {\r\n        return root.attr('data-loading') === 'true';\r\n    };\r\n\r\n    /**\r\n     * Get user id\r\n     *\r\n     * @param  {Object} root The section container element.\r\n     * @return {Number} Logged in user id.\r\n     */\r\n    var getUserId = function(root) {\r\n        return root.attr('data-user-id');\r\n    };\r\n\r\n    /**\r\n     * Get the section content container element.\r\n     *\r\n     * @param  {Object} root The section container element.\r\n     * @return {Object} The section content container element.\r\n     */\r\n    var getContentContainer = function(root) {\r\n        return root.find(SELECTORS.CONTENT_CONTAINER);\r\n    };\r\n\r\n    /**\r\n     * Get the root element.\r\n     *\r\n     * @param  {Object} containerElement The container element to search in.\r\n     * @return {Object} The list root element.\r\n     */\r\n    var getRoot = function(containerElement) {\r\n        return containerElement.find(SELECTORS.ROOT);\r\n    };\r\n\r\n    /**\r\n     * Show the loading icon.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var showLoadingIcon = function(root) {\r\n        root.find(SELECTORS.LOADING_ICON_CONTAINER).removeClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Hide the loading icon.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var hideLoadingIcon = function(root) {\r\n        root.find(SELECTORS.LOADING_ICON_CONTAINER).addClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Show the empty message.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var showEmptyMessage = function(root) {\r\n        root.find(SELECTORS.EMPTY_MESSAGE).removeClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Hide the empty message.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var hideEmptyMessage = function(root) {\r\n        root.find(SELECTORS.EMPTY_MESSAGE).addClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Show the placeholder element.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var showPlaceholder = function(root) {\r\n        root.find(SELECTORS.PLACEHOLDER).removeClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Hide the placeholder element.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var hidePlaceholder = function(root) {\r\n        root.find(SELECTORS.PLACEHOLDER).addClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Show the section content container.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var showContent = function(root) {\r\n        getContentContainer(root).removeClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Hide the section content container.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     */\r\n    var hideContent = function(root) {\r\n        getContentContainer(root).addClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * If the section has loaded all content.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     * @return {Bool}\r\n     */\r\n    var hasLoadedAll = function(root) {\r\n        return root.attr('data-loaded-all') == 'true';\r\n    };\r\n\r\n    /**\r\n     * If the section has loaded all content.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     * @param {Bool} value If all items have been loaded.\r\n     */\r\n    var setLoadedAll = function(root, value) {\r\n        root.attr('data-loaded-all', value);\r\n    };\r\n\r\n    /**\r\n     * If the section can load more items.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     * @return {Bool}\r\n     */\r\n    var canLoadMore = function(root) {\r\n        return !hasLoadedAll(root) && !isLoading(root);\r\n    };\r\n\r\n    /**\r\n     * Load all items in this container from callback and render them.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     * @param {Function} loadCallback The callback to load items.\r\n     * @param {Function} renderCallback The callback to render the results.\r\n     * @return {Object} jQuery promise\r\n     */\r\n    var loadAndRender = function(root, loadCallback, renderCallback) {\r\n        var userId = getUserId(root);\r\n        startLoading(root);\r\n\r\n        return loadCallback(root, userId)\r\n            .then(function(items) {\r\n                if (items.length > 0) {\r\n                    var contentContainer = getContentContainer(root);\r\n                    return renderCallback(contentContainer, items, userId)\r\n                        .then(function() {\r\n                            return items;\r\n                        });\r\n                } else {\r\n                    return items;\r\n                }\r\n            })\r\n            .then(function(items) {\r\n                stopLoading(root);\r\n                root.attr('data-seen', true);\r\n\r\n                if (!items.length) {\r\n                    setLoadedAll(root, true);\r\n                }\r\n\r\n                return items;\r\n            })\r\n            .catch(function() {\r\n                stopLoading(root);\r\n                root.attr('data-seen', true);\r\n                return;\r\n            });\r\n    };\r\n\r\n    /**\r\n     * First load of this section.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     * @param {Function} loadCallback The callback to load items.\r\n     * @param {Function} renderCallback The callback to render the results.\r\n     * @return {Object} promise\r\n     */\r\n    var initialLoadAndRender = function(root, loadCallback, renderCallback) {\r\n        const pendingPromise = new PendingPromise('initialLoadAndRender');\r\n        getContentContainer(root).empty();\r\n        showPlaceholder(root);\r\n        hideContent(root);\r\n        return loadAndRender(root, loadCallback, renderCallback)\r\n            .then(function(items) {\r\n                hidePlaceholder(root);\r\n\r\n                if (!items.length) {\r\n                    showEmptyMessage(root);\r\n                } else {\r\n                    showContent(root);\r\n                }\r\n\r\n                return;\r\n            })\r\n            .catch(function() {\r\n                hidePlaceholder(root);\r\n                showContent(root);\r\n                return;\r\n            })\r\n            .then(() => {\r\n                pendingPromise.resolve();\r\n                return;\r\n            });\r\n    };\r\n\r\n    /**\r\n     * Listen to, and handle events in this section.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     * @param {Function} loadCallback The callback to load items.\r\n     * @param {Function} renderCallback The callback to render the results.\r\n     */\r\n    var registerEventListeners = function(root, loadCallback, renderCallback) {\r\n        CustomEvents.define(root, [\r\n            CustomEvents.events.scrollBottom\r\n        ]);\r\n\r\n        root.on(CustomEvents.events.scrollBottom, function() {\r\n            if (canLoadMore(root)) {\r\n                showLoadingIcon(root);\r\n                loadAndRender(root, loadCallback, renderCallback)\r\n                    .then(function() {\r\n                        return hideLoadingIcon(root);\r\n                    })\r\n                    .catch(function() {\r\n                        return hideLoadingIcon(root);\r\n                    });\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Setup the section.\r\n     *\r\n     * @param {Object} root The section container element.\r\n     * @param {Function} loadCallback The callback to load items.\r\n     * @param {Function} renderCallback The callback to render the results.\r\n     */\r\n    var show = function(root, loadCallback, renderCallback) {\r\n        root = $(root);\r\n\r\n        if (!root.attr('data-init')) {\r\n            registerEventListeners(root, loadCallback, renderCallback);\r\n            initialLoadAndRender(root, loadCallback, renderCallback);\r\n            root.attr('data-init', true);\r\n        }\r\n    };\r\n\r\n    return {\r\n        show: show,\r\n        getContentContainer: getContentContainer,\r\n        getRoot: getRoot,\r\n        setLoadedAll: setLoadedAll,\r\n        showEmptyMessage: showEmptyMessage,\r\n        hideEmptyMessage: hideEmptyMessage,\r\n        showContent: showContent,\r\n        hideContent: hideContent\r\n    };\r\n});\r\n"],"names":["define","$","CustomEvents","PendingPromise","SELECTORS","stopLoading","root","attr","getContentContainer","find","hideLoadingIcon","addClass","showEmptyMessage","removeClass","hidePlaceholder","showContent","hideContent","setLoadedAll","value","loadAndRender","loadCallback","renderCallback","userId","getUserId","startLoading","then","items","length","contentContainer","catch","initialLoadAndRender","pendingPromise","empty","showPlaceholder","resolve","registerEventListeners","events","scrollBottom","on","hasLoadedAll","isLoading","canLoadMore","showLoadingIcon","show","getRoot","containerElement","hideEmptyMessage"],"mappings":"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"}