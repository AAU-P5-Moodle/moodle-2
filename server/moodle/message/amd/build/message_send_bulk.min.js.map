{"version":3,"file":"message_send_bulk.min.js","sources":["../src/message_send_bulk.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Send bulk message to the given user ids.\r\n *\r\n * @module     core_message/message_send_bulk\r\n * @copyright  2019 Shamim Rezaie <shamim@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\nimport {get_string} from 'core/str';\r\nimport ModalSaveCancel from 'core/modal_save_cancel';\r\nimport Templates from 'core/templates';\r\nimport ModalEvents from 'core/modal_events';\r\nimport Ajax from 'core/ajax';\r\nimport Notification from 'core/notification';\r\n\r\n/**\r\n * Show the send message popup.\r\n *\r\n * @method showModal\r\n * @param {int[]} users\r\n * @param {Function} callback A callback to apply after the form is closed.\r\n * @returns {Promise}\r\n */\r\nexport const showModal = (users, callback = null) => {\r\n    if (!users.length) {\r\n        // Nothing to do.\r\n        return Promise.resolve();\r\n    }\r\n    let titlePromise = null;\r\n    if (users.length == 1) {\r\n        titlePromise = get_string('sendbulkmessagesingle', 'core_message');\r\n    } else {\r\n        titlePromise = get_string('sendbulkmessage', 'core_message', users.length);\r\n    }\r\n\r\n    return ModalSaveCancel.create({\r\n        body: Templates.render('core_message/send_bulk_message', {}),\r\n        title: titlePromise,\r\n        show: true,\r\n        buttons: {\r\n            save: titlePromise,\r\n        },\r\n    })\r\n    .then(function(modal) {\r\n        // When the dialog is closed, perform the callback (if provided).\r\n        modal.getRoot().on(ModalEvents.hidden, function() {\r\n            if (callback) {\r\n                callback();\r\n            }\r\n            modal.getRoot().remove();\r\n        });\r\n\r\n        modal.getRoot().on(ModalEvents.save, function() {\r\n            let messageText = modal.getRoot().find('form textarea').val();\r\n            sendMessage(messageText, users);\r\n        });\r\n\r\n        return modal;\r\n    });\r\n};\r\n\r\n/**\r\n * Send a message to these users.\r\n *\r\n * @method sendMessage\r\n * @param {String} messageText\r\n * @param {Number[]} users\r\n * @returns {Promise}\r\n */\r\nexport const sendMessage = (messageText, users) => {\r\n    let messages = [];\r\n\r\n    users.forEach(user => {\r\n        messages.push({\r\n            touserid: user,\r\n            text: messageText\r\n        });\r\n    });\r\n\r\n    return Ajax.call([{\r\n        methodname: 'core_message_send_instant_messages',\r\n        args: {messages: messages}\r\n    }])[0]\r\n    .then(function(messageIds) {\r\n        if (messageIds.length == 1) {\r\n            return get_string('sendbulkmessagesentsingle', 'core_message');\r\n        } else {\r\n            return get_string('sendbulkmessagesent', 'core_message', messageIds.length);\r\n        }\r\n    })\r\n    .then(function(msg) {\r\n        Notification.addNotification({\r\n            message: msg,\r\n            type: \"success\"\r\n        });\r\n        return true;\r\n    })\r\n    .catch(Notification.exception);\r\n};\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_modal_save_cancel","_templates","_modal_events","_ajax","_notification","_exports","showModal","users","callback","arguments","length","undefined","Promise","resolve","titlePromise","get_string","ModalSaveCancel","create","body","Templates","render","title","show","buttons","save","then","modal","getRoot","on","ModalEvents","hidden","remove","messageText","find","val","sendMessage","messages","forEach","user","push","touserid","text","Ajax","call","methodname","args","messageIds","msg","Notification","addNotification","message","type","catch","exception"],"mappings":"sPA2B6C,SAAAA,uBAAAC,GAAAA,OAAAA,GAAAA,EAAAC,WAAAD,EAAAE,CAAAA,QAAAF,EAAA;;;;;;;4GAJ7CG,mBAAAJ,uBAAAI,oBACAC,WAAAL,uBAAAK,YACAC,cAAAN,uBAAAM,eACAC,MAAAP,uBAAAO,OACAC,cAAAR,uBAAAQ,eA8CEC,SAAAC,UApCuB,SAACC,OAA2B,IAApBC,SAAQC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,KACxC,IAAKF,MAAMG,OAEP,OAAOE,QAAQC,UAEnB,IAAIC,aAAe,KAOnB,OALIA,aADgB,GAAhBP,MAAMG,QACS,EAAAK,KAAAA,YAAW,wBAAyB,iBAEpC,EAAAA,KAAAA,YAAW,kBAAmB,eAAgBR,MAAMG,QAGhEM,mBAAAA,QAAgBC,OAAO,CAC1BC,KAAMC,mBAAUC,OAAO,iCAAkC,CAAA,GACzDC,MAAOP,aACPQ,MAAM,EACNC,QAAS,CACLC,KAAMV,gBAGbW,MAAK,SAASC,OAcX,OAZAA,MAAMC,UAAUC,GAAGC,cAAW9B,QAAC+B,QAAQ,WAC/BtB,UACAA,WAEJkB,MAAMC,UAAUI,QACpB,IAEAL,MAAMC,UAAUC,GAAGC,cAAW9B,QAACyB,MAAM,WACjC,IAAIQ,YAAcN,MAAMC,UAAUM,KAAK,iBAAiBC,MACxDC,YAAYH,YAAazB,MAC7B,IAEOmB,KACX,KAWG,MAAMS,YAAcA,CAACH,YAAazB,SACrC,IAAI6B,SAAW,GASf,OAPA7B,MAAM8B,SAAQC,OACVF,SAASG,KAAK,CACVC,SAAUF,KACVG,KAAMT,aACR,IAGCU,MAAI3C,QAAC4C,KAAK,CAAC,CACdC,WAAY,qCACZC,KAAM,CAACT,SAAUA,aACjB,GACHX,MAAK,SAASqB,YACX,OAAyB,GAArBA,WAAWpC,QACJ,EAAAK,KAAUA,YAAC,4BAA6B,iBAExC,EAAAA,KAAUA,YAAC,sBAAuB,eAAgB+B,WAAWpC,OAE5E,IACCe,MAAK,SAASsB,KAKX,OAJAC,cAAYjD,QAACkD,gBAAgB,CACzBC,QAASH,IACTI,KAAM,aAEH,CACV,IACAC,MAAMJ,cAAYjD,QAACsD,UAAU,EAChChD,SAAA8B,YAAAA,WAAA"}