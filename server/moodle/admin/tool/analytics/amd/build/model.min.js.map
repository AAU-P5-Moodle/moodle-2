{"version":3,"file":"model.min.js","sources":["../src/model.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * AMD module for model actions confirmation.\r\n *\r\n * @module     tool_analytics/model\r\n * @copyright  2017 David Monllao\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine([\r\n    'jquery', 'core/str', 'core/log', 'core/notification', 'core/modal_save_cancel',\r\n    'core/modal_cancel', 'core/modal_events', 'core/templates'],\r\n    function($, Str, log, Notification, ModalSaveCancel, ModalCancel, ModalEvents, Templates) {\r\n\r\n    /**\r\n     * List of actions that require confirmation and confirmation message.\r\n     */\r\n    var actionsList = {\r\n        clear: {\r\n            title: {\r\n                key: 'clearpredictions',\r\n                component: 'tool_analytics'\r\n            }, body: {\r\n                key: 'clearmodelpredictions',\r\n                component: 'tool_analytics'\r\n            }\r\n\r\n        },\r\n        'delete': {\r\n            title: {\r\n                key: 'delete',\r\n                component: 'tool_analytics'\r\n            }, body: {\r\n                key: 'deletemodelconfirmation',\r\n                component: 'tool_analytics'\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Returns the model name.\r\n     *\r\n     * @param {Object} actionItem The action item DOM node.\r\n     * @return {String}\r\n     */\r\n    var getModelName = function(actionItem) {\r\n        var wrap = $(actionItem).closest('[data-model-name]');\r\n\r\n        if (wrap.length) {\r\n            return wrap.attr('data-model-name');\r\n\r\n        } else {\r\n            log.error('Unexpected DOM error - unable to obtain the model name');\r\n            return '';\r\n        }\r\n    };\r\n\r\n    /** @alias module:tool_analytics/model */\r\n    return {\r\n\r\n        /**\r\n         * Displays a confirm modal window before executing the action.\r\n         *\r\n         * @param {String} actionId\r\n         * @param {String} actionType\r\n         */\r\n        confirmAction: function(actionId, actionType) {\r\n            $('[data-action-id=\"' + actionId + '\"]').on('click', function(ev) {\r\n                ev.preventDefault();\r\n\r\n                var a = $(ev.currentTarget);\r\n\r\n                if (typeof actionsList[actionType] === \"undefined\") {\r\n                    log.error('Action \"' + actionType + '\" is not allowed.');\r\n                    return;\r\n                }\r\n\r\n                var reqStrings = [\r\n                    actionsList[actionType].title,\r\n                    actionsList[actionType].body\r\n                ];\r\n                reqStrings[1].param = getModelName(a);\r\n\r\n                var stringsPromise = Str.get_strings(reqStrings);\r\n                var modalPromise = ModalSaveCancel.create({});\r\n\r\n                $.when(stringsPromise, modalPromise).then(function(strings, modal) {\r\n                    modal.setTitle(strings[0]);\r\n                    modal.setBody(strings[1]);\r\n                    modal.setSaveButtonText(strings[0]);\r\n                    modal.getRoot().on(ModalEvents.save, function() {\r\n                        window.location.href = a.attr('href');\r\n                    });\r\n                    modal.show();\r\n                    return modal;\r\n                }).fail(Notification.exception);\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Displays evaluation mode and time-splitting method choices.\r\n         *\r\n         * @param  {String}  actionId\r\n         * @param  {Boolean} trainedOnlyExternally\r\n         */\r\n        selectEvaluationOptions: function(actionId, trainedOnlyExternally) {\r\n            $('[data-action-id=\"' + actionId + '\"]').on('click', function(ev) {\r\n                ev.preventDefault();\r\n\r\n                var a = $(ev.currentTarget);\r\n\r\n                var timeSplittingMethods = $(this).attr('data-timesplitting-methods');\r\n\r\n                ModalSaveCancel.create({\r\n                    title: Str.get_string('evaluatemodel', 'tool_analytics'),\r\n                    body: Templates.render('tool_analytics/evaluation_options', {\r\n                        trainedexternally: trainedOnlyExternally,\r\n                        timesplittingmethods: JSON.parse(timeSplittingMethods)\r\n                    }),\r\n                    removeOnClose: true,\r\n                    buttons: {\r\n                        save: Str.get_string('evaluate', 'tool_analytics'),\r\n                    },\r\n                    show: true,\r\n                })\r\n                .then((modal) => {\r\n                    modal.getRoot().on(ModalEvents.save, function() {\r\n                        // Evaluation mode.\r\n                        var evaluationMode = $(\"input[name='evaluationmode']:checked\").val();\r\n                        if (evaluationMode == 'trainedmodel') {\r\n                            a.attr('href', a.attr('href') + '&mode=trainedmodel');\r\n                        }\r\n\r\n                        // Selected time-splitting id.\r\n                        var timeSplittingMethod = $(\"#id-evaluation-timesplitting\").val();\r\n                        a.attr('href', a.attr('href') + '&timesplitting=' + timeSplittingMethod);\r\n\r\n                        window.location.href = a.attr('href');\r\n                        return;\r\n                    });\r\n\r\n                    return modal;\r\n                }).catch(Notification.exception);\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Displays export options.\r\n         *\r\n         * We have two main options: export training data and export configuration.\r\n         * The 2nd option has an extra option: include the trained algorithm weights.\r\n         *\r\n         * @param  {String}  actionId\r\n         * @param  {Boolean} isTrained\r\n         */\r\n        selectExportOptions: function(actionId, isTrained) {\r\n            $('[data-action-id=\"' + actionId + '\"]').on('click', function(ev) {\r\n                ev.preventDefault();\r\n\r\n                var a = $(ev.currentTarget);\r\n\r\n                if (!isTrained) {\r\n                    // Export the model configuration if the model is not trained. We can't export anything else.\r\n                    a.attr('href', a.attr('href') + '&action=exportmodel&includeweights=0');\r\n                    window.location.href = a.attr('href');\r\n                    return;\r\n                }\r\n\r\n                var stringsPromise = Str.get_strings([\r\n                    {\r\n                        key: 'export',\r\n                        component: 'tool_analytics'\r\n                    }\r\n                ]);\r\n                var modalPromise = ModalSaveCancel.create({\r\n                    body: Templates.render('tool_analytics/export_options', {}),\r\n                    removeOnClose: true,\r\n                });\r\n\r\n                $.when(stringsPromise, modalPromise).then(function(strings, modal) {\r\n                    modal.setTitle(strings[0]);\r\n                    modal.setSaveButtonText(strings[0]);\r\n\r\n                    modal.getRoot().on(ModalEvents.save, function() {\r\n\r\n                        var exportOption = $(\"input[name='exportoption']:checked\").val();\r\n\r\n                        if (exportOption == 'exportdata') {\r\n                            a.attr('href', a.attr('href') + '&action=exportdata');\r\n\r\n                        } else {\r\n                            a.attr('href', a.attr('href') + '&action=exportmodel');\r\n                            if ($(\"#id-includeweights\").is(':checked')) {\r\n                                a.attr('href', a.attr('href') + '&includeweights=1');\r\n                            } else {\r\n                                a.attr('href', a.attr('href') + '&includeweights=0');\r\n                            }\r\n                        }\r\n\r\n                        window.location.href = a.attr('href');\r\n                        return;\r\n                    });\r\n\r\n                    modal.show();\r\n                    return modal;\r\n                }).fail(Notification.exception);\r\n            });\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Str","log","Notification","ModalSaveCancel","ModalCancel","ModalEvents","Templates","actionsList","clear","title","key","component","body","delete","confirmAction","actionId","actionType","on","ev","preventDefault","a","currentTarget","wrap","reqStrings","param","closest","length","attr","error","stringsPromise","get_strings","modalPromise","create","when","then","strings","modal","setTitle","setBody","setSaveButtonText","getRoot","save","window","location","href","show","fail","exception","selectEvaluationOptions","trainedOnlyExternally","timeSplittingMethods","this","get_string","render","trainedexternally","timesplittingmethods","JSON","parse","removeOnClose","buttons","val","timeSplittingMethod","catch","selectExportOptions","isTrained","is"],"mappings":"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"}