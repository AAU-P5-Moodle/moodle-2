{"version":3,"file":"acceptmodal.min.js","sources":["../src/acceptmodal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Add policy consent modal to the page\r\n *\r\n * @module     tool_policy/acceptmodal\r\n * @copyright  2018 Marina Glancy\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine([\r\n    'jquery',\r\n    'core/str',\r\n    'core/modal_save_cancel',\r\n    'core/modal_events',\r\n    'core/notification',\r\n    'core/fragment',\r\n    'core/ajax',\r\n    'core_form/changechecker',\r\n], function(\r\n    $,\r\n    Str,\r\n    ModalSaveCancel,\r\n    ModalEvents,\r\n    Notification,\r\n    Fragment,\r\n    Ajax,\r\n    FormChangeChecker\r\n) {\r\n\r\n        \"use strict\";\r\n\r\n        /**\r\n         * Constructor\r\n         *\r\n         * @param {int} contextid\r\n         *\r\n         * Each call to init gets it's own instance of this class.\r\n         */\r\n        var AcceptOnBehalf = function(contextid) {\r\n            this.contextid = contextid;\r\n            this.init();\r\n        };\r\n\r\n        /**\r\n         * @var {Modal} modal\r\n         * @private\r\n         */\r\n        AcceptOnBehalf.prototype.modal = null;\r\n\r\n        /**\r\n         * @var {int} contextid\r\n         * @private\r\n         */\r\n        AcceptOnBehalf.prototype.contextid = -1;\r\n\r\n        /**\r\n         * @var {object} currentTrigger The triggered HTML jQuery object\r\n         * @private\r\n         */\r\n        AcceptOnBehalf.prototype.currentTrigger = null;\r\n\r\n        /**\r\n         * @var {object} triggers The trigger selectors\r\n         * @private\r\n         */\r\n        AcceptOnBehalf.prototype.triggers = {\r\n            SINGLE: 'a[data-action=acceptmodal]',\r\n            BULK: 'input[data-action=acceptmodal]'\r\n        };\r\n\r\n        /**\r\n         * Initialise the class.\r\n         *\r\n         * @private\r\n         */\r\n        AcceptOnBehalf.prototype.init = function() {\r\n            // Initialise for links accepting policies for individual users.\r\n            $(this.triggers.SINGLE).on('click', function(e) {\r\n                e.preventDefault();\r\n                this.currentTrigger = $(e.currentTarget);\r\n                var href = $(e.currentTarget).attr('href'),\r\n                    formData = href.slice(href.indexOf('?') + 1);\r\n                this.showFormModal(formData);\r\n            }.bind(this));\r\n\r\n            // Initialise for multiple users acceptance form.\r\n            $(this.triggers.BULK).on('click', function(e) {\r\n                e.preventDefault();\r\n                this.currentTrigger = $(e.currentTarget);\r\n                var form = $(e.currentTarget).closest('form');\r\n                if (form.find('input[type=checkbox][name=\"userids[]\"]:checked').length) {\r\n                    var formData = form.serialize();\r\n                    this.showFormModal(formData);\r\n                } else {\r\n                    Str.get_strings([\r\n                        {key: 'notice'},\r\n                        {key: 'selectusersforconsent', component: 'tool_policy'},\r\n                        {key: 'ok'}\r\n                    ]).then(function(strings) {\r\n                        Notification.alert(strings[0], strings[1], strings[2]);\r\n                        return;\r\n                    }).fail(Notification.exception);\r\n                }\r\n            }.bind(this));\r\n        };\r\n\r\n        /**\r\n         * Show modal with a form\r\n         *\r\n         * @param {String} formData\r\n         */\r\n        AcceptOnBehalf.prototype.showFormModal = function(formData) {\r\n            var action;\r\n            var params = formData.split('&');\r\n            for (var i = 0; i < params.length; i++) {\r\n                var pair = params[i].split('=');\r\n                if (pair[0] == 'action') {\r\n                    action = pair[1];\r\n                }\r\n            }\r\n            // Fetch the title string.\r\n            Str.get_strings([\r\n                {key: 'statusformtitleaccept', component: 'tool_policy'},\r\n                {key: 'iagreetothepolicy', component: 'tool_policy'},\r\n                {key: 'statusformtitlerevoke', component: 'tool_policy'},\r\n                {key: 'irevokethepolicy', component: 'tool_policy'},\r\n                {key: 'statusformtitledecline', component: 'tool_policy'},\r\n                {key: 'declinethepolicy', component: 'tool_policy'}\r\n            ]).then(function(strings) {\r\n                var title;\r\n                var saveText;\r\n                if (action == 'accept') {\r\n                    title = strings[0];\r\n                    saveText = strings[1];\r\n                } else if (action == 'revoke') {\r\n                    title = strings[2];\r\n                    saveText = strings[3];\r\n                } else if (action == 'decline') {\r\n                    title = strings[4];\r\n                    saveText = strings[5];\r\n                }\r\n                // Create the modal.\r\n                return ModalSaveCancel.create({\r\n                    title: title,\r\n                    body: ''\r\n                }).then(function(modal) {\r\n                    this.modal = modal;\r\n                    this.setupFormModal(formData, saveText);\r\n                }.bind(this));\r\n            }.bind(this))\r\n                .catch(Notification.exception);\r\n        };\r\n\r\n        /**\r\n         * Setup form inside a modal\r\n         *\r\n         * @param {String} formData\r\n         * @param {String} saveText\r\n         */\r\n        AcceptOnBehalf.prototype.setupFormModal = function(formData, saveText) {\r\n            var modal = this.modal;\r\n\r\n            modal.setLarge();\r\n\r\n            modal.setSaveButtonText(saveText);\r\n\r\n            // We want to reset the form every time it is opened.\r\n            modal.getRoot().on(ModalEvents.hidden, this.destroy.bind(this));\r\n\r\n            modal.setBody(this.getBody(formData));\r\n\r\n            // We catch the modal save event, and use it to submit the form inside the modal.\r\n            // Triggering a form submission will give JS validation scripts a chance to check for errors.\r\n            modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\r\n            // We also catch the form submit event and use it to submit the form with ajax.\r\n            modal.getRoot().on('submit', 'form', this.submitFormAjax.bind(this));\r\n\r\n            modal.show();\r\n        };\r\n\r\n        /**\r\n         * Load the body of the modal (contains the form)\r\n         *\r\n         * @method getBody\r\n         * @private\r\n         * @param {String} formData\r\n         * @return {Promise}\r\n         */\r\n        AcceptOnBehalf.prototype.getBody = function(formData) {\r\n            if (typeof formData === \"undefined\") {\r\n                formData = {};\r\n            }\r\n            // Get the content of the modal.\r\n            var params = {jsonformdata: JSON.stringify(formData)};\r\n            return Fragment.loadFragment('tool_policy', 'accept_on_behalf', this.contextid, params);\r\n        };\r\n\r\n        /**\r\n         * Submit the form inside the modal via AJAX request\r\n         *\r\n         * @method submitFormAjax\r\n         * @private\r\n         * @param {Event} e Form submission event.\r\n         */\r\n        AcceptOnBehalf.prototype.submitFormAjax = function(e) {\r\n            // We don't want to do a real form submission.\r\n            e.preventDefault();\r\n\r\n            // Convert all the form elements values to a serialised string.\r\n            var formData = this.modal.getRoot().find('form').serialize();\r\n\r\n            var requests = Ajax.call([{\r\n                methodname: 'tool_policy_submit_accept_on_behalf',\r\n                args: {jsonformdata: JSON.stringify(formData)}\r\n            }]);\r\n            requests[0].done(function(data) {\r\n                if (data.validationerrors) {\r\n                    this.modal.setBody(this.getBody(formData));\r\n                } else {\r\n                    this.close();\r\n                }\r\n            }.bind(this)).fail(Notification.exception);\r\n        };\r\n\r\n        /**\r\n         * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\r\n         *\r\n         * @method submitForm\r\n         * @param {Event} e Form submission event.\r\n         * @private\r\n         */\r\n        AcceptOnBehalf.prototype.submitForm = function(e) {\r\n            e.preventDefault();\r\n            this.modal.getRoot().find('form').submit();\r\n        };\r\n\r\n        /**\r\n         * Close the modal\r\n         */\r\n        AcceptOnBehalf.prototype.close = function() {\r\n            this.destroy();\r\n            document.location.reload();\r\n        };\r\n\r\n        /**\r\n         * Destroy the modal\r\n         */\r\n        AcceptOnBehalf.prototype.destroy = function() {\r\n            FormChangeChecker.resetAllFormDirtyStates();\r\n            this.modal.destroy();\r\n            this.currentTrigger.focus();\r\n        };\r\n\r\n        return /** @alias module:tool_policy/acceptmodal */ {\r\n            // Public variables and functions.\r\n            /**\r\n             * Attach event listeners to initialise this module.\r\n             *\r\n             * @method init\r\n             * @param {int} contextid The contextid for the course.\r\n             * @return {AcceptOnBehalf}\r\n             */\r\n            getInstance: function(contextid) {\r\n                return new AcceptOnBehalf(contextid);\r\n            }\r\n        };\r\n    });\r\n"],"names":["define","$","Str","ModalSaveCancel","ModalEvents","Notification","Fragment","Ajax","FormChangeChecker","AcceptOnBehalf","contextid","this","init","prototype","modal","currentTrigger","triggers","SINGLE","BULK","on","e","preventDefault","currentTarget","href","attr","formData","slice","indexOf","showFormModal","bind","form","closest","find","length","serialize","get_strings","key","component","then","strings","alert","fail","exception","action","params","split","i","pair","title","saveText","create","body","setupFormModal","catch","setLarge","setSaveButtonText","getRoot","hidden","destroy","setBody","getBody","save","submitForm","submitFormAjax","show","jsonformdata","JSON","stringify","loadFragment","call","methodname","args","done","data","validationerrors","close","submit","document","location","reload","resetAllFormDirtyStates","focus","getInstance"],"mappings":"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"}