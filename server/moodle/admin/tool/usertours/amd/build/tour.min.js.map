{"version":3,"file":"tour.min.js","sources":["../src/tour.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * A user tour.\r\n *\r\n * @module tool_usertours/tour\r\n * @copyright  2018 Andrew Nicols <andrew@nicols.co.uk>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * A list of steps.\r\n *\r\n * @typedef {Object[]} StepList\r\n * @property {Number} stepId The id of the step in the database\r\n * @property {Number} position The position of the step within the tour (zero-indexed)\r\n */\r\n\r\nimport $ from 'jquery';\r\nimport * as Aria from 'core/aria';\r\nimport Popper from 'core/popper';\r\nimport {dispatchEvent} from 'core/event_dispatcher';\r\nimport {eventTypes} from './events';\r\nimport {getString} from 'core/str';\r\nimport {prefetchStrings} from 'core/prefetch';\r\nimport {notifyFilterContentUpdated} from 'core/event';\r\nimport PendingPromise from 'core/pending';\r\n\r\n/**\r\n * The minimum spacing for tour step to display.\r\n *\r\n * @private\r\n * @constant\r\n * @type {number}\r\n */\r\nconst MINSPACING = 10;\r\n\r\n/**\r\n * A user tour.\r\n *\r\n * @class tool_usertours/tour\r\n * @property {boolean} tourRunning Whether the tour is currently running.\r\n */\r\nconst Tour = class {\r\n    tourRunning = false;\r\n\r\n    /**\r\n     * @param   {object}    config  The configuration object.\r\n     */\r\n    constructor(config) {\r\n        this.init(config);\r\n    }\r\n\r\n    /**\r\n     * Initialise the tour.\r\n     *\r\n     * @method  init\r\n     * @param   {Object}    config  The configuration object.\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    init(config) {\r\n        // Unset all handlers.\r\n        this.eventHandlers = {};\r\n\r\n        // Reset the current tour states.\r\n        this.reset();\r\n\r\n        // Store the initial configuration.\r\n        this.originalConfiguration = config || {};\r\n\r\n        // Apply configuration.\r\n        this.configure.apply(this, arguments);\r\n\r\n        // Unset recalculate state.\r\n        this.possitionNeedToBeRecalculated = false;\r\n\r\n        // Unset recalculate count.\r\n        this.recalculatedNo = 0;\r\n\r\n        try {\r\n            this.storage = window.sessionStorage;\r\n            this.storageKey = 'tourstate_' + this.tourName;\r\n        } catch (e) {\r\n            this.storage = false;\r\n            this.storageKey = '';\r\n        }\r\n\r\n        prefetchStrings('tool_usertours', [\r\n            'nextstep_sequence',\r\n            'skip_tour'\r\n        ]);\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Reset the current tour state.\r\n     *\r\n     * @method  reset\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    reset() {\r\n        // Hide the current step.\r\n        this.hide();\r\n\r\n        // Unset all handlers.\r\n        this.eventHandlers = [];\r\n\r\n        // Unset all listeners.\r\n        this.resetStepListeners();\r\n\r\n        // Unset the original configuration.\r\n        this.originalConfiguration = {};\r\n\r\n        // Reset the current step number and list of steps.\r\n        this.steps = [];\r\n\r\n        // Reset the current step number.\r\n        this.currentStepNumber = 0;\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Prepare tour configuration.\r\n     *\r\n     * @method  configure\r\n     * @param {Object} config The configuration object.\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    configure(config) {\r\n        if (typeof config === 'object') {\r\n            // Tour name.\r\n            if (typeof config.tourName !== 'undefined') {\r\n                this.tourName = config.tourName;\r\n            }\r\n\r\n            // Set up eventHandlers.\r\n            if (config.eventHandlers) {\r\n                for (let eventName in config.eventHandlers) {\r\n                    config.eventHandlers[eventName].forEach(function(handler) {\r\n                        this.addEventHandler(eventName, handler);\r\n                    }, this);\r\n                }\r\n            }\r\n\r\n            // Reset the step configuration.\r\n            this.resetStepDefaults(true);\r\n\r\n            // Configure the steps.\r\n            if (typeof config.steps === 'object') {\r\n                this.steps = config.steps;\r\n            }\r\n\r\n            if (typeof config.template !== 'undefined') {\r\n                this.templateContent = config.template;\r\n            }\r\n        }\r\n\r\n        // Check that we have enough to start the tour.\r\n        this.checkMinimumRequirements();\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Check that the configuration meets the minimum requirements.\r\n     *\r\n     * @method  checkMinimumRequirements\r\n     */\r\n    checkMinimumRequirements() {\r\n        // Need a tourName.\r\n        if (!this.tourName) {\r\n            throw new Error(\"Tour Name required\");\r\n        }\r\n\r\n        // Need a minimum of one step.\r\n        if (!this.steps || !this.steps.length) {\r\n            throw new Error(\"Steps must be specified\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reset step default configuration.\r\n     *\r\n     * @method  resetStepDefaults\r\n     * @param   {Boolean}   loadOriginalConfiguration   Whether to load the original configuration supplied with the Tour.\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    resetStepDefaults(loadOriginalConfiguration) {\r\n        if (typeof loadOriginalConfiguration === 'undefined') {\r\n            loadOriginalConfiguration = true;\r\n        }\r\n\r\n        this.stepDefaults = {};\r\n        if (!loadOriginalConfiguration || typeof this.originalConfiguration.stepDefaults === 'undefined') {\r\n            this.setStepDefaults({});\r\n        } else {\r\n            this.setStepDefaults(this.originalConfiguration.stepDefaults);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Set the step defaults.\r\n     *\r\n     * @method  setStepDefaults\r\n     * @param   {Object}    stepDefaults                The step defaults to apply to all steps\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    setStepDefaults(stepDefaults) {\r\n        if (!this.stepDefaults) {\r\n            this.stepDefaults = {};\r\n        }\r\n        $.extend(\r\n            this.stepDefaults,\r\n            {\r\n                element:        '',\r\n                placement:      'top',\r\n                delay:          0,\r\n                moveOnClick:    false,\r\n                moveAfterTime:  0,\r\n                orphan:         false,\r\n                direction:      1,\r\n            },\r\n            stepDefaults\r\n        );\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Retrieve the current step number.\r\n     *\r\n     * @method  getCurrentStepNumber\r\n     * @return  {Number}                   The current step number\r\n     */\r\n    getCurrentStepNumber() {\r\n        return parseInt(this.currentStepNumber, 10);\r\n    }\r\n\r\n    /**\r\n     * Store the current step number.\r\n     *\r\n     * @method  setCurrentStepNumber\r\n     * @param   {Number}   stepNumber      The current step number\r\n     * @chainable\r\n     */\r\n    setCurrentStepNumber(stepNumber) {\r\n        this.currentStepNumber = stepNumber;\r\n        if (this.storage) {\r\n            try {\r\n                this.storage.setItem(this.storageKey, stepNumber);\r\n            } catch (e) {\r\n                if (e.code === DOMException.QUOTA_EXCEEDED_ERR) {\r\n                    this.storage.removeItem(this.storageKey);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the next step number after the currently displayed step.\r\n     *\r\n     * @method  getNextStepNumber\r\n     * @param   {Number}   stepNumber      The current step number\r\n     * @return  {Number}    The next step number to display\r\n     */\r\n    getNextStepNumber(stepNumber) {\r\n        if (typeof stepNumber === 'undefined') {\r\n            stepNumber = this.getCurrentStepNumber();\r\n        }\r\n        let nextStepNumber = stepNumber + 1;\r\n\r\n        // Keep checking the remaining steps.\r\n        while (nextStepNumber <= this.steps.length) {\r\n            if (this.isStepPotentiallyVisible(this.getStepConfig(nextStepNumber))) {\r\n                return nextStepNumber;\r\n            }\r\n            nextStepNumber++;\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Get the previous step number before the currently displayed step.\r\n     *\r\n     * @method  getPreviousStepNumber\r\n     * @param   {Number}   stepNumber      The current step number\r\n     * @return  {Number}    The previous step number to display\r\n     */\r\n    getPreviousStepNumber(stepNumber) {\r\n        if (typeof stepNumber === 'undefined') {\r\n            stepNumber = this.getCurrentStepNumber();\r\n        }\r\n        let previousStepNumber = stepNumber - 1;\r\n\r\n        // Keep checking the remaining steps.\r\n        while (previousStepNumber >= 0) {\r\n            if (this.isStepPotentiallyVisible(this.getStepConfig(previousStepNumber))) {\r\n                return previousStepNumber;\r\n            }\r\n            previousStepNumber--;\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Is the step the final step number?\r\n     *\r\n     * @method  isLastStep\r\n     * @param   {Number}   stepNumber  Step number to test\r\n     * @return  {Boolean}               Whether the step is the final step\r\n     */\r\n    isLastStep(stepNumber) {\r\n        let nextStepNumber = this.getNextStepNumber(stepNumber);\r\n\r\n        return nextStepNumber === null;\r\n    }\r\n\r\n    /**\r\n     * Is this step potentially visible?\r\n     *\r\n     * @method  isStepPotentiallyVisible\r\n     * @param   {Object}    stepConfig      The step configuration to normalise\r\n     * @return  {Boolean}               Whether the step is the potentially visible\r\n     */\r\n    isStepPotentiallyVisible(stepConfig) {\r\n        if (!stepConfig) {\r\n            // Without step config, there can be no step.\r\n            return false;\r\n        }\r\n\r\n        if (this.isStepActuallyVisible(stepConfig)) {\r\n            // If it is actually visible, it is already potentially visible.\r\n            return true;\r\n        }\r\n\r\n        if (typeof stepConfig.orphan !== 'undefined' && stepConfig.orphan) {\r\n            // Orphan steps have no target. They are always visible.\r\n            return true;\r\n        }\r\n\r\n        if (typeof stepConfig.delay !== 'undefined' && stepConfig.delay) {\r\n            // Only return true if the activated has not been used yet.\r\n            return true;\r\n        }\r\n\r\n        // Not theoretically, or actually visible.\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Get potentially visible steps in a tour.\r\n     *\r\n     * @returns {StepList} A list of ordered steps\r\n     */\r\n    getPotentiallyVisibleSteps() {\r\n        let position = 1;\r\n        let result = [];\r\n        // Checking the total steps.\r\n        for (let stepNumber = 0; stepNumber < this.steps.length; stepNumber++) {\r\n            const stepConfig = this.getStepConfig(stepNumber);\r\n            if (this.isStepPotentiallyVisible(stepConfig)) {\r\n                result[stepNumber] = {stepId: stepConfig.stepid, position: position};\r\n                position++;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Is this step actually visible?\r\n     *\r\n     * @method  isStepActuallyVisible\r\n     * @param   {Object}    stepConfig      The step configuration to normalise\r\n     * @return  {Boolean}               Whether the step is actually visible\r\n     */\r\n    isStepActuallyVisible(stepConfig) {\r\n        if (!stepConfig) {\r\n            // Without step config, there can be no step.\r\n            return false;\r\n        }\r\n\r\n        // Check if the CSS styles are allowed on the browser or not.\r\n        if (!this.isCSSAllowed()) {\r\n            return false;\r\n        }\r\n\r\n        let target = this.getStepTarget(stepConfig);\r\n        if (target && target.length && target.is(':visible')) {\r\n            // Without a target, there can be no step.\r\n            return !!target.length;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Is the browser actually allow CSS styles?\r\n     *\r\n     * @returns {boolean} True if the browser is allowing CSS styles\r\n     */\r\n    isCSSAllowed() {\r\n        const testCSSElement = document.createElement('div');\r\n        testCSSElement.classList.add('hide');\r\n        document.body.appendChild(testCSSElement);\r\n        const styles = window.getComputedStyle(testCSSElement);\r\n        const isAllowed = styles.display === 'none';\r\n        testCSSElement.remove();\r\n\r\n        return isAllowed;\r\n    }\r\n\r\n    /**\r\n     * Go to the next step in the tour.\r\n     *\r\n     * @method  next\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    next() {\r\n        return this.gotoStep(this.getNextStepNumber());\r\n    }\r\n\r\n    /**\r\n     * Go to the previous step in the tour.\r\n     *\r\n     * @method  previous\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    previous() {\r\n        return this.gotoStep(this.getPreviousStepNumber(), -1);\r\n    }\r\n\r\n    /**\r\n     * Go to the specified step in the tour.\r\n     *\r\n     * @method  gotoStep\r\n     * @param   {Number}   stepNumber     The step number to display\r\n     * @param   {Number}   direction      Next or previous step\r\n     * @chainable\r\n     * @return {Object} this.\r\n     * @fires tool_usertours/stepRender\r\n     * @fires tool_usertours/stepRendered\r\n     * @fires tool_usertours/stepHide\r\n     * @fires tool_usertours/stepHidden\r\n     */\r\n    gotoStep(stepNumber, direction) {\r\n        if (stepNumber < 0) {\r\n            return this.endTour();\r\n        }\r\n\r\n        let stepConfig = this.getStepConfig(stepNumber);\r\n        if (stepConfig === null) {\r\n            return this.endTour();\r\n        }\r\n\r\n        return this._gotoStep(stepConfig, direction);\r\n    }\r\n\r\n    _gotoStep(stepConfig, direction) {\r\n        if (!stepConfig) {\r\n            return this.endTour();\r\n        }\r\n\r\n        const pendingPromise = new PendingPromise(`tool_usertours/tour:_gotoStep-${stepConfig.stepNumber}`);\r\n\r\n        if (typeof stepConfig.delay !== 'undefined' && stepConfig.delay && !stepConfig.delayed) {\r\n            stepConfig.delayed = true;\r\n            window.setTimeout(function(stepConfig, direction) {\r\n                this._gotoStep(stepConfig, direction);\r\n                pendingPromise.resolve();\r\n            }, stepConfig.delay, stepConfig, direction);\r\n\r\n            return this;\r\n        } else if (!stepConfig.orphan && !this.isStepActuallyVisible(stepConfig)) {\r\n            const fn = direction == -1 ? 'getPreviousStepNumber' : 'getNextStepNumber';\r\n            this.gotoStep(this[fn](stepConfig.stepNumber), direction);\r\n\r\n            pendingPromise.resolve();\r\n            return this;\r\n        }\r\n\r\n        this.hide();\r\n\r\n        const stepRenderEvent = this.dispatchEvent(eventTypes.stepRender, {stepConfig}, true);\r\n        if (!stepRenderEvent.defaultPrevented) {\r\n            this.renderStep(stepConfig);\r\n            this.dispatchEvent(eventTypes.stepRendered, {stepConfig});\r\n        }\r\n\r\n        pendingPromise.resolve();\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Fetch the normalised step configuration for the specified step number.\r\n     *\r\n     * @method  getStepConfig\r\n     * @param   {Number}   stepNumber      The step number to fetch configuration for\r\n     * @return  {Object}                    The step configuration\r\n     */\r\n    getStepConfig(stepNumber) {\r\n        if (stepNumber === null || stepNumber < 0 || stepNumber >= this.steps.length) {\r\n            return null;\r\n        }\r\n\r\n        // Normalise the step configuration.\r\n        let stepConfig = this.normalizeStepConfig(this.steps[stepNumber]);\r\n\r\n        // Add the stepNumber to the stepConfig.\r\n        stepConfig = $.extend(stepConfig, {stepNumber: stepNumber});\r\n\r\n        return stepConfig;\r\n    }\r\n\r\n    /**\r\n     * Normalise the supplied step configuration.\r\n     *\r\n     * @method  normalizeStepConfig\r\n     * @param   {Object}    stepConfig      The step configuration to normalise\r\n     * @return  {Object}                    The normalised step configuration\r\n     */\r\n    normalizeStepConfig(stepConfig) {\r\n\r\n        if (typeof stepConfig.reflex !== 'undefined' && typeof stepConfig.moveAfterClick === 'undefined') {\r\n            stepConfig.moveAfterClick = stepConfig.reflex;\r\n        }\r\n\r\n        if (typeof stepConfig.element !== 'undefined' && typeof stepConfig.target === 'undefined') {\r\n            stepConfig.target = stepConfig.element;\r\n        }\r\n\r\n        if (typeof stepConfig.content !== 'undefined' && typeof stepConfig.body === 'undefined') {\r\n            stepConfig.body = stepConfig.content;\r\n        }\r\n\r\n        stepConfig = $.extend({}, this.stepDefaults, stepConfig);\r\n\r\n        stepConfig = $.extend({}, {\r\n            attachTo: stepConfig.target,\r\n            attachPoint: 'after',\r\n        }, stepConfig);\r\n\r\n        if (stepConfig.attachTo) {\r\n            stepConfig.attachTo = $(stepConfig.attachTo).first();\r\n        }\r\n\r\n        return stepConfig;\r\n    }\r\n\r\n    /**\r\n     * Fetch the actual step target from the selector.\r\n     *\r\n     * This should not be called until after any delay has completed.\r\n     *\r\n     * @method  getStepTarget\r\n     * @param   {Object}    stepConfig      The step configuration\r\n     * @return  {$}\r\n     */\r\n    getStepTarget(stepConfig) {\r\n        if (stepConfig.target) {\r\n            return $(stepConfig.target);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Fire any event handlers for the specified event.\r\n     *\r\n     * @param {String} eventName The name of the event\r\n     * @param {Object} [detail={}] Any additional details to pass into the eveent\r\n     * @param {Boolean} [cancelable=false] Whether preventDefault() can be called\r\n     * @returns {CustomEvent}\r\n     */\r\n    dispatchEvent(\r\n        eventName,\r\n        detail = {},\r\n        cancelable = false\r\n    ) {\r\n        return dispatchEvent(eventName, {\r\n            // Add the tour to the detail.\r\n            tour: this,\r\n            ...detail,\r\n        }, document, {\r\n            cancelable,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * @method addEventHandler\r\n     * @param  {string}      eventName       The name of the event to listen for\r\n     * @param  {function}    handler         The event handler to call\r\n     * @return {Object} this.\r\n     */\r\n    addEventHandler(eventName, handler) {\r\n        if (typeof this.eventHandlers[eventName] === 'undefined') {\r\n            this.eventHandlers[eventName] = [];\r\n        }\r\n\r\n        this.eventHandlers[eventName].push(handler);\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Process listeners for the step being shown.\r\n     *\r\n     * @method  processStepListeners\r\n     * @param   {object}    stepConfig      The configuration for the step\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    processStepListeners(stepConfig) {\r\n        this.listeners.push(\r\n        // Next button.\r\n        {\r\n            node: this.currentStepNode,\r\n            args: ['click', '[data-role=\"next\"]', $.proxy(this.next, this)]\r\n        },\r\n\r\n        // Close and end tour buttons.\r\n        {\r\n            node: this.currentStepNode,\r\n            args: ['click', '[data-role=\"end\"]', $.proxy(this.endTour, this)]\r\n        },\r\n\r\n        // Click backdrop and hide tour.\r\n        {\r\n            node: $('[data-flexitour=\"backdrop\"]'),\r\n            args: ['click', $.proxy(this.hide, this)]\r\n        },\r\n\r\n        // Keypresses.\r\n        {\r\n            node: $('body'),\r\n            args: ['keydown', $.proxy(this.handleKeyDown, this)]\r\n        });\r\n\r\n        if (stepConfig.moveOnClick) {\r\n            var targetNode = this.getStepTarget(stepConfig);\r\n            this.listeners.push({\r\n                node: targetNode,\r\n                args: ['click', $.proxy(function(e) {\r\n                    if ($(e.target).parents('[data-flexitour=\"container\"]').length === 0) {\r\n                        // Ignore clicks when they are in the flexitour.\r\n                        window.setTimeout($.proxy(this.next, this), 500);\r\n                    }\r\n                }, this)]\r\n            });\r\n        }\r\n\r\n        this.listeners.forEach(function(listener) {\r\n            listener.node.on.apply(listener.node, listener.args);\r\n        });\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Reset step listeners.\r\n     *\r\n     * @method  resetStepListeners\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    resetStepListeners() {\r\n        // Stop listening to all external handlers.\r\n        if (this.listeners) {\r\n            this.listeners.forEach(function(listener) {\r\n                listener.node.off.apply(listener.node, listener.args);\r\n            });\r\n        }\r\n        this.listeners = [];\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * The standard step renderer.\r\n     *\r\n     * @method  renderStep\r\n     * @param   {Object}    stepConfig      The step configuration of the step\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    renderStep(stepConfig) {\r\n        // Store the current step configuration for later.\r\n        this.currentStepConfig = stepConfig;\r\n        this.setCurrentStepNumber(stepConfig.stepNumber);\r\n\r\n        // Fetch the template and convert it to a $ object.\r\n        let template = $(this.getTemplateContent());\r\n\r\n        // Title.\r\n        template.find('[data-placeholder=\"title\"]')\r\n            .html(stepConfig.title);\r\n\r\n        // Body.\r\n        template.find('[data-placeholder=\"body\"]')\r\n            .html(stepConfig.body);\r\n\r\n        // Buttons.\r\n        const nextBtn = template.find('[data-role=\"next\"]');\r\n        const endBtn = template.find('[data-role=\"end\"]');\r\n\r\n        // Is this the final step?\r\n        if (this.isLastStep(stepConfig.stepNumber)) {\r\n            nextBtn.hide();\r\n            endBtn.removeClass(\"btn-secondary\").addClass(\"btn-primary\");\r\n        } else {\r\n            nextBtn.prop('disabled', false);\r\n            // Use Skip tour label for the End tour button.\r\n            getString('skip_tour', 'tool_usertours').then(value => {\r\n                endBtn.html(value);\r\n                return;\r\n            }).catch();\r\n        }\r\n\r\n        nextBtn.attr('role', 'button');\r\n        endBtn.attr('role', 'button');\r\n\r\n        if (this.originalConfiguration.displaystepnumbers) {\r\n            const stepsPotentiallyVisible = this.getPotentiallyVisibleSteps();\r\n            const totalStepsPotentiallyVisible = stepsPotentiallyVisible.length;\r\n            const position = stepsPotentiallyVisible[stepConfig.stepNumber].position;\r\n            if (totalStepsPotentiallyVisible > 1) {\r\n                // Change the label of the Next button to include the sequence.\r\n                getString('nextstep_sequence', 'tool_usertours',\r\n                    {position: position, total: totalStepsPotentiallyVisible}).then(value => {\r\n                    nextBtn.html(value);\r\n                    return;\r\n                }).catch();\r\n            }\r\n        }\r\n\r\n        // Replace the template with the updated version.\r\n        stepConfig.template = template;\r\n\r\n        // Add to the page.\r\n        this.addStepToPage(stepConfig);\r\n\r\n        // Process step listeners after adding to the page.\r\n        // This uses the currentNode.\r\n        this.processStepListeners(stepConfig);\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Getter for the template content.\r\n     *\r\n     * @method  getTemplateContent\r\n     * @return  {$}\r\n     */\r\n    getTemplateContent() {\r\n        return $(this.templateContent).clone();\r\n    }\r\n\r\n    /**\r\n     * Helper to add a step to the page.\r\n     *\r\n     * @method  addStepToPage\r\n     * @param   {Object}    stepConfig      The step configuration of the step\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    addStepToPage(stepConfig) {\r\n        // Create the stepNode from the template data.\r\n        let currentStepNode = $('<span data-flexitour=\"container\"></span>')\r\n            .html(stepConfig.template)\r\n            .hide();\r\n        // Trigger the Moodle filters.\r\n        notifyFilterContentUpdated(currentStepNode);\r\n\r\n        // The scroll animation occurs on the body or html.\r\n        let animationTarget = $('body, html')\r\n            .stop(true, true);\r\n\r\n        if (this.isStepActuallyVisible(stepConfig)) {\r\n            let targetNode = this.getStepTarget(stepConfig);\r\n\r\n            if (targetNode.parents('[data-usertour=\"scroller\"]').length) {\r\n                animationTarget = targetNode.parents('[data-usertour=\"scroller\"]');\r\n            }\r\n\r\n            targetNode.data('flexitour', 'target');\r\n\r\n            let zIndex = this.calculateZIndex(targetNode);\r\n            if (zIndex) {\r\n                stepConfig.zIndex = zIndex + 1;\r\n            }\r\n\r\n            if (stepConfig.zIndex) {\r\n                currentStepNode.css('zIndex', stepConfig.zIndex + 1);\r\n            }\r\n\r\n            // Add the backdrop.\r\n            this.positionBackdrop(stepConfig);\r\n\r\n            $(document.body).append(currentStepNode);\r\n            this.currentStepNode = currentStepNode;\r\n\r\n            // Ensure that the step node is positioned.\r\n            // Some situations mean that the value is not properly calculated without this step.\r\n            this.currentStepNode.css({\r\n                top: 0,\r\n                left: 0,\r\n            });\r\n\r\n            const pendingPromise = new PendingPromise(`tool_usertours/tour:addStepToPage-${stepConfig.stepNumber}`);\r\n            animationTarget\r\n                .animate({\r\n                    scrollTop: this.calculateScrollTop(stepConfig),\r\n                }).promise().then(function() {\r\n                        this.positionStep(stepConfig);\r\n                        this.revealStep(stepConfig);\r\n                        pendingPromise.resolve();\r\n                        return;\r\n                    }.bind(this))\r\n                    .catch(function() {\r\n                        // Silently fail.\r\n                    });\r\n\r\n        } else if (stepConfig.orphan) {\r\n            stepConfig.isOrphan = true;\r\n\r\n            // This will be appended to the body instead.\r\n            stepConfig.attachTo = $('body').first();\r\n            stepConfig.attachPoint = 'append';\r\n\r\n            // Add the backdrop.\r\n            this.positionBackdrop(stepConfig);\r\n\r\n            // This is an orphaned step.\r\n            currentStepNode.addClass('orphan');\r\n\r\n            // It lives in the body.\r\n            $(document.body).append(currentStepNode);\r\n            this.currentStepNode = currentStepNode;\r\n\r\n            this.currentStepNode.css('position', 'fixed');\r\n\r\n            this.currentStepPopper = new Popper(\r\n                $('body'),\r\n                this.currentStepNode[0], {\r\n                    removeOnDestroy: true,\r\n                    placement: stepConfig.placement + '-start',\r\n                    arrowElement: '[data-role=\"arrow\"]',\r\n                    // Empty the modifiers. We've already placed the step and don't want it moved.\r\n                    modifiers: {\r\n                        hide: {\r\n                            enabled: false,\r\n                        },\r\n                        applyStyle: {\r\n                            onLoad: null,\r\n                            enabled: false,\r\n                        },\r\n                    },\r\n                    onCreate: () => {\r\n                        // First, we need to check if the step's content contains any images.\r\n                        const images = this.currentStepNode.find('img');\r\n                        if (images.length) {\r\n                            // Images found, need to calculate the position when the image is loaded.\r\n                            images.on('load', () => {\r\n                                this.calculateStepPositionInPage(currentStepNode);\r\n                            });\r\n                        }\r\n                        this.calculateStepPositionInPage(currentStepNode);\r\n                    }\r\n                }\r\n            );\r\n\r\n            this.revealStep(stepConfig);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Make the given step visible.\r\n     *\r\n     * @method revealStep\r\n     * @param {Object} stepConfig The step configuration of the step\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    revealStep(stepConfig) {\r\n        // Fade the step in.\r\n        const pendingPromise = new PendingPromise(`tool_usertours/tour:revealStep-${stepConfig.stepNumber}`);\r\n        this.currentStepNode.fadeIn('', $.proxy(function() {\r\n                // Announce via ARIA.\r\n                this.announceStep(stepConfig);\r\n\r\n                // Focus on the current step Node.\r\n                this.currentStepNode.focus();\r\n                window.setTimeout($.proxy(function() {\r\n                    // After a brief delay, focus again.\r\n                    // There seems to be an issue with Jaws where it only reads the dialogue title initially.\r\n                    // This second focus helps it to read the full dialogue.\r\n                    if (this.currentStepNode) {\r\n                        this.currentStepNode.focus();\r\n                    }\r\n                    pendingPromise.resolve();\r\n                }, this), 100);\r\n\r\n            }, this));\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Helper to announce the step on the page.\r\n     *\r\n     * @method  announceStep\r\n     * @param   {Object}    stepConfig      The step configuration of the step\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    announceStep(stepConfig) {\r\n        // Setup the step Dialogue as per:\r\n        // * https://www.w3.org/TR/wai-aria-practices/#dialog_nonmodal\r\n        // * https://www.w3.org/TR/wai-aria-practices/#dialog_modal\r\n\r\n        // Generate an ID for the current step node.\r\n        let stepId = 'tour-step-' + this.tourName + '-' + stepConfig.stepNumber;\r\n        this.currentStepNode.attr('id', stepId);\r\n\r\n        let bodyRegion = this.currentStepNode.find('[data-placeholder=\"body\"]').first();\r\n        bodyRegion.attr('id', stepId + '-body');\r\n        bodyRegion.attr('role', 'document');\r\n\r\n        let headerRegion = this.currentStepNode.find('[data-placeholder=\"title\"]').first();\r\n        headerRegion.attr('id', stepId + '-title');\r\n        headerRegion.attr('aria-labelledby', stepId + '-body');\r\n\r\n        // Generally, a modal dialog has a role of dialog.\r\n        this.currentStepNode.attr('role', 'dialog');\r\n        this.currentStepNode.attr('tabindex', 0);\r\n        this.currentStepNode.attr('aria-labelledby', stepId + '-title');\r\n        this.currentStepNode.attr('aria-describedby', stepId + '-body');\r\n\r\n        // Configure ARIA attributes on the target.\r\n        let target = this.getStepTarget(stepConfig);\r\n        if (target) {\r\n            target.data('original-tabindex', target.attr('tabindex'));\r\n            if (!target.attr('tabindex')) {\r\n                target.attr('tabindex', 0);\r\n            }\r\n\r\n            target\r\n                .data('original-describedby', target.attr('aria-describedby'))\r\n                .attr('aria-describedby', stepId + '-body')\r\n                ;\r\n        }\r\n\r\n        this.accessibilityShow(stepConfig);\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Handle key down events.\r\n     *\r\n     * @method  handleKeyDown\r\n     * @param   {EventFacade} e\r\n     */\r\n    handleKeyDown(e) {\r\n        let tabbableSelector = 'a[href], link[href], [draggable=true], [contenteditable=true], ';\r\n        tabbableSelector += ':input:enabled, [tabindex], button:enabled';\r\n        switch (e.keyCode) {\r\n            case 27:\r\n                this.endTour();\r\n                break;\r\n\r\n            // 9 == Tab - trap focus for items with a backdrop.\r\n            case 9:\r\n                // Tab must be handled on key up only in this instance.\r\n                (function() {\r\n                    if (!this.currentStepConfig.hasBackdrop) {\r\n                        // Trapping tab focus is only handled for those steps with a backdrop.\r\n                        return;\r\n                    }\r\n\r\n                    // Find all tabbable locations.\r\n                    let activeElement = $(document.activeElement);\r\n                    let stepTarget = this.getStepTarget(this.currentStepConfig);\r\n                    let tabbableNodes = $(tabbableSelector);\r\n                    let dialogContainer = $('span[data-flexitour=\"container\"]');\r\n                    let currentIndex;\r\n                    // Filter out element which is not belong to target section or dialogue.\r\n                    if (stepTarget) {\r\n                        tabbableNodes = tabbableNodes.filter(function(index, element) {\r\n                            return stepTarget !== null\r\n                                && (stepTarget.has(element).length\r\n                                    || dialogContainer.has(element).length\r\n                                    || stepTarget.is(element)\r\n                                    || dialogContainer.is(element));\r\n                        });\r\n                    }\r\n\r\n                    // Find index of focusing element.\r\n                    tabbableNodes.each(function(index, element) {\r\n                        if (activeElement.is(element)) {\r\n                            currentIndex = index;\r\n                            return false;\r\n                        }\r\n                        // Keep looping.\r\n                        return true;\r\n                    });\r\n\r\n                    let nextIndex;\r\n                    let nextNode;\r\n                    let focusRelevant;\r\n                    if (currentIndex != void 0) {\r\n                        let direction = 1;\r\n                        if (e.shiftKey) {\r\n                            direction = -1;\r\n                        }\r\n                        nextIndex = currentIndex;\r\n                        do {\r\n                            nextIndex += direction;\r\n                            nextNode = $(tabbableNodes[nextIndex]);\r\n                        } while (nextNode.length && nextNode.is(':disabled') || nextNode.is(':hidden'));\r\n                        if (nextNode.length) {\r\n                            // A new f\r\n                            focusRelevant = nextNode.closest(stepTarget).length;\r\n                            focusRelevant = focusRelevant || nextNode.closest(this.currentStepNode).length;\r\n                        } else {\r\n                            // Unable to find the target somehow.\r\n                            focusRelevant = false;\r\n                        }\r\n                    }\r\n\r\n                    if (focusRelevant) {\r\n                        nextNode.focus();\r\n                    } else {\r\n                        if (e.shiftKey) {\r\n                            // Focus on the last tabbable node in the step.\r\n                            this.currentStepNode.find(tabbableSelector).last().focus();\r\n                        } else {\r\n                            if (this.currentStepConfig.isOrphan) {\r\n                                // Focus on the step - there is no target.\r\n                                this.currentStepNode.focus();\r\n                            } else {\r\n                                // Focus on the step target.\r\n                                stepTarget.focus();\r\n                            }\r\n                        }\r\n                    }\r\n                    e.preventDefault();\r\n                }).call(this);\r\n                break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Start the current tour.\r\n     *\r\n     * @method  startTour\r\n     * @param   {Number} startAt Which step number to start at. If not specified, starts at the last point.\r\n     * @chainable\r\n     * @return {Object} this.\r\n     * @fires tool_usertours/tourStart\r\n     * @fires tool_usertours/tourStarted\r\n     */\r\n    startTour(startAt) {\r\n        if (this.storage && typeof startAt === 'undefined') {\r\n            let storageStartValue = this.storage.getItem(this.storageKey);\r\n            if (storageStartValue) {\r\n                let storageStartAt = parseInt(storageStartValue, 10);\r\n                if (storageStartAt <= this.steps.length) {\r\n                    startAt = storageStartAt;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (typeof startAt === 'undefined') {\r\n            startAt = this.getCurrentStepNumber();\r\n        }\r\n\r\n        const tourStartEvent = this.dispatchEvent(eventTypes.tourStart, {startAt}, true);\r\n        if (!tourStartEvent.defaultPrevented) {\r\n            this.gotoStep(startAt);\r\n            this.tourRunning = true;\r\n            this.dispatchEvent(eventTypes.tourStarted, {startAt});\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Restart the tour from the beginning, resetting the completionlag.\r\n     *\r\n     * @method  restartTour\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    restartTour() {\r\n        return this.startTour(0);\r\n    }\r\n\r\n    /**\r\n     * End the current tour.\r\n     *\r\n     * @method  endTour\r\n     * @chainable\r\n     * @return {Object} this.\r\n     * @fires tool_usertours/tourEnd\r\n     * @fires tool_usertours/tourEnded\r\n     */\r\n    endTour() {\r\n        const tourEndEvent = this.dispatchEvent(eventTypes.tourEnd, {}, true);\r\n        if (tourEndEvent.defaultPrevented) {\r\n            return this;\r\n        }\r\n\r\n        if (this.currentStepConfig) {\r\n            let previousTarget = this.getStepTarget(this.currentStepConfig);\r\n            if (previousTarget) {\r\n                if (!previousTarget.attr('tabindex')) {\r\n                    previousTarget.attr('tabindex', '-1');\r\n                }\r\n                previousTarget.first().focus();\r\n            }\r\n        }\r\n\r\n        this.hide(true);\r\n\r\n        this.tourRunning = false;\r\n        this.dispatchEvent(eventTypes.tourEnded);\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Hide any currently visible steps.\r\n     *\r\n     * @method hide\r\n     * @param {Bool} transition Animate the visibility change\r\n     * @chainable\r\n     * @return {Object} this.\r\n     * @fires tool_usertours/stepHide\r\n     * @fires tool_usertours/stepHidden\r\n     */\r\n    hide(transition) {\r\n        const stepHideEvent = this.dispatchEvent(eventTypes.stepHide, {}, true);\r\n        if (stepHideEvent.defaultPrevented) {\r\n            return this;\r\n        }\r\n\r\n        const pendingPromise = new PendingPromise('tool_usertours/tour:hide');\r\n        if (this.currentStepNode && this.currentStepNode.length) {\r\n            this.currentStepNode.hide();\r\n            if (this.currentStepPopper) {\r\n                this.currentStepPopper.destroy();\r\n            }\r\n        }\r\n\r\n        // Restore original target configuration.\r\n        if (this.currentStepConfig) {\r\n            let target = this.getStepTarget(this.currentStepConfig);\r\n            if (target) {\r\n                if (target.data('original-labelledby')) {\r\n                    target.attr('aria-labelledby', target.data('original-labelledby'));\r\n                }\r\n\r\n                if (target.data('original-describedby')) {\r\n                    target.attr('aria-describedby', target.data('original-describedby'));\r\n                }\r\n\r\n                if (target.data('original-tabindex')) {\r\n                    target.attr('tabindex', target.data('tabindex'));\r\n                } else {\r\n                    // If the target does not have the tabindex attribute at the beginning. We need to remove it.\r\n                    // We should wait a little here before removing the attribute to prevent the browser from adding it again.\r\n                    window.setTimeout(() => {\r\n                        target.removeAttr('tabindex');\r\n                    }, 400);\r\n                }\r\n            }\r\n\r\n            // Clear the step configuration.\r\n            this.currentStepConfig = null;\r\n        }\r\n\r\n        // Remove the backdrop features.\r\n        $('[data-flexitour=\"step-background\"]').remove();\r\n        $('[data-flexitour=\"step-backdrop\"]').removeAttr('data-flexitour');\r\n\r\n        const backdrop = $('[data-flexitour=\"backdrop\"]');\r\n        if (backdrop.length) {\r\n            if (transition) {\r\n                const backdropRemovalPromise = new PendingPromise('tool_usertours/tour:hide:backdrop');\r\n                backdrop.fadeOut(400, function() {\r\n                    $(this).remove();\r\n                    backdropRemovalPromise.resolve();\r\n                });\r\n            } else {\r\n                backdrop.remove();\r\n            }\r\n        }\r\n\r\n        // Remove aria-describedby and tabindex attributes.\r\n        if (this.currentStepNode && this.currentStepNode.length) {\r\n            let stepId = this.currentStepNode.attr('id');\r\n            if (stepId) {\r\n                let currentStepElement = '[aria-describedby=\"' + stepId + '-body\"]';\r\n                $(currentStepElement).removeAttr('tabindex');\r\n                $(currentStepElement).removeAttr('aria-describedby');\r\n            }\r\n        }\r\n\r\n        // Reset the listeners.\r\n        this.resetStepListeners();\r\n\r\n        this.accessibilityHide();\r\n\r\n        this.dispatchEvent(eventTypes.stepHidden);\r\n\r\n        this.currentStepNode = null;\r\n        this.currentStepPopper = null;\r\n\r\n        pendingPromise.resolve();\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Show the current steps.\r\n     *\r\n     * @method show\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    show() {\r\n        // Show the current step.\r\n        let startAt = this.getCurrentStepNumber();\r\n\r\n        return this.gotoStep(startAt);\r\n    }\r\n\r\n    /**\r\n     * Return the current step node.\r\n     *\r\n     * @method  getStepContainer\r\n     * @return  {jQuery}\r\n     */\r\n    getStepContainer() {\r\n        return $(this.currentStepNode);\r\n    }\r\n\r\n    /**\r\n     * Calculate scrollTop.\r\n     *\r\n     * @method  calculateScrollTop\r\n     * @param   {Object}    stepConfig      The step configuration of the step\r\n     * @return  {Number}\r\n     */\r\n    calculateScrollTop(stepConfig) {\r\n        let viewportHeight = $(window).height();\r\n        let targetNode = this.getStepTarget(stepConfig);\r\n\r\n        let scrollParent = $(window);\r\n        if (targetNode.parents('[data-usertour=\"scroller\"]').length) {\r\n            scrollParent = targetNode.parents('[data-usertour=\"scroller\"]');\r\n        }\r\n        let scrollTop = scrollParent.scrollTop();\r\n\r\n        if (stepConfig.placement === 'top') {\r\n            // If the placement is top, center scroll at the top of the target.\r\n            scrollTop = targetNode.offset().top - (viewportHeight / 2);\r\n        } else if (stepConfig.placement === 'bottom') {\r\n            // If the placement is bottom, center scroll at the bottom of the target.\r\n            scrollTop = targetNode.offset().top + targetNode.height() + scrollTop - (viewportHeight / 2);\r\n        } else if (targetNode.height() <= (viewportHeight * 0.8)) {\r\n            // If the placement is left/right, and the target fits in the viewport, centre screen on the target\r\n            scrollTop = targetNode.offset().top - ((viewportHeight - targetNode.height()) / 2);\r\n        } else {\r\n            // If the placement is left/right, and the target is bigger than the viewport, set scrollTop to target.top + buffer\r\n            // and change step attachmentTarget to top+.\r\n            scrollTop = targetNode.offset().top - (viewportHeight * 0.2);\r\n        }\r\n\r\n        // Never scroll over the top.\r\n        scrollTop = Math.max(0, scrollTop);\r\n\r\n        // Never scroll beyond the bottom.\r\n        scrollTop = Math.min($(document).height() - viewportHeight, scrollTop);\r\n\r\n        return Math.ceil(scrollTop);\r\n    }\r\n\r\n    /**\r\n     * Calculate dialogue position for page middle.\r\n     *\r\n     * @param {jQuery} currentStepNode Current step node\r\n     * @method  calculateScrollTop\r\n     */\r\n    calculateStepPositionInPage(currentStepNode) {\r\n        let top = MINSPACING;\r\n        const viewportHeight = $(window).height();\r\n        const stepHeight = currentStepNode.height();\r\n        const viewportWidth = $(window).width();\r\n        const stepWidth = currentStepNode.width();\r\n        if (viewportHeight >= (stepHeight + (MINSPACING * 2))) {\r\n            top = Math.ceil((viewportHeight - stepHeight) / 2);\r\n        } else {\r\n            const headerHeight = currentStepNode.find('.modal-header').first().outerHeight() ?? 0;\r\n            const footerHeight = currentStepNode.find('.modal-footer').first().outerHeight() ?? 0;\r\n            const currentStepBody = currentStepNode.find('[data-placeholder=\"body\"]').first();\r\n            const maxHeight = viewportHeight - (MINSPACING * 2) - headerHeight - footerHeight;\r\n            currentStepBody.css({\r\n                'max-height': maxHeight + 'px',\r\n                'overflow': 'auto',\r\n            });\r\n        }\r\n        currentStepNode.offset({\r\n            top: top,\r\n            left: Math.ceil((viewportWidth - stepWidth) / 2)\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Position the step on the page.\r\n     *\r\n     * @method  positionStep\r\n     * @param   {Object}    stepConfig      The step configuration of the step\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    positionStep(stepConfig) {\r\n        let content = this.currentStepNode;\r\n        let thisT = this;\r\n        if (!content || !content.length) {\r\n            // Unable to find the step node.\r\n            return this;\r\n        }\r\n\r\n        stepConfig.placement = this.recalculatePlacement(stepConfig);\r\n        let flipBehavior;\r\n        switch (stepConfig.placement) {\r\n            case 'left':\r\n                flipBehavior = ['left', 'right', 'top', 'bottom'];\r\n                break;\r\n            case 'right':\r\n                flipBehavior = ['right', 'left', 'top', 'bottom'];\r\n                break;\r\n            case 'top':\r\n                flipBehavior = ['top', 'bottom', 'right', 'left'];\r\n                break;\r\n            case 'bottom':\r\n                flipBehavior = ['bottom', 'top', 'right', 'left'];\r\n                break;\r\n            default:\r\n                flipBehavior = 'flip';\r\n                break;\r\n        }\r\n\r\n        let target = this.getStepTarget(stepConfig);\r\n        var config = {\r\n            placement: stepConfig.placement + '-start',\r\n            removeOnDestroy: true,\r\n            modifiers: {\r\n                flip: {\r\n                    behaviour: flipBehavior,\r\n                },\r\n                arrow: {\r\n                    element: '[data-role=\"arrow\"]',\r\n                },\r\n            },\r\n            onCreate: function(data) {\r\n                recalculateArrowPosition(data);\r\n                recalculateStepPosition(data);\r\n            },\r\n            onUpdate: function(data) {\r\n                recalculateArrowPosition(data);\r\n                if (thisT.possitionNeedToBeRecalculated) {\r\n                    thisT.recalculatedNo++;\r\n                    thisT.possitionNeedToBeRecalculated = false;\r\n                    recalculateStepPosition(data);\r\n                }\r\n            },\r\n        };\r\n\r\n        let recalculateArrowPosition = function(data) {\r\n            let placement = data.placement.split('-')[0];\r\n            const isVertical = ['left', 'right'].indexOf(placement) !== -1;\r\n            const arrowElement = data.instance.popper.querySelector('[data-role=\"arrow\"]');\r\n            const stepElement = $(data.instance.popper.querySelector('[data-role=\"flexitour-step\"]'));\r\n            if (isVertical) {\r\n                let arrowHeight = parseFloat(window.getComputedStyle(arrowElement).height);\r\n                let arrowOffset = parseFloat(window.getComputedStyle(arrowElement).top);\r\n                let popperHeight = parseFloat(window.getComputedStyle(data.instance.popper).height);\r\n                let popperOffset = parseFloat(window.getComputedStyle(data.instance.popper).top);\r\n                let popperBorderWidth = parseFloat(stepElement.css('borderTopWidth'));\r\n                let popperBorderRadiusWidth = parseFloat(stepElement.css('borderTopLeftRadius')) * 2;\r\n                let arrowPos = arrowOffset + (arrowHeight / 2);\r\n                let maxPos = popperHeight + popperOffset - popperBorderWidth - popperBorderRadiusWidth;\r\n                let minPos = popperOffset + popperBorderWidth + popperBorderRadiusWidth;\r\n                if (arrowPos >= maxPos || arrowPos <= minPos) {\r\n                    let newArrowPos = 0;\r\n                    if (arrowPos > (popperHeight / 2)) {\r\n                        newArrowPos = maxPos - arrowHeight;\r\n                    } else {\r\n                        newArrowPos = minPos + arrowHeight;\r\n                    }\r\n                    $(arrowElement).css('top', newArrowPos);\r\n                }\r\n            } else {\r\n                let arrowWidth = parseFloat(window.getComputedStyle(arrowElement).width);\r\n                let arrowOffset = parseFloat(window.getComputedStyle(arrowElement).left);\r\n                let popperWidth = parseFloat(window.getComputedStyle(data.instance.popper).width);\r\n                let popperOffset = parseFloat(window.getComputedStyle(data.instance.popper).left);\r\n                let popperBorderWidth = parseFloat(stepElement.css('borderTopWidth'));\r\n                let popperBorderRadiusWidth = parseFloat(stepElement.css('borderTopLeftRadius')) * 2;\r\n                let arrowPos = arrowOffset + (arrowWidth / 2);\r\n                let maxPos = popperWidth + popperOffset - popperBorderWidth - popperBorderRadiusWidth;\r\n                let minPos = popperOffset + popperBorderWidth + popperBorderRadiusWidth;\r\n                if (arrowPos >= maxPos || arrowPos <= minPos) {\r\n                    let newArrowPos = 0;\r\n                    if (arrowPos > (popperWidth / 2)) {\r\n                        newArrowPos = maxPos - arrowWidth;\r\n                    } else {\r\n                        newArrowPos = minPos + arrowWidth;\r\n                    }\r\n                    $(arrowElement).css('left', newArrowPos);\r\n                }\r\n            }\r\n        };\r\n\r\n        const recalculateStepPosition = function(data) {\r\n            const placement = data.placement.split('-')[0];\r\n            const isVertical = ['left', 'right'].indexOf(placement) !== -1;\r\n            const popperElement = $(data.instance.popper);\r\n            const targetElement = $(data.instance.reference);\r\n            const arrowElement = popperElement.find('[data-role=\"arrow\"]');\r\n            const stepElement = popperElement.find('[data-role=\"flexitour-step\"]');\r\n            const viewportHeight = $(window).height();\r\n            const viewportWidth = $(window).width();\r\n            const arrowHeight = parseFloat(arrowElement.outerHeight(true));\r\n            const popperHeight = parseFloat(popperElement.outerHeight(true));\r\n            const targetHeight = parseFloat(targetElement.outerHeight(true));\r\n            const arrowWidth = parseFloat(arrowElement.outerWidth(true));\r\n            const popperWidth = parseFloat(popperElement.outerWidth(true));\r\n            const targetWidth = parseFloat(targetElement.outerWidth(true));\r\n            let maxHeight;\r\n\r\n            if (thisT.recalculatedNo > 1) {\r\n                // The current screen is too small, and cannot fit with the original placement.\r\n                // We should set the placement to auto so the PopperJS can calculate the perfect placement.\r\n                thisT.currentStepPopper.options.placement = isVertical ? 'auto-left' : 'auto-bottom';\r\n            }\r\n            if (thisT.recalculatedNo > 2) {\r\n                // Return here to prevent recursive calling.\r\n                return;\r\n            }\r\n\r\n            if (isVertical) {\r\n                // Find the best place to put the tour: Left of right.\r\n                const leftSpace = targetElement.offset().left > 0 ? targetElement.offset().left : 0;\r\n                const rightSpace = viewportWidth - leftSpace - targetWidth;\r\n                const remainingSpace = leftSpace >= rightSpace ? leftSpace : rightSpace;\r\n                maxHeight = viewportHeight - MINSPACING * 2;\r\n                if (remainingSpace < (popperWidth + arrowWidth)) {\r\n                    const maxWidth = remainingSpace - MINSPACING - arrowWidth;\r\n                    if (maxWidth > 0) {\r\n                        popperElement.css({\r\n                            'max-width': maxWidth + 'px',\r\n                        });\r\n                        // Not enough space, flag true to make Popper to recalculate the position.\r\n                        thisT.possitionNeedToBeRecalculated = true;\r\n                    }\r\n                } else if (maxHeight < popperHeight) {\r\n                    // Check if the Popper's height can fit the viewport height or not.\r\n                    // If not, set the correct max-height value for the Popper element.\r\n                    popperElement.css({\r\n                        'max-height': maxHeight + 'px',\r\n                    });\r\n                }\r\n            } else {\r\n                // Find the best place to put the tour: Top of bottom.\r\n                const topSpace = targetElement.offset().top > 0 ? targetElement.offset().top : 0;\r\n                const bottomSpace = viewportHeight - topSpace - targetHeight;\r\n                const remainingSpace = topSpace >= bottomSpace ? topSpace : bottomSpace;\r\n                maxHeight = remainingSpace - MINSPACING - arrowHeight;\r\n                if (remainingSpace < (popperHeight + arrowHeight)) {\r\n                    // Not enough space, flag true to make Popper to recalculate the position.\r\n                    thisT.possitionNeedToBeRecalculated = true;\r\n                }\r\n            }\r\n\r\n            // Check if the Popper's height can fit the viewport height or not.\r\n            // If not, set the correct max-height value for the body.\r\n            const currentStepBody = stepElement.find('[data-placeholder=\"body\"]').first();\r\n            const headerEle = stepElement.find('.modal-header').first();\r\n            const footerEle = stepElement.find('.modal-footer').first();\r\n            const headerHeight = headerEle.outerHeight(true) ?? 0;\r\n            const footerHeight = footerEle.outerHeight(true) ?? 0;\r\n            maxHeight = maxHeight - headerHeight - footerHeight;\r\n            if (maxHeight > 0) {\r\n                headerEle.removeClass('minimal');\r\n                footerEle.removeClass('minimal');\r\n                currentStepBody.css({\r\n                    'max-height': maxHeight + 'px',\r\n                    'overflow': 'auto',\r\n                });\r\n            } else {\r\n                headerEle.addClass('minimal');\r\n                footerEle.addClass('minimal');\r\n            }\r\n            // Call the Popper update method to update the position.\r\n            thisT.currentStepPopper.update();\r\n        };\r\n\r\n        let background = $('[data-flexitour=\"step-background\"]');\r\n        if (background.length) {\r\n            target = background;\r\n        }\r\n        this.currentStepPopper = new Popper(target, content[0], config);\r\n\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * For left/right placement, checks that there is room for the step at current window size.\r\n     *\r\n     * If there is not enough room, changes placement to 'top'.\r\n     *\r\n     * @method  recalculatePlacement\r\n     * @param   {Object}    stepConfig      The step configuration of the step\r\n     * @return  {String}                    The placement after recalculate\r\n     */\r\n    recalculatePlacement(stepConfig) {\r\n        const buffer = 10;\r\n        const arrowWidth = 16;\r\n        let target = this.getStepTarget(stepConfig);\r\n        let widthContent = this.currentStepNode.width() + arrowWidth;\r\n        let targetOffsetLeft = target.offset().left - buffer;\r\n        let targetOffsetRight = target.offset().left + target.width() + buffer;\r\n        let placement = stepConfig.placement;\r\n\r\n        if (['left', 'right'].indexOf(placement) !== -1) {\r\n            if ((targetOffsetLeft < (widthContent + buffer)) &&\r\n                ((targetOffsetRight + widthContent + buffer) > document.documentElement.clientWidth)) {\r\n                placement = 'top';\r\n            }\r\n        }\r\n        return placement;\r\n    }\r\n\r\n    /**\r\n     * Add the backdrop.\r\n     *\r\n     * @method  positionBackdrop\r\n     * @param   {Object}    stepConfig      The step configuration of the step\r\n     * @chainable\r\n     * @return {Object} this.\r\n     */\r\n    positionBackdrop(stepConfig) {\r\n        if (stepConfig.backdrop) {\r\n            this.currentStepConfig.hasBackdrop = true;\r\n            let backdrop = $('<div data-flexitour=\"backdrop\"></div>');\r\n\r\n            if (stepConfig.zIndex) {\r\n                if (stepConfig.attachPoint === 'append') {\r\n                    stepConfig.attachTo.append(backdrop);\r\n                } else {\r\n                    backdrop.insertAfter(stepConfig.attachTo);\r\n                }\r\n            } else {\r\n                $('body').append(backdrop);\r\n            }\r\n\r\n            if (this.isStepActuallyVisible(stepConfig)) {\r\n                // The step has a visible target.\r\n                // Punch a hole through the backdrop.\r\n                let background = $('[data-flexitour=\"step-background\"]');\r\n                if (!background.length) {\r\n                    background = $('<div data-flexitour=\"step-background\"></div>');\r\n                }\r\n\r\n                let targetNode = this.getStepTarget(stepConfig);\r\n\r\n                let buffer = 10;\r\n\r\n                let colorNode = targetNode;\r\n                if (buffer) {\r\n                    colorNode = $('body');\r\n                }\r\n\r\n                let drawertop = 0;\r\n                if (targetNode.parents('[data-usertour=\"scroller\"]').length) {\r\n                    const scrollerElement = targetNode.parents('[data-usertour=\"scroller\"]');\r\n                    const navigationBuffer = scrollerElement.offset().top;\r\n                    if (scrollerElement.scrollTop() >= navigationBuffer) {\r\n                        drawertop = scrollerElement.scrollTop() - navigationBuffer;\r\n                        background.css({\r\n                            position: 'fixed'\r\n                        });\r\n                    }\r\n                }\r\n\r\n                background.css({\r\n                    width: targetNode.outerWidth() + buffer + buffer,\r\n                    height: targetNode.outerHeight() + buffer + buffer,\r\n                    left: targetNode.offset().left - buffer,\r\n                    top: targetNode.offset().top + drawertop - buffer,\r\n                    backgroundColor: this.calculateInherittedBackgroundColor(colorNode),\r\n                });\r\n\r\n                if (targetNode.offset().left < buffer) {\r\n                    background.css({\r\n                        width: targetNode.outerWidth() + targetNode.offset().left + buffer,\r\n                        left: targetNode.offset().left,\r\n                    });\r\n                }\r\n\r\n                if ((targetNode.offset().top + drawertop) < buffer) {\r\n                    background.css({\r\n                        height: targetNode.outerHeight() + targetNode.offset().top + buffer,\r\n                        top: targetNode.offset().top,\r\n                    });\r\n                }\r\n\r\n                let targetRadius = targetNode.css('borderRadius');\r\n                if (targetRadius && targetRadius !== $('body').css('borderRadius')) {\r\n                    background.css('borderRadius', targetRadius);\r\n                }\r\n\r\n                let targetPosition = this.calculatePosition(targetNode);\r\n                if (targetPosition === 'absolute') {\r\n                    background.css('position', 'fixed');\r\n                }\r\n\r\n                let fader = background.clone();\r\n                fader.css({\r\n                    backgroundColor: backdrop.css('backgroundColor'),\r\n                    opacity: backdrop.css('opacity'),\r\n                });\r\n                fader.attr('data-flexitour', 'step-background-fader');\r\n\r\n                if (!stepConfig.zIndex) {\r\n                    let targetClone = targetNode.clone();\r\n                    background.append(targetClone.first());\r\n                    $('body').append(fader);\r\n                    $('body').append(background);\r\n                } else {\r\n                    if (stepConfig.attachPoint === 'append') {\r\n                        stepConfig.attachTo.append(background);\r\n                    } else {\r\n                        fader.insertAfter(stepConfig.attachTo);\r\n                        background.insertAfter(stepConfig.attachTo);\r\n                    }\r\n                }\r\n\r\n                // Add the backdrop data to the actual target.\r\n                // This is the part which actually does the work.\r\n                targetNode.attr('data-flexitour', 'step-backdrop');\r\n\r\n                if (stepConfig.zIndex) {\r\n                    backdrop.css('zIndex', stepConfig.zIndex);\r\n                    background.css('zIndex', stepConfig.zIndex + 1);\r\n                    targetNode.css('zIndex', stepConfig.zIndex + 2);\r\n                }\r\n\r\n                fader.fadeOut('2000', function() {\r\n                    $(this).remove();\r\n                });\r\n            }\r\n        }\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * Calculate the inheritted z-index.\r\n     *\r\n     * @method  calculateZIndex\r\n     * @param   {jQuery}    elem                        The element to calculate z-index for\r\n     * @return  {Number}                                Calculated z-index\r\n     */\r\n    calculateZIndex(elem) {\r\n        elem = $(elem);\r\n        if (this.requireDefaultTourZindex(elem)) {\r\n            return 0;\r\n        }\r\n        while (elem.length && elem[0] !== document) {\r\n            // Ignore z-index if position is set to a value where z-index is ignored by the browser\r\n            // This makes behavior of this function consistent across browsers\r\n            // WebKit always returns auto if the element is positioned.\r\n            let position = elem.css(\"position\");\r\n            if (position === \"absolute\" || position === \"fixed\") {\r\n                // IE returns 0 when zIndex is not specified\r\n                // other browsers return a string\r\n                // we ignore the case of nested elements with an explicit value of 0\r\n                // <div style=\"z-index: -10;\"><div style=\"z-index: 0;\"></div></div>\r\n                let value = parseInt(elem.css(\"zIndex\"), 10);\r\n                if (!isNaN(value) && value !== 0) {\r\n                    return value;\r\n                }\r\n            }\r\n            elem = elem.parent();\r\n        }\r\n\r\n        return 0;\r\n    }\r\n\r\n    /**\r\n     * Check if the element require the default tour z-index.\r\n     *\r\n     * Some page elements have fixed z-index. However, their weight is not enough to cover\r\n     * other page elements like the top navbar or a sticky footer so they use the default\r\n     * tour z-index instead.\r\n     *\r\n     * @param {jQuery} elem the page element to highlight\r\n     * @return {Boolean} true if the element requires the default tour z-index instead of the calculated one\r\n     */\r\n    requireDefaultTourZindex(elem) {\r\n        if (elem.parents('[data-region=\"fixed-drawer\"]').length !== 0) {\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Calculate the inheritted background colour.\r\n     *\r\n     * @method  calculateInherittedBackgroundColor\r\n     * @param   {jQuery}    elem                        The element to calculate colour for\r\n     * @return  {String}                                Calculated background colour\r\n     */\r\n    calculateInherittedBackgroundColor(elem) {\r\n        // Use a fake node to compare each element against.\r\n        let fakeNode = $('<div>').hide();\r\n        $('body').append(fakeNode);\r\n        let fakeElemColor = fakeNode.css('backgroundColor');\r\n        fakeNode.remove();\r\n\r\n        elem = $(elem);\r\n        while (elem.length && elem[0] !== document) {\r\n            let color = elem.css('backgroundColor');\r\n            if (color !== fakeElemColor) {\r\n                return color;\r\n            }\r\n            elem = elem.parent();\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Calculate the inheritted position.\r\n     *\r\n     * @method  calculatePosition\r\n     * @param   {jQuery}    elem                        The element to calculate position for\r\n     * @return  {String}                                Calculated position\r\n     */\r\n    calculatePosition(elem) {\r\n        elem = $(elem);\r\n        while (elem.length && elem[0] !== document) {\r\n            let position = elem.css('position');\r\n            if (position !== 'static') {\r\n                return position;\r\n            }\r\n            elem = elem.parent();\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Perform accessibility changes for step shown.\r\n     *\r\n     * This will add aria-hidden=\"true\" to all siblings and parent siblings.\r\n     *\r\n     * @method  accessibilityShow\r\n     */\r\n    accessibilityShow() {\r\n        let stateHolder = 'data-has-hidden';\r\n        let attrName = 'aria-hidden';\r\n        let hideFunction = function(child) {\r\n            let flexitourRole = child.data('flexitour');\r\n            if (flexitourRole) {\r\n                switch (flexitourRole) {\r\n                    case 'container':\r\n                    case 'target':\r\n                        return;\r\n                }\r\n            }\r\n\r\n            let hidden = child.attr(attrName);\r\n            if (!hidden) {\r\n                child.attr(stateHolder, true);\r\n                Aria.hide(child);\r\n            }\r\n        };\r\n\r\n        this.currentStepNode.siblings().each(function(index, node) {\r\n            hideFunction($(node));\r\n        });\r\n        this.currentStepNode.parentsUntil('body').siblings().each(function(index, node) {\r\n            hideFunction($(node));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Perform accessibility changes for step hidden.\r\n     *\r\n     * This will remove any newly added aria-hidden=\"true\".\r\n     *\r\n     * @method  accessibilityHide\r\n     */\r\n    accessibilityHide() {\r\n        let stateHolder = 'data-has-hidden';\r\n        let showFunction = function(child) {\r\n            let hidden = child.attr(stateHolder);\r\n            if (typeof hidden !== 'undefined') {\r\n                child.removeAttr(stateHolder);\r\n                Aria.unhide(child);\r\n            }\r\n        };\r\n\r\n        $('[' + stateHolder + ']').each(function(index, node) {\r\n            showFunction($(node));\r\n        });\r\n    }\r\n};\r\n\r\nexport default Tour;\r\n"],"names":["_getRequireWildcardCache","e","WeakMap","r","t","_interopRequireDefault","__esModule","default","_jquery","Aria","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","_popper","_pending","_exports","tourRunning","constructor","config","this","init","eventHandlers","reset","originalConfiguration","configure","apply","arguments","possitionNeedToBeRecalculated","recalculatedNo","storage","window","sessionStorage","storageKey","tourName","prefetchStrings","hide","resetStepListeners","steps","currentStepNumber","eventName","forEach","handler","addEventHandler","resetStepDefaults","template","templateContent","checkMinimumRequirements","Error","length","loadOriginalConfiguration","stepDefaults","setStepDefaults","$","extend","element","placement","delay","moveOnClick","moveAfterTime","orphan","direction","getCurrentStepNumber","parseInt","setCurrentStepNumber","stepNumber","setItem","code","DOMException","QUOTA_EXCEEDED_ERR","removeItem","getNextStepNumber","nextStepNumber","isStepPotentiallyVisible","getStepConfig","getPreviousStepNumber","previousStepNumber","isLastStep","stepConfig","isStepActuallyVisible","getPotentiallyVisibleSteps","position","result","stepId","stepid","isCSSAllowed","target","getStepTarget","is","testCSSElement","document","createElement","classList","add","body","appendChild","isAllowed","getComputedStyle","display","remove","next","gotoStep","previous","endTour","_gotoStep","pendingPromise","PendingPromise","delayed","setTimeout","resolve","fn","dispatchEvent","eventTypes","stepRender","defaultPrevented","renderStep","stepRendered","normalizeStepConfig","reflex","moveAfterClick","content","attachTo","attachPoint","first","detail","undefined","cancelable","tour","push","processStepListeners","listeners","node","currentStepNode","args","proxy","handleKeyDown","targetNode","parents","listener","on","off","currentStepConfig","getTemplateContent","find","html","title","nextBtn","endBtn","removeClass","addClass","prop","getString","then","value","catch","attr","displaystepnumbers","stepsPotentiallyVisible","totalStepsPotentiallyVisible","total","addStepToPage","clone","notifyFilterContentUpdated","animationTarget","stop","data","zIndex","calculateZIndex","css","positionBackdrop","append","top","left","animate","scrollTop","calculateScrollTop","promise","positionStep","revealStep","bind","isOrphan","currentStepPopper","Popper","removeOnDestroy","arrowElement","modifiers","enabled","applyStyle","onLoad","onCreate","images","calculateStepPositionInPage","fadeIn","announceStep","focus","bodyRegion","headerRegion","accessibilityShow","tabbableSelector","keyCode","hasBackdrop","currentIndex","nextIndex","nextNode","focusRelevant","activeElement","stepTarget","tabbableNodes","dialogContainer","filter","index","each","shiftKey","closest","last","preventDefault","startTour","startAt","storageStartValue","getItem","storageStartAt","tourStart","tourStarted","restartTour","tourEnd","previousTarget","tourEnded","transition","stepHide","destroy","removeAttr","backdrop","backdropRemovalPromise","fadeOut","currentStepElement","accessibilityHide","stepHidden","show","getStepContainer","viewportHeight","height","scrollParent","offset","Math","max","min","ceil","stepHeight","viewportWidth","width","stepWidth","MINSPACING","maxHeight","outerHeight","overflow","flipBehavior","thisT","recalculatePlacement","flip","behaviour","arrow","recalculateArrowPosition","recalculateStepPosition","onUpdate","split","isVertical","indexOf","instance","popper","querySelector","stepElement","arrowHeight","parseFloat","arrowOffset","popperHeight","popperOffset","popperBorderWidth","popperBorderRadiusWidth","arrowPos","maxPos","minPos","newArrowPos","arrowWidth","popperWidth","popperElement","targetElement","reference","targetHeight","outerWidth","targetWidth","options","leftSpace","rightSpace","remainingSpace","maxWidth","topSpace","bottomSpace","currentStepBody","headerEle","footerEle","update","background","widthContent","targetOffsetLeft","targetOffsetRight","documentElement","clientWidth","insertAfter","buffer","colorNode","drawertop","scrollerElement","navigationBuffer","backgroundColor","calculateInherittedBackgroundColor","targetRadius","calculatePosition","fader","opacity","targetClone","elem","requireDefaultTourZindex","isNaN","parent","fakeNode","fakeElemColor","color","hideFunction","child","flexitourRole","siblings","parentsUntil","unhide"],"mappings":"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"}