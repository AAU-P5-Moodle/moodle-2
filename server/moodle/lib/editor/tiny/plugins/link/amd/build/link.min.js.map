{"version":3,"file":"link.min.js","sources":["../src/link.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Link helper for Tiny Link plugin.\r\n *\r\n * @module      tiny_link/link\r\n * @copyright   2023 Huong Nguyen <huongnv13@gmail.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Templates from 'core/templates';\r\nimport Pending from 'core/pending';\r\nimport Selectors from 'tiny_link/selectors';\r\n\r\n/**\r\n * Handle insertion of a new link, or update of an existing one.\r\n *\r\n * @param {Element} currentForm\r\n * @param {TinyMCE} editor\r\n */\r\nexport const setLink = (currentForm, editor) => {\r\n    const input = currentForm.querySelector(Selectors.elements.urlEntry);\r\n    let value = input.value;\r\n\r\n    if (value !== '') {\r\n        const pendingPromise = new Pending('tiny_link/setLink');\r\n        // We add a prefix if it is not already prefixed.\r\n        value = value.trim();\r\n        const expr = new RegExp(/^[a-zA-Z]*\\.*\\/|^#|^[a-zA-Z]*:/);\r\n        if (!expr.test(value)) {\r\n            value = 'http://' + value;\r\n        }\r\n\r\n        // Add the link.\r\n        setLinkOnSelection(currentForm, editor, value).then(pendingPromise.resolve);\r\n    }\r\n};\r\n\r\n/**\r\n * Handle unlink of a link\r\n *\r\n * @param {TinyMCE} editor\r\n */\r\nexport const unSetLink = (editor) => {\r\n    if (editor.hasPlugin('rtc', true)) {\r\n        editor.execCommand('unlink');\r\n    } else {\r\n        const dom = editor.dom;\r\n        const selection = editor.selection;\r\n        const bookmark = selection.getBookmark();\r\n        const rng = selection.getRng().cloneRange();\r\n        const startAnchorElm = dom.getParent(rng.startContainer, 'a[href]', editor.getBody());\r\n        const endAnchorElm = dom.getParent(rng.endContainer, 'a[href]', editor.getBody());\r\n        if (startAnchorElm) {\r\n            rng.setStartBefore(startAnchorElm);\r\n        }\r\n        if (endAnchorElm) {\r\n            rng.setEndAfter(endAnchorElm);\r\n        }\r\n        selection.setRng(rng);\r\n        editor.execCommand('unlink');\r\n        selection.moveToBookmark(bookmark);\r\n    }\r\n};\r\n\r\n/**\r\n * Final step setting the anchor on the selection.\r\n *\r\n * @param {Element} currentForm\r\n * @param {TinyMCE} editor\r\n * @param {String} url URL the link will point to.\r\n */\r\nconst setLinkOnSelection = async(currentForm, editor, url) => {\r\n    const urlText = currentForm.querySelector(Selectors.elements.urlText);\r\n    const target = currentForm.querySelector(Selectors.elements.openInNewWindow);\r\n    let textToDisplay = urlText.value.replace(/(<([^>]+)>)/gi, \"\").trim();\r\n\r\n    if (textToDisplay === '') {\r\n        textToDisplay = url;\r\n    }\r\n\r\n    const context = {\r\n        url: url,\r\n        newwindow: target.checked,\r\n    };\r\n    if (urlText.getAttribute('data-link-on-element')) {\r\n        context.title = textToDisplay;\r\n        context.name = editor.selection.getNode().outerHTML;\r\n    } else {\r\n        context.name = textToDisplay;\r\n    }\r\n    const {html} = await Templates.renderForPromise('tiny_link/embed_link', context);\r\n    const currentLink = getSelectedLink(editor);\r\n    if (currentLink) {\r\n        currentLink.outerHTML = html;\r\n    } else {\r\n        editor.insertContent(html);\r\n    }\r\n};\r\n\r\n/**\r\n * Get current link data.\r\n *\r\n * @param {TinyMCE} editor\r\n * @returns {{}}\r\n */\r\nexport const getCurrentLinkData = (editor) => {\r\n    let properties = {};\r\n    const link = getSelectedLink(editor);\r\n    if (link) {\r\n        const url = link.getAttribute('href');\r\n        const target = link.getAttribute('target');\r\n        const textToDisplay = link.innerText;\r\n        const title = link.getAttribute('title');\r\n\r\n        if (url !== '') {\r\n            properties.url = url;\r\n        }\r\n        if (target === '_blank') {\r\n            properties.newwindow = true;\r\n        }\r\n        if (title && title !== '') {\r\n            properties.urltext = title.trim();\r\n        } else if (textToDisplay !== '') {\r\n            properties.urltext = textToDisplay.trim();\r\n        }\r\n    } else {\r\n        // Check if the user is selecting some text before clicking on the Link button.\r\n        const selectedNode = editor.selection.getNode();\r\n        if (selectedNode) {\r\n            const textToDisplay = getTextSelection(editor);\r\n            if (textToDisplay !== '') {\r\n                properties.urltext = textToDisplay.trim();\r\n                properties.hasTextToDisplay = true;\r\n                properties.hasPlainTextSelected = true;\r\n            } else {\r\n                if (selectedNode.getAttribute('data-mce-selected')) {\r\n                    properties.setLinkOnElement = true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return properties;\r\n};\r\n\r\n/**\r\n * Get selected link.\r\n *\r\n * @param {TinyMCE} editor\r\n * @returns {Element}\r\n */\r\nconst getSelectedLink = (editor) => {\r\n    return getAnchorElement(editor);\r\n};\r\n\r\n/**\r\n * Get anchor element.\r\n *\r\n * @param {TinyMCE} editor\r\n * @param {Element} selectedElm\r\n * @returns {Element}\r\n */\r\nconst getAnchorElement = (editor, selectedElm) => {\r\n    selectedElm = selectedElm || editor.selection.getNode();\r\n    return editor.dom.getParent(selectedElm, 'a[href]');\r\n};\r\n\r\n/**\r\n * Get only the selected text.\r\n * In some cases, window.getSelection() is not run as expected. We should only get the text value\r\n * For ex: <img src=\"\" alt=\"XYZ\">Some text here\r\n *          window.getSelection() will return XYZSome text here\r\n *\r\n * @param {TinyMCE} editor\r\n * @return {string} Selected text\r\n */\r\nconst getTextSelection = (editor) => {\r\n    let selText = '';\r\n    const sel = editor.selection.getSel();\r\n    const rangeCount = sel.rangeCount;\r\n    if (rangeCount) {\r\n        let rangeTexts = [];\r\n        for (let i = 0; i < rangeCount; ++i) {\r\n            rangeTexts.push('' + sel.getRangeAt(i));\r\n        }\r\n        selText = rangeTexts.join('');\r\n    }\r\n\r\n    return selText;\r\n};\r\n\r\n/**\r\n * Check the current selected element is an anchor or not.\r\n *\r\n * @param {TinyMCE} editor\r\n * @param {Element} selectedElm\r\n * @returns {boolean}\r\n */\r\nconst isInAnchor = (editor, selectedElm) => getAnchorElement(editor, selectedElm) !== null;\r\n\r\n/**\r\n * Change state of button.\r\n *\r\n * @param {TinyMCE} editor\r\n * @param {function()} toggler\r\n * @returns {function()}\r\n */\r\nconst toggleState = (editor, toggler) => {\r\n    editor.on('NodeChange', toggler);\r\n    return () => editor.off('NodeChange', toggler);\r\n};\r\n\r\n/**\r\n * Change the active state of button.\r\n *\r\n * @param {TinyMCE} editor\r\n * @returns {function(*): function(): *}\r\n */\r\nexport const toggleActiveState = (editor) => (api) => {\r\n    const updateState = () => api.setActive(!editor.mode.isReadOnly() && isInAnchor(editor, editor.selection.getNode()));\r\n    updateState();\r\n    return toggleState(editor, updateState);\r\n};\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_templates","_pending","_selectors","_exports","setLink","currentForm","editor","value","querySelector","Selectors","elements","urlEntry","pendingPromise","Pending","trim","RegExp","test","setLinkOnSelection","then","resolve","unSetLink","hasPlugin","execCommand","dom","selection","bookmark","getBookmark","rng","getRng","cloneRange","startAnchorElm","getParent","startContainer","getBody","endAnchorElm","endContainer","setStartBefore","setEndAfter","setRng","moveToBookmark","async","url","urlText","target","openInNewWindow","textToDisplay","replace","context","newwindow","checked","getAttribute","title","name","getNode","outerHTML","html","Templates","renderForPromise","currentLink","getSelectedLink","insertContent","getCurrentLinkData","properties","link","innerText","urltext","selectedNode","getTextSelection","hasTextToDisplay","hasPlainTextSelected","setLinkOnElement","getAnchorElement","selectedElm","selText","sel","getSel","rangeCount","rangeTexts","i","push","getRangeAt","join","toggleActiveState","api","updateState","setActive","mode","isReadOnly","isInAnchor","toggleState","toggler","on","off"],"mappings":"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"}