{"version":3,"file":"usedfiles.min.js","sources":["../src/usedfiles.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny Media Manager usedfiles.\r\n *\r\n * @module      tiny_media/usedfiles\r\n * @copyright   2022, Stevani Andolo <stevani@hotmail.com.au>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport * as Templates from 'core/templates';\r\nimport Config from 'core/config';\r\n\r\nclass UsedFileManager {\r\n    constructor(files, userContext, itemId, elementId) {\r\n        this.files = files;\r\n        this.userContext = userContext;\r\n        this.itemId = itemId;\r\n        this.elementId = elementId;\r\n    }\r\n\r\n    getElementId() {\r\n        return this.elementId;\r\n    }\r\n\r\n    getUsedFiles() {\r\n        const editor = window.parent.tinymce.EditorManager.get(this.getElementId());\r\n        if (!editor) {\r\n            window.console.error(`Editor not found for ${this.getElementId()}`);\r\n            return [];\r\n        }\r\n        const content = editor.getContent();\r\n        const baseUrl = `${Config.wwwroot}/draftfile.php/${this.userContext}/user/draft/${this.itemId}/`;\r\n        const pattern = new RegExp(\"[\\\"']\" + baseUrl.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&') + \"(?<filename>.+?)[\\\\?\\\"']\", 'gm');\r\n\r\n        const usedFiles = [...content.matchAll(pattern)].map((match) => decodeURIComponent(match.groups.filename));\r\n\r\n        return usedFiles;\r\n    }\r\n\r\n    // Return an array of unused files.\r\n    findUnusedFiles(usedFiles) {\r\n        return Object.entries(this.files)\r\n            .filter(([filename]) => !usedFiles.includes(filename))\r\n            .map(([filename]) => filename);\r\n    }\r\n\r\n    // Return an array of missing files.\r\n    findMissingFiles(usedFiles) {\r\n        return usedFiles.filter((filename) => !this.files.hasOwnProperty(filename));\r\n    }\r\n\r\n    updateFiles() {\r\n        const form = document.querySelector('form');\r\n        const usedFiles = this.getUsedFiles();\r\n        const unusedFiles = this.findUnusedFiles(usedFiles);\r\n        const missingFiles = this.findMissingFiles(usedFiles);\r\n\r\n        form.querySelectorAll('input[type=checkbox][name^=\"deletefile\"]').forEach((checkbox) => {\r\n            if (!unusedFiles.includes(checkbox.dataset.filename)) {\r\n                checkbox.closest('.fitem').remove();\r\n            }\r\n        });\r\n\r\n        form.classList.toggle('has-missing-files', !!missingFiles.length);\r\n        form.classList.toggle('has-unused-files', !!unusedFiles.length);\r\n\r\n        return Templates.renderForPromise('tiny_media/missingfiles', {\r\n            missingFiles,\r\n        }).then(({html, js}) => {\r\n            Templates.replaceNodeContents(form.querySelector('.missing-files'), html, js);\r\n            return;\r\n        });\r\n    }\r\n}\r\n\r\nexport const init = (files, usercontext, itemid, elementid) => {\r\n    const manager = new UsedFileManager(files, usercontext, itemid, elementid);\r\n    manager.updateFiles();\r\n\r\n    return manager;\r\n};\r\n"],"names":["e","_getRequireWildcardCache","WeakMap","r","t","Templates","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","_config","UsedFileManager","constructor","files","userContext","itemId","elementId","this","getElementId","getUsedFiles","editor","window","parent","tinymce","EditorManager","console","error","content","getContent","baseUrl","Config","wwwroot","pattern","RegExp","replace","matchAll","map","match","decodeURIComponent","groups","filename","findUnusedFiles","usedFiles","entries","filter","_ref","includes","_ref2","findMissingFiles","updateFiles","form","document","querySelector","unusedFiles","missingFiles","querySelectorAll","forEach","checkbox","dataset","closest","remove","classList","toggle","length","renderForPromise","then","_ref3","html","js","replaceNodeContents","_exports","init","usercontext","itemid","elementid","manager"],"mappings":"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"}