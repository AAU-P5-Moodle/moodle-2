{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny H5P Content configuration.\r\n *\r\n * @module      tiny_h5p/ui\r\n * @copyright   2022 Andrew Lyons <andrew@nicols.co.uk>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {displayFilepicker} from 'editor_tiny/utils';\r\nimport {component} from './common';\r\nimport {getPermissions} from './options';\r\n\r\nimport Config from 'core/config';\r\nimport {getList} from 'core/normalise';\r\nimport {renderForPromise} from 'core/templates';\r\nimport Modal from 'tiny_h5p/modal';\r\nimport ModalEvents from 'core/modal_events';\r\nimport Pending from 'core/pending';\r\nimport {getFilePicker} from 'editor_tiny/options';\r\n\r\nlet openingSelection = null;\r\n\r\nexport const handleAction = (editor) => {\r\n    openingSelection = editor.selection.getBookmark();\r\n    displayDialogue(editor);\r\n};\r\n\r\n/**\r\n * Get the template context for the dialogue.\r\n *\r\n * @param {Editor} editor\r\n * @param {object} data\r\n * @returns {object} data\r\n */\r\nconst getTemplateContext = (editor, data) => {\r\n    const permissions = getPermissions(editor);\r\n\r\n    const canShowFilePicker = typeof getFilePicker(editor, 'h5p') !== 'undefined';\r\n    const canUpload = (permissions.upload && canShowFilePicker) ?? false;\r\n    const canEmbed = permissions.embed ?? false;\r\n    const canUploadAndEmbed = canUpload && canEmbed;\r\n\r\n    return Object.assign({}, {\r\n        elementid: editor.id,\r\n        canUpload,\r\n        canEmbed,\r\n        canUploadAndEmbed,\r\n        showOptions: false,\r\n        fileURL: data?.url ?? '',\r\n    }, data);\r\n};\r\n\r\n/**\r\n * Get the URL from the submitted form.\r\n *\r\n * @param {FormNode} form\r\n * @param {string} submittedUrl\r\n * @returns {URL|null}\r\n */\r\nconst getUrlFromSubmission = (form, submittedUrl) => {\r\n    if (!submittedUrl || (!submittedUrl.startsWith(Config.wwwroot) && !isValidUrl(submittedUrl))) {\r\n        return null;\r\n    }\r\n\r\n    // Generate a URL Object for the submitted URL.\r\n    const url = new URL(submittedUrl);\r\n\r\n    const downloadElement = form.querySelector('[name=\"download\"]');\r\n    if (downloadElement?.checked) {\r\n        url.searchParams.append('export', 1);\r\n    }\r\n\r\n    const embedElement = form.querySelector('[name=\"embed\"]');\r\n    if (embedElement?.checked) {\r\n        url.searchParams.append('embed', 1);\r\n    }\r\n\r\n    const copyrightElement = form.querySelector('[name=\"copyright\"]');\r\n    if (copyrightElement?.checked) {\r\n        url.searchParams.append('copyright', 1);\r\n    }\r\n\r\n    return url;\r\n};\r\n\r\n/**\r\n * Verify if this could be a h5p URL.\r\n *\r\n * @param {string} url Url to verify\r\n * @return {boolean} whether this is a valid URL.\r\n */\r\nconst isValidUrl = (url) => {\r\n    const pattern = new RegExp('^(https?:\\\\/\\\\/)?' + // Protocol.\r\n        '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|' + // Domain name.\r\n        '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))' + // OR ip (v4) address.\r\n        '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'); // Port and path.\r\n    return !!pattern.test(url);\r\n};\r\n\r\nconst handleDialogueSubmission = async(editor, modal, data) => {\r\n    const pendingPromise = new Pending('tiny_h5p:handleDialogueSubmission');\r\n\r\n    const form = getList(modal.getRoot())[0].querySelector('form');\r\n    if (!form) {\r\n        // The form couldn't be found, which is weird.\r\n        // This should not happen.\r\n        // Display the dialogue again.\r\n        modal.destroy();\r\n        displayDialogue(editor, Object.assign({}, data));\r\n        pendingPromise.resolve();\r\n        return;\r\n    }\r\n\r\n    // Get the URL from the submitted form.\r\n    const submittedUrl = form.querySelector('input[name=\"url\"]').value;\r\n    const url = getUrlFromSubmission(form, submittedUrl);\r\n\r\n    if (!url) {\r\n        // The URL is invalid.\r\n        // Fill it in and represent the dialogue with an error.\r\n        modal.destroy();\r\n        displayDialogue(editor, Object.assign({}, data, {\r\n            url: submittedUrl,\r\n            invalidUrl: true,\r\n        }));\r\n        pendingPromise.resolve();\r\n        return;\r\n    }\r\n\r\n    const content = await renderForPromise(`${component}/content`, {\r\n        url: url.toString(),\r\n    });\r\n\r\n    editor.selection.moveToBookmark(openingSelection);\r\n    editor.execCommand('mceInsertContent', false, content.html);\r\n    editor.selection.moveToBookmark(openingSelection);\r\n    pendingPromise.resolve();\r\n};\r\n\r\nconst getCurrentH5PData = (currentH5P) => {\r\n    const data = {};\r\n    let url;\r\n    try {\r\n        url = new URL(currentH5P.textContent);\r\n    } catch (error) {\r\n        return data;\r\n    }\r\n\r\n    if (url.searchParams.has('export')) {\r\n        data.download = true;\r\n        data.showOptions = true;\r\n        url.searchParams.delete('export');\r\n    }\r\n\r\n    if (url.searchParams.has('embed')) {\r\n        data.embed = true;\r\n        data.showOptions = true;\r\n        url.searchParams.delete('embed');\r\n    }\r\n\r\n    if (url.searchParams.has('copyright')) {\r\n        data.copyright = true;\r\n        data.showOptions = true;\r\n        url.searchParams.delete('copyright');\r\n    }\r\n\r\n    data.url = url.toString();\r\n\r\n    return data;\r\n};\r\n\r\nconst displayDialogue = async(editor, data = {}) => {\r\n    const selection = editor.selection.getNode();\r\n    const currentH5P = selection.closest('.h5p-placeholder');\r\n    if (currentH5P) {\r\n        Object.assign(data, getCurrentH5PData(currentH5P));\r\n    }\r\n\r\n    const modal = await Modal.create({\r\n        templateContext: getTemplateContext(editor, data),\r\n    });\r\n\r\n    const $root = modal.getRoot();\r\n    const root = $root[0];\r\n    $root.on(ModalEvents.save, (event, modal) => {\r\n        handleDialogueSubmission(editor, modal, data);\r\n    });\r\n\r\n    root.addEventListener('click', (e) => {\r\n        const filepickerButton = e.target.closest('[data-target=\"filepicker\"]');\r\n        if (filepickerButton) {\r\n            displayFilepicker(editor, 'h5p').then((params) => {\r\n                if (params.url !== '') {\r\n                    const input = root.querySelector('form input[name=\"url\"]');\r\n                    input.value = params.url;\r\n                }\r\n                return params;\r\n            })\r\n                .catch();\r\n        }\r\n    });\r\n};\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_config","_modal","_modal_events","_pending","openingSelection","_exports","handleAction","editor","selection","getBookmark","displayDialogue","getTemplateContext","data","permissions","getPermissions","canShowFilePicker","getFilePicker","canUpload","upload","canEmbed","embed","canUploadAndEmbed","Object","assign","elementid","id","showOptions","fileURL","url","isValidUrl","RegExp","test","handleDialogueSubmission","async","modal","pendingPromise","Pending","form","getList","getRoot","querySelector","destroy","resolve","submittedUrl","value","getUrlFromSubmission","startsWith","Config","wwwroot","URL","downloadElement","checked","searchParams","append","embedElement","copyrightElement","invalidUrl","content","renderForPromise","component","toString","moveToBookmark","execCommand","html","arguments","length","undefined","currentH5P","getNode","closest","textContent","error","has","download","delete","copyright","getCurrentH5PData","$root","Modal","create","templateContext","root","on","ModalEvents","save","event","addEventListener","target","displayFilepicker","then","params","catch"],"mappings":"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"}