{"version":3,"file":"storage.min.js","sources":["../src/storage.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Storage helper for the Moodle Tiny Autosave plugin.\r\n *\r\n * @module      tiny_autosave/storage\r\n * @copyright   2022 Andrew Lyons <andrew@nicols.co.uk>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport * as Repository from \"./repository\";\r\nimport Pending from 'core/pending';\r\nimport {\r\n    markInitialised,\r\n    getBackoffTime,\r\n} from \"./options\";\r\nimport Log from 'core/log';\r\nimport {getLogSource} from './common';\r\n\r\n/** @property {Map} A map of debounced draft saves */\r\nconst saveDebounceMap = new Map();\r\n\r\n/**\r\n * Attempt to restore a draft into the editor\r\n *\r\n * @param {TinyMCE} editor The Editor to restore a draft for\r\n */\r\nexport const restoreDraft = async(editor) => {\r\n    const pendingPromise = new Pending('tiny_autosave/restoreDraft');\r\n    try {\r\n        const session = await Repository.resumeAutosaveSession(editor);\r\n        if (session && session.drafttext) {\r\n            editor.undoManager.ignore(() => {\r\n                editor.setContent(session.drafttext);\r\n                editor.save();\r\n            });\r\n        }\r\n    } catch (error) {\r\n        // Ignore any errors as drafts are optional.\r\n        Log.warn(`Failed to restore draft: ${error}`, getLogSource(editor));\r\n    }\r\n    markInitialised(editor);\r\n    pendingPromise.resolve();\r\n};\r\n\r\n/**\r\n * Save the current content of the editor as a draft.\r\n *\r\n * @param {TinyMCE} editor\r\n */\r\nexport const saveDraft = (editor) => {\r\n    const timerId = saveDebounceMap.get(editor);\r\n    if (timerId) {\r\n        clearTimeout(timerId);\r\n    }\r\n    saveDebounceMap.set(editor, setTimeout(() => {\r\n        Log.debug(`Saving draft`, getLogSource(editor));\r\n        Repository.updateAutosaveSession(editor)\r\n        .catch((error) => window.console.warn(error));\r\n    }, getBackoffTime(editor)));\r\n};\r\n\r\n/**\r\n * Delete the draft for the current editor.\r\n *\r\n * @param {TinyMCE} editor\r\n */\r\nexport const removeAutosaveSession = (editor) => {\r\n    Log.debug(`Removing Autosave session`, getLogSource(editor));\r\n    Repository.removeAutosaveSession(editor);\r\n};\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_getRequireWildcardCache","WeakMap","r","t","Repository","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","_pending","_log","saveDebounceMap","Map","_exports","restoreDraft","async","pendingPromise","Pending","session","resumeAutosaveSession","editor","drafttext","undoManager","ignore","setContent","save","error","Log","warn","getLogSource","markInitialised","resolve","saveDraft","timerId","clearTimeout","setTimeout","debug","updateAutosaveSession","catch","window","console","getBackoffTime","removeAutosaveSession"],"mappings":"yKA6B2B,SAAAA,uBAAAC,GAAAA,OAAAA,GAAAA,EAAAC,WAAAD,EAAAE,CAAAA,QAAAF,EAAA,CAAA,SAAAG,yBAAAH,GAAA,GAAA,mBAAAI,QAAA,OAAA,KAAA,IAAAC,EAAAD,IAAAA,QAAAE,EAAAF,IAAAA,eAAAD,yBAAA,SAAAH,GAAAA,OAAAA,EAAAM,EAAAD,IAAAL,EAAA,wIAN3BO,WAM2B,SAAAP,EAAAK,GAAAA,IAAAA,GAAAL,GAAAA,EAAAC,WAAAD,OAAAA,EAAAA,GAAAA,OAAAA,GAAAA,iBAAAA,GAAAA,mBAAAA,EAAAE,MAAAA,CAAAA,QAAAF,GAAAM,IAAAA,EAAAH,yBAAAE,GAAA,GAAAC,GAAAA,EAAAE,IAAAR,GAAA,OAAAM,EAAAG,IAAAT,GAAA,IAAAU,EAAA,CAAAC,UAAA,MAAAC,EAAAC,OAAAC,gBAAAD,OAAAE,yBAAA,IAAA,IAAAC,KAAAhB,EAAAgB,GAAAA,YAAAA,GAAAC,CAAAA,EAAAA,eAAAC,KAAAlB,EAAAgB,GAAAG,CAAAA,IAAAA,EAAAP,EAAAC,OAAAE,yBAAAf,EAAAgB,GAAAG,KAAAA,IAAAA,EAAAV,KAAAU,EAAAC,KAAAP,OAAAC,eAAAJ,EAAAM,EAAAG,GAAAT,EAAAM,GAAAhB,EAAAgB,GAAAN,OAAAA,EAAAR,QAAAF,EAAAM,GAAAA,EAAAc,IAAApB,EAAAU,GAAAA;;;;;;;KAAA,CAN3BW,CAAAd,YACAe,SAAAvB,uBAAAuB,UAKAC,KAAAxB,uBAAAwB,MAIA,MAAMC,gBAAkB,IAAIC,IAuB1BC,SAAAC,aAhB0BC,eACxB,MAAMC,eAAiB,IAAIC,SAAO5B,QAAC,8BACnC,IACI,MAAM6B,cAAgBxB,WAAWyB,sBAAsBC,QACnDF,SAAWA,QAAQG,WACnBD,OAAOE,YAAYC,QAAO,KACtBH,OAAOI,WAAWN,QAAQG,WAC1BD,OAAOK,MAAM,GAGxB,CAAC,MAAOC,OAELC,KAAAA,QAAIC,KAAK,4BAA4BF,SAAS,EAAAG,QAAYA,cAACT,QAC/D,EACA,EAAAU,SAAAA,iBAAgBV,QAChBJ,eAAee,SAAS,EAkB1BlB,SAAAmB,UAVwBZ,SACtB,MAAMa,QAAUtB,gBAAgBf,IAAIwB,QAChCa,SACAC,aAAaD,SAEjBtB,gBAAgBJ,IAAIa,OAAQe,YAAW,KACnCR,KAAGtC,QAAC+C,MAAM,gBAAgB,EAAAP,QAAYA,cAACT,SACvC1B,WAAW2C,sBAAsBjB,QAChCkB,OAAOZ,OAAUa,OAAOC,QAAQZ,KAAKF,QAAO,IAC9C,EAAAe,SAAAA,gBAAerB,SAAS,EAW7BP,SAAA6B,sBAHoCtB,SAClCO,KAAGtC,QAAC+C,MAAM,6BAA6B,EAAAP,QAAYA,cAACT,SACpD1B,WAAWgD,sBAAsBtB,OAAO,CAC1C"}