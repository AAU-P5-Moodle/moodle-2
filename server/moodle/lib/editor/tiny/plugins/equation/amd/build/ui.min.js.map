{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Tiny Equation UI.\r\n *\r\n * @module      tiny_equation/ui\r\n * @copyright   2022 Huong Nguyen <huongnv13@gmail.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport EquationModal from 'tiny_equation/modal';\r\nimport ModalEvents from 'core/modal_events';\r\nimport {getContextId, getLibraries, getTexDocsUrl} from 'tiny_equation/options';\r\nimport {notifyFilterContentUpdated} from 'core/event';\r\nimport * as TinyEquationRepository from 'tiny_equation/repository';\r\nimport {exception as displayException} from 'core/notification';\r\nimport {debounce} from 'core/utils';\r\nimport Selectors from 'tiny_equation/selectors';\r\nimport {getSourceEquation, getCurrentEquationData, setEquation} from 'tiny_equation/equation';\r\n\r\nlet currentForm;\r\nlet lastCursorPos = 0;\r\n\r\n/**\r\n * Handle action\r\n * @param {TinyMCE} editor\r\n */\r\nexport const handleAction = (editor) => {\r\n    displayDialogue(editor);\r\n};\r\n\r\n/**\r\n * Display the equation editor\r\n * @param {TinyMCE} editor\r\n * @returns {Promise<void>}\r\n */\r\nconst displayDialogue = async(editor) => {\r\n    let data = {};\r\n    const currentEquationData = getCurrentEquationData(editor);\r\n    if (currentEquationData) {\r\n        Object.assign(data, currentEquationData);\r\n    }\r\n    const modal = await EquationModal.create({\r\n        templateContext: getTemplateContext(editor, data),\r\n    });\r\n\r\n    const $root = await modal.getRoot();\r\n    const root = $root[0];\r\n    currentForm = root.querySelector(Selectors.elements.form);\r\n\r\n    const contextId = getContextId(editor);\r\n    const debouncedPreviewUpdater = debounce(() => updatePreview(getContextId(editor)), 500);\r\n\r\n    $root.on(ModalEvents.shown, () => {\r\n        const library = root.querySelector(Selectors.elements.library);\r\n        TinyEquationRepository.filterEquation(contextId, library.innerHTML).then(async data => {\r\n            library.innerHTML = data.content;\r\n            updatePreview(contextId);\r\n            notifyFilter(library);\r\n            return data;\r\n        }).catch(displayException);\r\n    });\r\n\r\n    root.addEventListener('click', (e) => {\r\n        const libraryItem = e.target.closest(Selectors.elements.libraryItem);\r\n        const submitAction = e.target.closest(Selectors.actions.submit);\r\n        const textArea = e.target.closest('.tiny_equation_equation');\r\n        if (libraryItem) {\r\n            e.preventDefault();\r\n            selectLibraryItem(libraryItem, contextId);\r\n        }\r\n        if (submitAction) {\r\n            e.preventDefault();\r\n            setEquation(currentForm, editor);\r\n            modal.destroy();\r\n        }\r\n        if (textArea) {\r\n            debouncedPreviewUpdater();\r\n        }\r\n    });\r\n\r\n    root.addEventListener('keyup', (e) => {\r\n        const textArea = e.target.closest(Selectors.elements.equationTextArea);\r\n        if (textArea) {\r\n            debouncedPreviewUpdater();\r\n        }\r\n    });\r\n\r\n    root.addEventListener('keydown', (e) => {\r\n        const libraryItem = e.target.closest(Selectors.elements.libraryItem);\r\n        if (libraryItem) {\r\n            if (e.keyCode == 37 || e.keyCode == 39) {\r\n                groupNavigation(e);\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Get template context.\r\n * @param {TinyMCE} editor\r\n * @param {Object} data\r\n * @returns {Object}\r\n */\r\nconst getTemplateContext = (editor, data) => {\r\n    const libraries = getLibraries(editor);\r\n    const texDocsUrl = getTexDocsUrl(editor);\r\n\r\n    return Object.assign({}, {\r\n        elementid: editor.id,\r\n        elementidescaped: CSS.escape(editor.id),\r\n        libraries: libraries,\r\n        texdocsurl: texDocsUrl,\r\n        delimiters: Selectors.delimiters,\r\n    }, data);\r\n};\r\n\r\n/**\r\n * Handle select library item.\r\n * @param {Object} libraryItem\r\n * @param {number} contextId\r\n */\r\nconst selectLibraryItem = (libraryItem, contextId) => {\r\n    const tex = libraryItem.getAttribute('data-tex');\r\n    const input = currentForm.querySelector(Selectors.elements.equationTextArea);\r\n    let oldValue;\r\n    let newValue;\r\n    let focusPoint = 0;\r\n\r\n    oldValue = input.value;\r\n\r\n    newValue = oldValue.substring(0, lastCursorPos);\r\n    if (newValue.charAt(newValue.length - 1) !== ' ') {\r\n        newValue += ' ';\r\n    }\r\n    newValue += tex;\r\n    focusPoint = newValue.length;\r\n\r\n    if (oldValue.charAt(lastCursorPos) !== ' ') {\r\n        newValue += ' ';\r\n    }\r\n    newValue += oldValue.substring(lastCursorPos, oldValue.length);\r\n\r\n    input.value = newValue;\r\n    input.focus();\r\n\r\n    input.selectionStart = input.selectionEnd = focusPoint;\r\n\r\n    updatePreview(contextId);\r\n};\r\n\r\n/**\r\n * Update the preview section.\r\n * @param {number} contextId\r\n */\r\nconst updatePreview = (contextId) => {\r\n    const textarea = currentForm.querySelector(Selectors.elements.equationTextArea);\r\n    const preview = currentForm.querySelector(Selectors.elements.preview);\r\n    const prefix = '';\r\n    const cursorLatex = Selectors.cursorLatex;\r\n    const isChar = /[a-zA-Z{]/;\r\n    let currentPos = textarea.selectionStart;\r\n    let equation = textarea.value;\r\n\r\n    // Move the cursor so it does not break expressions.\r\n    // Start at the very beginning.\r\n    if (!currentPos) {\r\n        currentPos = 0;\r\n    }\r\n\r\n    if (getSourceEquation()) {\r\n        currentPos = equation.length;\r\n    }\r\n\r\n    // First move back to the beginning of the line.\r\n    while (equation.charAt(currentPos) === '\\\\' && currentPos >= 0) {\r\n        currentPos -= 1;\r\n    }\r\n    if (currentPos !== 0) {\r\n        if (equation.charAt(currentPos - 1) != '{') {\r\n            // Now match to the end of the line.\r\n            while (isChar.test(equation.charAt(currentPos)) &&\r\n                    currentPos < equation.length &&\r\n                    isChar.test(equation.charAt(currentPos - 1))) {\r\n                currentPos += 1;\r\n            }\r\n        }\r\n    }\r\n    // Save the cursor position - for insertion from the library.\r\n    lastCursorPos = currentPos;\r\n    equation = prefix + equation.substring(0, currentPos) + cursorLatex + equation.substring(currentPos);\r\n\r\n    equation = Selectors.delimiters.start + ' ' + equation + ' ' + Selectors.delimiters.end;\r\n    TinyEquationRepository.filterEquation(contextId, equation).then((data) => {\r\n        preview.innerHTML = data.content;\r\n        notifyFilter(preview);\r\n\r\n        return data;\r\n    }).catch(displayException);\r\n};\r\n\r\n/**\r\n * Notify the filters about the modified nodes\r\n * @param {Element} element\r\n */\r\nconst notifyFilter = (element) => {\r\n    notifyFilterContentUpdated(element);\r\n};\r\n\r\n/**\r\n * Callback handling the keyboard navigation in the groups of the library.\r\n * @param {Event} e\r\n */\r\nconst groupNavigation = (e) => {\r\n    e.preventDefault();\r\n\r\n    const current = e.target.closest(Selectors.elements.libraryItem);\r\n    const parent = current.parentNode; // This must be the <div> containing all the buttons of the group.\r\n    const buttons = Array.prototype.slice.call(parent.querySelectorAll(Selectors.elements.libraryItem));\r\n    const direction = e.keyCode !== 37 ? 1 : -1;\r\n    let index = buttons.indexOf(current);\r\n    let nextButton;\r\n\r\n    if (index < 0) {\r\n        index = 0;\r\n    }\r\n\r\n    index += direction;\r\n    if (index < 0) {\r\n        index = buttons.length - 1;\r\n    } else if (index >= buttons.length) {\r\n        index = 0;\r\n    }\r\n    nextButton = buttons[index];\r\n    nextButton.focus();\r\n};\r\n"],"names":["_getRequireWildcardCache","e","WeakMap","r","t","_interopRequireDefault","__esModule","default","currentForm","_modal","_modal_events","TinyEquationRepository","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","_selectors","lastCursorPos","_exports","handleAction","editor","displayDialogue","async","data","currentEquationData","getCurrentEquationData","assign","modal","EquationModal","create","templateContext","getTemplateContext","$root","getRoot","root","querySelector","Selectors","elements","form","contextId","getContextId","debouncedPreviewUpdater","debounce","updatePreview","on","ModalEvents","shown","library","filterEquation","innerHTML","then","content","notifyFilter","catch","displayException","addEventListener","libraryItem","target","closest","submitAction","actions","submit","textArea","preventDefault","selectLibraryItem","setEquation","destroy","equationTextArea","keyCode","groupNavigation","libraries","getLibraries","texDocsUrl","getTexDocsUrl","elementid","id","elementidescaped","CSS","escape","texdocsurl","delimiters","tex","getAttribute","input","oldValue","newValue","focusPoint","value","substring","charAt","length","focus","selectionStart","selectionEnd","textarea","preview","cursorLatex","isChar","currentPos","equation","getSourceEquation","test","start","end","element","notifyFilterContentUpdated","current","parent","parentNode","buttons","Array","prototype","slice","querySelectorAll","direction","nextButton","index","indexOf"],"mappings":"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"}