{"version":3,"file":"equation.min.js","sources":["../src/equation.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Equation helper for Tiny Equation plugin.\r\n *\r\n * @module      tiny_equation/equation\r\n * @copyright   2022 Huong Nguyen <huongnv13@gmail.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Selectors from 'tiny_equation/selectors';\r\n\r\nlet sourceEquation = null;\r\n\r\n/**\r\n * Get the source equation.\r\n * @returns {Object}\r\n */\r\nexport const getSourceEquation = () => sourceEquation;\r\n\r\n/**\r\n * Get selected equation.\r\n * @param {TinyMCE} editor\r\n * @returns {boolean}\r\n */\r\nexport const getSelectedEquation = (editor) => {\r\n    const currentSelection = editor.selection.getSel();\r\n    if (!currentSelection) {\r\n        // Do the early return if there is no text selected.\r\n        return false;\r\n    }\r\n    const textSelection = editor.selection.getNode().textContent;\r\n    const currentCaretPos = currentSelection.focusOffset;\r\n    let returnValue = false;\r\n\r\n    Selectors.equationPatterns.forEach((pattern) => {\r\n        // For each pattern in turn, find all whole matches (including the delimiters).\r\n        const regexPattern = new RegExp(pattern.source, \"g\");\r\n        [...textSelection.matchAll(regexPattern)].forEach((matches) => {\r\n            const match = matches[0];\r\n            // Check each occurrence of this match.\r\n            let startIndex = 0;\r\n            const startOuter = textSelection.indexOf(match, startIndex);\r\n            const endOuter = startOuter + match.length;\r\n\r\n            // This match is in our current position - fetch the innerMatch data.\r\n            const innerMatch = match.match(pattern);\r\n            if (innerMatch && innerMatch.length) {\r\n                // We need the start and end of the inner match for later.\r\n                const startInner = textSelection.indexOf(innerMatch[1], startOuter);\r\n                const endInner = startInner + innerMatch[1].length;\r\n\r\n                // We need to check the caret position before returning the match.\r\n                if (currentCaretPos >= startOuter && currentCaretPos <= endOuter) {\r\n                    // We'll be returning the inner match for use in the editor itself.\r\n                    returnValue = innerMatch[1];\r\n\r\n                    // Save all data for later.\r\n                    sourceEquation = {\r\n                        // Inner match data.\r\n                        startInnerPosition: startInner,\r\n                        endInnerPosition: endInner,\r\n                        innerMatch: innerMatch\r\n                    };\r\n\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // Update the startIndex to match the end of the current match so that we can continue hunting\r\n            // for further matches.\r\n            startIndex = endOuter;\r\n        });\r\n    });\r\n\r\n    // We trim the equation when we load it and then add spaces when we save it.\r\n    if (returnValue !== false) {\r\n        returnValue = returnValue.trim();\r\n    } else {\r\n        // Clear the saved source equation.\r\n        sourceEquation = null;\r\n    }\r\n\r\n    return returnValue;\r\n};\r\n\r\n/**\r\n * Get current equation data.\r\n * @param {TinyMCE} editor\r\n * @returns {{}}\r\n */\r\nexport const getCurrentEquationData = (editor) => {\r\n    let properties = {};\r\n    const equation = getSelectedEquation(editor);\r\n    if (equation) {\r\n        properties.equation = equation;\r\n    }\r\n\r\n    return properties;\r\n};\r\n\r\n/**\r\n * Handle insertion of a new equation, or update of an existing one.\r\n * @param {Element} currentForm\r\n * @param {TinyMCE} editor\r\n */\r\nexport const setEquation = (currentForm, editor) => {\r\n    const input = currentForm.querySelector(Selectors.elements.equationTextArea);\r\n    const sourceEquation = getSourceEquation();\r\n    let value = input.value;\r\n\r\n    if (value !== '') {\r\n        if (sourceEquation) {\r\n            const selectedNode = editor.selection.getNode();\r\n            const text = selectedNode.textContent;\r\n            value = ' ' + value + ' ';\r\n            selectedNode.textContent = text.slice(0, sourceEquation.startInnerPosition)\r\n                + value\r\n                + text.slice(sourceEquation.endInnerPosition);\r\n        } else {\r\n            value = Selectors.delimiters.start + ' ' + value + ' ' + Selectors.delimiters.end;\r\n            editor.insertContent(value);\r\n        }\r\n    }\r\n};\r\n"],"names":["e","_selectors","__esModule","default","sourceEquation","getSourceEquation","_exports","getSelectedEquation","editor","currentSelection","selection","getSel","textSelection","getNode","textContent","currentCaretPos","focusOffset","returnValue","Selectors","equationPatterns","forEach","pattern","regexPattern","RegExp","source","matchAll","matches","match","startIndex","startOuter","indexOf","endOuter","length","innerMatch","startInner","endInner","startInnerPosition","endInnerPosition","trim","getCurrentEquationData","properties","equation","setEquation","currentForm","input","querySelector","elements","equationTextArea","value","selectedNode","text","slice","delimiters","start","end","insertContent"],"mappings":"qGAuBgD,IAAAA;;;;;;;iLAAhDC,YAAgDD,EAAhDC,aAAgDD,EAAAE,WAAAF,EAAAG,CAAAA,QAAAH,GAEhD,IAAII,eAAiB,KAMd,MAAMC,kBAAoBA,IAAMD,eAAeE,SAAAD,kBAAAA,kBAO/C,MAAME,oBAAuBC,SAChC,MAAMC,iBAAmBD,OAAOE,UAAUC,SAC1C,IAAKF,iBAED,OAAO,EAEX,MAAMG,cAAgBJ,OAAOE,UAAUG,UAAUC,YAC3CC,gBAAkBN,iBAAiBO,YACzC,IAAIC,aAAc,EAkDlB,OAhDAC,WAAAA,QAAUC,iBAAiBC,SAASC,UAEhC,MAAMC,aAAe,IAAIC,OAAOF,QAAQG,OAAQ,KAChD,IAAIZ,cAAca,SAASH,eAAeF,SAASM,UAC/C,MAAMC,MAAQD,QAAQ,GAEtB,IAAIE,WAAa,EACjB,MAAMC,WAAajB,cAAckB,QAAQH,MAAOC,YAC1CG,SAAWF,WAAaF,MAAMK,OAG9BC,WAAaN,MAAMA,MAAMN,SAC/B,GAAIY,YAAcA,WAAWD,OAAQ,CAEjC,MAAME,WAAatB,cAAckB,QAAQG,WAAW,GAAIJ,YAClDM,SAAWD,WAAaD,WAAW,GAAGD,OAG5C,GAAIjB,iBAAmBc,YAAcd,iBAAmBgB,SAYpD,OAVAd,YAAcgB,WAAW,QAGzB7B,eAAiB,CAEbgC,mBAAoBF,WACpBG,iBAAkBF,SAClBF,WAAYA,YAKxB,CAIAL,WAAaG,QAAQ,GACvB,KAIc,IAAhBd,YACAA,YAAcA,YAAYqB,OAG1BlC,eAAiB,KAGda,WAAW,EACpBX,SAAAC,oBAAAA,oBAeAD,SAAAiC,uBARqC/B,SACnC,IAAIgC,WAAa,CAAA,EACjB,MAAMC,SAAWlC,oBAAoBC,QAKrC,OAJIiC,WACAD,WAAWC,SAAWA,UAGnBD,UAAU,EA0BnBlC,SAAAoC,YAlByBA,CAACC,YAAanC,UACrC,MAAMoC,MAAQD,YAAYE,cAAc3B,WAAAA,QAAU4B,SAASC,kBACrD3C,eAAiBC,oBACvB,IAAI2C,MAAQJ,MAAMI,MAElB,GAAc,KAAVA,MACA,GAAI5C,eAAgB,CAChB,MAAM6C,aAAezC,OAAOE,UAAUG,UAChCqC,KAAOD,aAAanC,YAC1BkC,MAAQ,IAAMA,MAAQ,IACtBC,aAAanC,YAAcoC,KAAKC,MAAM,EAAG/C,eAAegC,oBAClDY,MACAE,KAAKC,MAAM/C,eAAeiC,iBACpC,MACIW,MAAQ9B,WAASf,QAACiD,WAAWC,MAAQ,IAAML,MAAQ,IAAM9B,mBAAUkC,WAAWE,IAC9E9C,OAAO+C,cAAcP,MAE7B,CACF"}