{"version":3,"file":"renderer.min.js","sources":["../../../src/local/templates/renderer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\nimport * as Log from 'core/log';\r\nimport * as Truncate from 'core/truncate';\r\nimport * as UserDate from 'core/user_date';\r\nimport Pending from 'core/pending';\r\nimport {getStrings} from 'core/str';\r\nimport IconSystem from 'core/icon_system';\r\nimport config from 'core/config';\r\nimport mustache from 'core/mustache';\r\nimport Loader from './loader';\r\nimport {getNormalisedComponent} from 'core/utils';\r\n\r\n/** @var {string} The placeholder character used for standard strings (unclean) */\r\nconst placeholderString = 's';\r\n\r\n/** @var {string} The placeholder character used for cleaned strings */\r\nconst placeholderCleanedString = 'c';\r\n\r\n/**\r\n * Template Renderer Class.\r\n *\r\n * Note: This class is not intended to be instantiated directly. Instead, use the core/templates module.\r\n *\r\n * @module     core/local/templates/renderer\r\n * @copyright  2023 Andrew Lyons <andrew@nicols.co.uk>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      4.3\r\n */\r\nexport default class Renderer {\r\n    /** @var {string[]} requiredStrings - Collection of strings found during the rendering of one template */\r\n    requiredStrings = null;\r\n\r\n    /** @var {object[]} requiredDates - Collection of dates found during the rendering of one template */\r\n    requiredDates = [];\r\n\r\n    /** @var {string[]} requiredJS - Collection of js blocks found during the rendering of one template */\r\n    requiredJS = null;\r\n\r\n    /** @var {String} themeName for the current render */\r\n    currentThemeName = '';\r\n\r\n    /** @var {Number} uniqInstances Count of times this constructor has been called. */\r\n    static uniqInstances = 0;\r\n\r\n    /** @var {Object[]} loadTemplateBuffer - List of templates to be loaded */\r\n    static loadTemplateBuffer = [];\r\n\r\n    /** @var {Bool} isLoadingTemplates - Whether templates are currently being loaded */\r\n    static isLoadingTemplates = false;\r\n\r\n    /** @var {Object} iconSystem - Object extending core/iconsystem */\r\n    iconSystem = null;\r\n\r\n    /** @var {Array} disallowedNestedHelpers - List of helpers that can't be called within other helpers */\r\n    static disallowedNestedHelpers = [\r\n        'js',\r\n    ];\r\n\r\n    /** @var {String[]} templateCache - Cache of already loaded template strings */\r\n    static templateCache = {};\r\n\r\n    /**\r\n     * Cache of already loaded template promises.\r\n     *\r\n     * @type {Promise[]}\r\n     * @static\r\n     * @private\r\n     */\r\n    static templatePromises = {};\r\n\r\n    /**\r\n     * The loader used to fetch templates.\r\n     * @type {Loader}\r\n     * @static\r\n     * @private\r\n     */\r\n    static loader = Loader;\r\n\r\n    /**\r\n     * Constructor\r\n     *\r\n     * Each call to templates.render gets it's own instance of this class.\r\n     */\r\n    constructor() {\r\n        this.requiredStrings = [];\r\n        this.requiredJS = [];\r\n        this.requiredDates = [];\r\n        this.currentThemeName = '';\r\n    }\r\n\r\n    /**\r\n     * Set the template loader to use for all Template renderers.\r\n     *\r\n     * @param {Loader} loader\r\n     */\r\n    static setLoader(loader) {\r\n        this.loader = loader;\r\n    }\r\n\r\n    /**\r\n     * Get the Loader used to fetch templates.\r\n     *\r\n     * @returns {Loader}\r\n     */\r\n    static getLoader() {\r\n        return this.loader;\r\n    }\r\n\r\n    /**\r\n     * Render a single image icon.\r\n     *\r\n     * @method renderIcon\r\n     * @private\r\n     * @param {string} key The icon key.\r\n     * @param {string} component The component name.\r\n     * @param {string} title The icon title\r\n     * @returns {Promise}\r\n     */\r\n    async renderIcon(key, component, title) {\r\n        // Preload the module to do the icon rendering based on the theme iconsystem.\r\n        component = getNormalisedComponent(component);\r\n\r\n        await this.setupIconSystem();\r\n        const template = await Renderer.getLoader().getTemplate(\r\n            this.iconSystem.getTemplateName(),\r\n            this.currentThemeName,\r\n        );\r\n\r\n        return this.iconSystem.renderIcon(\r\n            key,\r\n            component,\r\n            title,\r\n            template\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Helper to set up the icon system.\r\n     */\r\n    async setupIconSystem() {\r\n        if (!this.iconSystem) {\r\n            this.iconSystem = await IconSystem.instance();\r\n        }\r\n\r\n        return this.iconSystem;\r\n    }\r\n\r\n    /**\r\n     * Render image icons.\r\n     *\r\n     * @method pixHelper\r\n     * @private\r\n     * @param {object} context The mustache context\r\n     * @param {string} sectionText The text to parse arguments from.\r\n     * @param {function} helper Used to render the alt attribute of the text.\r\n     * @returns {string}\r\n     */\r\n    pixHelper(context, sectionText, helper) {\r\n        const parts = sectionText.split(',');\r\n        let key = '';\r\n        let component = '';\r\n        let text = '';\r\n\r\n        if (parts.length > 0) {\r\n            key = helper(parts.shift().trim(), context);\r\n        }\r\n        if (parts.length > 0) {\r\n            component = helper(parts.shift().trim(), context);\r\n        }\r\n        if (parts.length > 0) {\r\n            text = helper(parts.join(',').trim(), context);\r\n        }\r\n\r\n        // Note: We cannot use Promises in Mustache helpers.\r\n        // We must fetch straight from the Loader cache.\r\n        // The Loader cache is statically defined on the Loader class and should be used by all children.\r\n        const Loader = Renderer.getLoader();\r\n        const templateName = this.iconSystem.getTemplateName();\r\n        const searchKey = Loader.getSearchKey(this.currentThemeName, templateName);\r\n        const template = Loader.getTemplateFromCache(searchKey);\r\n\r\n        component = getNormalisedComponent(component);\r\n\r\n        // The key might have been escaped by the JS Mustache engine which\r\n        // converts forward slashes to HTML entities. Let us undo that here.\r\n        key = key.replace(/&#x2F;/gi, '/');\r\n\r\n        return this.iconSystem.renderIcon(\r\n            key,\r\n            component,\r\n            text,\r\n            template\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Render blocks of javascript and save them in an array.\r\n     *\r\n     * @method jsHelper\r\n     * @private\r\n     * @param {object} context The current mustache context.\r\n     * @param {string} sectionText The text to save as a js block.\r\n     * @param {function} helper Used to render the block.\r\n     * @returns {string}\r\n     */\r\n    jsHelper(context, sectionText, helper) {\r\n        this.requiredJS.push(helper(sectionText, context));\r\n        return '';\r\n    }\r\n\r\n    /**\r\n     * String helper used to render {{#str}}abd component { a : 'fish'}{{/str}}\r\n     * into a get_string call.\r\n     *\r\n     * @method stringHelper\r\n     * @private\r\n     * @param {object} context The current mustache context.\r\n     * @param {string} sectionText The text to parse the arguments from.\r\n     * @param {function} helper Used to render subsections of the text.\r\n     * @returns {string}\r\n     */\r\n    stringHelper(context, sectionText, helper) {\r\n        // A string instruction is in the format:\r\n        // key, component, params.\r\n\r\n        let parts = sectionText.split(',');\r\n\r\n        const key = parts.length > 0 ? parts.shift().trim() : '';\r\n        const component = parts.length > 0 ? getNormalisedComponent(parts.shift().trim()) : '';\r\n        let param = parts.length > 0 ? parts.join(',').trim() : '';\r\n\r\n        if (param !== '') {\r\n            // Allow variable expansion in the param part only.\r\n            param = helper(param, context);\r\n        }\r\n\r\n        if (param.match(/^{\\s*\"/gm)) {\r\n            // If it can't be parsed then the string is not a JSON format.\r\n            try {\r\n                const parsedParam = JSON.parse(param);\r\n                // Handle non-exception-throwing cases, e.g. null, integer, boolean.\r\n                if (parsedParam && typeof parsedParam === \"object\") {\r\n                    param = parsedParam;\r\n                }\r\n            } catch (err) {\r\n                // This was probably not JSON.\r\n                // Keep the error message visible but do not promote it because it may not be an error.\r\n                window.console.warn(err.message);\r\n            }\r\n        }\r\n\r\n        const index = this.requiredStrings.length;\r\n        this.requiredStrings.push({\r\n            key,\r\n            component,\r\n            param,\r\n        });\r\n\r\n        // The placeholder must not use {{}} as those can be misinterpreted by the engine.\r\n        return `[[_s${index}]]`;\r\n    }\r\n\r\n    /**\r\n     * String helper to render {{#cleanstr}}abd component { a : 'fish'}{{/cleanstr}}\r\n     * into a get_string following by an HTML escape.\r\n     *\r\n     * @method cleanStringHelper\r\n     * @private\r\n     * @param {object} context The current mustache context.\r\n     * @param {string} sectionText The text to parse the arguments from.\r\n     * @param {function} helper Used to render subsections of the text.\r\n     * @returns {string}\r\n     */\r\n    cleanStringHelper(context, sectionText, helper) {\r\n        // We're going to use [[_cx]] format for clean strings, where x is a number.\r\n        // Hence, replacing 's' with 'c' in the placeholder that stringHelper returns.\r\n        return this\r\n            .stringHelper(context, sectionText, helper)\r\n            .replace(placeholderString, placeholderCleanedString);\r\n    }\r\n\r\n    /**\r\n     * Quote helper used to wrap content in quotes, and escape all special JSON characters present in the content.\r\n     *\r\n     * @method quoteHelper\r\n     * @private\r\n     * @param {object} context The current mustache context.\r\n     * @param {string} sectionText The text to parse the arguments from.\r\n     * @param {function} helper Used to render subsections of the text.\r\n     * @returns {string}\r\n     */\r\n    quoteHelper(context, sectionText, helper) {\r\n        let content = helper(sectionText.trim(), context);\r\n\r\n        // Escape the {{ and JSON encode.\r\n        // This involves wrapping {{, and }} in change delimeter tags.\r\n        content = JSON.stringify(content);\r\n        content = content.replace(/([{}]{2,3})/g, '{{=<% %>=}}$1<%={{ }}=%>');\r\n        return content;\r\n    }\r\n\r\n    /**\r\n     * Shorten text helper to truncate text and append a trailing ellipsis.\r\n     *\r\n     * @method shortenTextHelper\r\n     * @private\r\n     * @param {object} context The current mustache context.\r\n     * @param {string} sectionText The text to parse the arguments from.\r\n     * @param {function} helper Used to render subsections of the text.\r\n     * @returns {string}\r\n     */\r\n    shortenTextHelper(context, sectionText, helper) {\r\n        // Non-greedy split on comma to grab section text into the length and\r\n        // text parts.\r\n        const parts = sectionText.match(/(.*?),(.*)/);\r\n\r\n        // The length is the part matched in the first set of parethesis.\r\n        const length = parts[1].trim();\r\n        // The length is the part matched in the second set of parethesis.\r\n        const text = parts[2].trim();\r\n        const content = helper(text, context);\r\n        return Truncate.truncate(content, {\r\n            length,\r\n            words: true,\r\n            ellipsis: '...'\r\n        });\r\n    }\r\n\r\n    /**\r\n     * User date helper to render user dates from timestamps.\r\n     *\r\n     * @method userDateHelper\r\n     * @private\r\n     * @param {object} context The current mustache context.\r\n     * @param {string} sectionText The text to parse the arguments from.\r\n     * @param {function} helper Used to render subsections of the text.\r\n     * @returns {string}\r\n     */\r\n    userDateHelper(context, sectionText, helper) {\r\n        // Non-greedy split on comma to grab the timestamp and format.\r\n        const parts = sectionText.match(/(.*?),(.*)/);\r\n\r\n        const timestamp = helper(parts[1].trim(), context);\r\n        const format = helper(parts[2].trim(), context);\r\n        const index = this.requiredDates.length;\r\n\r\n        this.requiredDates.push({\r\n            timestamp: timestamp,\r\n            format: format\r\n        });\r\n\r\n        return `[[_t_${index}]]`;\r\n    }\r\n\r\n    /**\r\n     * Return a helper function to be added to the context for rendering the a\r\n     * template.\r\n     *\r\n     * This will parse the provided text before giving it to the helper function\r\n     * in order to remove any disallowed nested helpers to prevent one helper\r\n     * from calling another.\r\n     *\r\n     * In particular to prevent the JS helper from being called from within another\r\n     * helper because it can lead to security issues when the JS portion is user\r\n     * provided.\r\n     *\r\n     * @param  {function} helperFunction The helper function to add\r\n     * @param  {object} context The template context for the helper function\r\n     * @returns {Function} To be set in the context\r\n     */\r\n    addHelperFunction(helperFunction, context) {\r\n        return function() {\r\n            return function(sectionText, helper) {\r\n                // Override the disallowed helpers in the template context with\r\n                // a function that returns an empty string for use when executing\r\n                // other helpers. This is to prevent these helpers from being\r\n                // executed as part of the rendering of another helper in order to\r\n                // prevent any potential security issues.\r\n                const originalHelpers = Renderer.disallowedNestedHelpers.reduce((carry, name) => {\r\n                    if (context.hasOwnProperty(name)) {\r\n                        carry[name] = context[name];\r\n                    }\r\n\r\n                    return carry;\r\n                }, {});\r\n\r\n                Renderer.disallowedNestedHelpers.forEach((helperName) => {\r\n                    context[helperName] = () => '';\r\n                });\r\n\r\n                // Execute the helper with the modified context that doesn't include\r\n                // the disallowed nested helpers. This prevents the disallowed\r\n                // helpers from being called from within other helpers.\r\n                const result = helperFunction.apply(this, [context, sectionText, helper]);\r\n\r\n                // Restore the original helper implementation in the context so that\r\n                // any further rendering has access to them again.\r\n                for (const name in originalHelpers) {\r\n                    context[name] = originalHelpers[name];\r\n                }\r\n\r\n                return result;\r\n            }.bind(this);\r\n        }.bind(this);\r\n    }\r\n\r\n    /**\r\n     * Add some common helper functions to all context objects passed to templates.\r\n     * These helpers match exactly the helpers available in php.\r\n     *\r\n     * @method addHelpers\r\n     * @private\r\n     * @param {Object} context Simple types used as the context for the template.\r\n     * @param {String} themeName We set this multiple times, because there are async calls.\r\n     */\r\n    addHelpers(context, themeName) {\r\n        this.currentThemeName = themeName;\r\n        this.requiredStrings = [];\r\n        this.requiredJS = [];\r\n        context.uniqid = (Renderer.uniqInstances++);\r\n\r\n        // Please note that these helpers _must_ not return a Promise.\r\n        context.str = this.addHelperFunction(this.stringHelper, context);\r\n        context.cleanstr = this.addHelperFunction(this.cleanStringHelper, context);\r\n        context.pix = this.addHelperFunction(this.pixHelper, context);\r\n        context.js = this.addHelperFunction(this.jsHelper, context);\r\n        context.quote = this.addHelperFunction(this.quoteHelper, context);\r\n        context.shortentext = this.addHelperFunction(this.shortenTextHelper, context);\r\n        context.userdate = this.addHelperFunction(this.userDateHelper, context);\r\n        context.globals = {config: config};\r\n        context.currentTheme = themeName;\r\n    }\r\n\r\n    /**\r\n     * Get all the JS blocks from the last rendered template.\r\n     *\r\n     * @method getJS\r\n     * @private\r\n     * @returns {string}\r\n     */\r\n    getJS() {\r\n        return this.requiredJS.join(\";\\n\");\r\n    }\r\n\r\n    /**\r\n     * Treat strings in content.\r\n     *\r\n     * The purpose of this method is to replace the placeholders found in a string\r\n     * with the their respective translated strings.\r\n     *\r\n     * Previously we were relying on String.replace() but the complexity increased with\r\n     * the numbers of strings to replace. Now we manually walk the string and stop at each\r\n     * placeholder we find, only then we replace it. Most of the time we will\r\n     * replace all the placeholders in a single run, at times we will need a few\r\n     * more runs when placeholders are replaced with strings that contain placeholders\r\n     * themselves.\r\n     *\r\n     * @param {String} content The content in which string placeholders are to be found.\r\n     * @param {Map} stringMap The strings to replace with.\r\n     * @returns {String} The treated content.\r\n     */\r\n    treatStringsInContent(content, stringMap) {\r\n        // Placeholders are in the for [[_sX]] or [[_cX]] where X is the string index.\r\n        const stringPattern = /(?<placeholder>\\[\\[_(?<stringType>[cs])(?<stringIndex>\\d+)\\]\\])/g;\r\n\r\n        // A helpre to fetch the string for a given placeholder.\r\n        const getUpdatedString = ({placeholder, stringType, stringIndex}) => {\r\n            if (stringMap.has(placeholder)) {\r\n                return stringMap.get(placeholder);\r\n            }\r\n\r\n            if (stringType === placeholderCleanedString) {\r\n                // Attempt to find the unclean string and clean it. Store it for later use.\r\n                const uncleanString = stringMap.get(`[[_s${stringIndex}]]`);\r\n                if (uncleanString) {\r\n                    stringMap.set(placeholder, mustache.escape(uncleanString));\r\n                    return stringMap.get(placeholder);\r\n                }\r\n            }\r\n\r\n            Log.debug(`Could not find string for pattern ${placeholder}`);\r\n            return '';\r\n        };\r\n\r\n        // Find all placeholders in the content and replace them with their respective strings.\r\n        let match;\r\n        while ((match = stringPattern.exec(content)) !== null) {\r\n            let updatedContent = content.slice(0, match.index);\r\n            updatedContent += getUpdatedString(match.groups);\r\n            updatedContent += content.slice(match.index + match.groups.placeholder.length);\r\n\r\n            content = updatedContent;\r\n        }\r\n\r\n        return content;\r\n    }\r\n\r\n    /**\r\n     * Treat strings in content.\r\n     *\r\n     * The purpose of this method is to replace the date placeholders found in the\r\n     * content with the their respective translated dates.\r\n     *\r\n     * @param {String} content The content in which string placeholders are to be found.\r\n     * @param {Array} dates The dates to replace with.\r\n     * @returns {String} The treated content.\r\n     */\r\n    treatDatesInContent(content, dates) {\r\n        dates.forEach((date, index) => {\r\n            content = content.replace(\r\n                new RegExp(`\\\\[\\\\[_t_${index}\\\\]\\\\]`, 'g'),\r\n                date,\r\n            );\r\n        });\r\n\r\n        return content;\r\n    }\r\n\r\n    /**\r\n     * Render a template and then call the callback with the result.\r\n     *\r\n     * @method doRender\r\n     * @private\r\n     * @param {string|Promise} templateSourcePromise The mustache template to render.\r\n     * @param {Object} context Simple types used as the context for the template.\r\n     * @param {String} themeName Name of the current theme.\r\n     * @returns {Promise<object<string, string>>} The rendered HTML and JS.\r\n     */\r\n    async doRender(templateSourcePromise, context, themeName) {\r\n        this.currentThemeName = themeName;\r\n        const iconTemplate = this.iconSystem.getTemplateName();\r\n\r\n        const pendingPromise = new Pending('core/templates:doRender');\r\n        const [templateSource] = await Promise.all([\r\n            templateSourcePromise,\r\n            Renderer.getLoader().getTemplate(iconTemplate, themeName),\r\n        ]);\r\n\r\n        this.addHelpers(context, themeName);\r\n\r\n        // Render the template.\r\n        const renderedContent = await mustache.render(\r\n            templateSource,\r\n            context,\r\n            // Note: The third parameter is a function that will be called to process partials.\r\n            (partialName) => Renderer.getLoader().partialHelper(partialName, themeName),\r\n        );\r\n\r\n        const {html, js} = await this.processRenderedContent(renderedContent);\r\n\r\n        pendingPromise.resolve();\r\n        return {html, js};\r\n    }\r\n\r\n    /**\r\n     * Process the rendered content, treating any strings and applying and helper strings, dates, etc.\r\n     * @param {string} renderedContent\r\n     * @returns {Promise<object<string, string>>} The rendered HTML and JS.\r\n     */\r\n    async processRenderedContent(renderedContent) {\r\n        let html = renderedContent.trim();\r\n        let js = this.getJS();\r\n\r\n        if (this.requiredStrings.length > 0) {\r\n            // Fetch the strings into a new Map using the placeholder as an index.\r\n            // Note: We only fetch the unclean version. Cleaning of strings happens lazily in treatStringsInContent.\r\n            const stringMap = new Map(\r\n                (await getStrings(this.requiredStrings)).map((string, index) => (\r\n                    [`[[_s${index}]]`, string]\r\n                ))\r\n            );\r\n\r\n            // Make sure string substitutions are done for the userdate\r\n            // values as well.\r\n            this.requiredDates = this.requiredDates.map(function(date) {\r\n                return {\r\n                    timestamp: this.treatStringsInContent(date.timestamp, stringMap),\r\n                    format: this.treatStringsInContent(date.format, stringMap)\r\n                };\r\n            }.bind(this));\r\n\r\n            // Why do we not do another call the render here?\r\n            //\r\n            // Because that would expose DOS holes. E.g.\r\n            // I create an assignment called \"{{fish\" which\r\n            // would get inserted in the template in the first pass\r\n            // and cause the template to die on the second pass (unbalanced).\r\n            html = this.treatStringsInContent(html, stringMap);\r\n            js = this.treatStringsInContent(js, stringMap);\r\n        }\r\n\r\n        // This has to happen after the strings replacement because you can\r\n        // use the string helper in content for the user date helper.\r\n        if (this.requiredDates.length > 0) {\r\n            const dates = await UserDate.get(this.requiredDates);\r\n            html = this.treatDatesInContent(html, dates);\r\n            js = this.treatDatesInContent(js, dates);\r\n        }\r\n\r\n        return {html, js};\r\n    }\r\n\r\n    /**\r\n     * Load a template and call doRender on it.\r\n     *\r\n     * @method render\r\n     * @private\r\n     * @param {string} templateName - should consist of the component and the name of the template like this:\r\n     *                              core/menu (lib/templates/menu.mustache) or\r\n     *                              tool_bananas/yellow (admin/tool/bananas/templates/yellow.mustache)\r\n     * @param {Object} [context={}] - Could be array, string or simple value for the context of the template.\r\n     * @param {string} [themeName] - Name of the current theme.\r\n     * @returns {Promise<object>} Native promise object resolved when the template has been rendered.}\r\n     */\r\n    async render(\r\n        templateName,\r\n        context = {},\r\n        themeName = config.theme,\r\n    ) {\r\n        this.currentThemeName = themeName;\r\n\r\n        // Preload the module to do the icon rendering based on the theme iconsystem.\r\n        await this.setupIconSystem();\r\n\r\n        const templateSource = Renderer.getLoader().cachePartials(templateName, themeName);\r\n        return this.doRender(templateSource, context, themeName);\r\n    }\r\n}\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_getRequireWildcardCache","WeakMap","r","t","_interopRequireWildcard","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","Log","Truncate","UserDate","_pending","_icon_system","_config","_mustache","_loader","Renderer","requiredStrings","requiredDates","requiredJS","currentThemeName","static","iconSystem","Loader","constructor","this","setLoader","loader","getLoader","renderIcon","key","component","title","getNormalisedComponent","setupIconSystem","template","getTemplate","getTemplateName","IconSystem","instance","pixHelper","context","sectionText","helper","parts","split","text","length","shift","trim","join","templateName","searchKey","getSearchKey","getTemplateFromCache","replace","jsHelper","push","stringHelper","param","match","parsedParam","JSON","parse","err","window","console","warn","message","index","cleanStringHelper","quoteHelper","content","stringify","shortenTextHelper","truncate","words","ellipsis","userDateHelper","timestamp","format","addHelperFunction","helperFunction","originalHelpers","disallowedNestedHelpers","reduce","carry","name","forEach","helperName","result","apply","bind","addHelpers","themeName","uniqid","uniqInstances","str","cleanstr","pix","js","quote","shortentext","userdate","globals","config","currentTheme","getJS","treatStringsInContent","stringMap","stringPattern","getUpdatedString","_ref","placeholder","stringType","stringIndex","uncleanString","mustache","escape","debug","exec","updatedContent","slice","groups","treatDatesInContent","dates","date","RegExp","doRender","templateSourcePromise","iconTemplate","pendingPromise","Pending","templateSource","Promise","all","renderedContent","render","partialName","partialHelper","html","processRenderedContent","resolve","Map","getStrings","map","string","arguments","undefined","theme","cachePartials","_exports"],"mappings":"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"}