{"version":3,"file":"overlay.min.js","sources":["../../../src/local/reactive/overlay.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Element overlay methods.\r\n *\r\n * This module is used to create overlay information on components. For example\r\n * to generate or destroy file drop-zones.\r\n *\r\n * @module     core/local/reactive/overlay\r\n * @copyright  2022 Ferran Recio <ferran@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Templates from 'core/templates';\r\nimport Prefetch from 'core/prefetch';\r\n\r\n// Prefetch the overlay html.\r\nconst overlayTemplate = 'core/local/reactive/overlay';\r\nPrefetch.prefetchTemplate(overlayTemplate);\r\n\r\n/**\r\n * @var {boolean} isInitialized if the module is capturing the proper page events.\r\n */\r\nlet isInitialized = false;\r\n\r\n/**\r\n * @var {Object} isInitialized if the module is capturing the proper page events.\r\n */\r\nconst selectors = {\r\n    OVERLAY: \"[data-overlay]\",\r\n    REPOSITION: \"[data-overlay-dynamic]\",\r\n    NAVBAR: \"nav.navbar.fixed-top\",\r\n};\r\n\r\n/**\r\n * Adds an overlay to a specific page element.\r\n *\r\n * @param {Object} definition the overlay definition.\r\n * @param {String|Promise} definition.content an optional overlay content.\r\n * @param {String|Promise} definition.icon an optional icon content.\r\n * @param {String} definition.classes an optional CSS classes\r\n * @param {HTMLElement} parent the parent object\r\n * @return {HTMLElement|undefined} the new page element.\r\n */\r\nexport const addOverlay = async(definition, parent) => {\r\n    // Validate non of the passed params is a promise.\r\n    if (definition.content && typeof definition.content !== 'string') {\r\n        definition.content = await definition.content;\r\n    }\r\n    if (definition.icon && typeof definition.icon !== 'string') {\r\n        definition.icon = await definition.icon;\r\n    }\r\n    const data = {\r\n        content: definition.content,\r\n        css: definition.classes ?? 'file-drop-zone',\r\n    };\r\n    const {html, js} = await Templates.renderForPromise(overlayTemplate, data);\r\n    Templates.appendNodeContents(parent, html, js);\r\n    const overlay = parent.querySelector(selectors.OVERLAY);\r\n    rePositionPreviewInfoElement(overlay);\r\n    init();\r\n    return overlay;\r\n};\r\n\r\n/**\r\n * Adds an overlay to a specific page element.\r\n *\r\n * @param {HTMLElement} overlay the parent object\r\n */\r\nexport const removeOverlay = (overlay) => {\r\n    if (!overlay || !overlay.parentNode) {\r\n        return;\r\n    }\r\n    // Remove any forced parentNode position.\r\n    if (overlay.dataset?.overlayPosition) {\r\n        delete overlay.parentNode.style.position;\r\n    }\r\n    overlay.parentNode.removeChild(overlay);\r\n};\r\n\r\nexport const removeAllOverlays = () => {\r\n    document.querySelectorAll(selectors.OVERLAY).forEach(\r\n        (overlay) => {\r\n            removeOverlay(overlay);\r\n        }\r\n    );\r\n};\r\n\r\n/**\r\n * Re-position the preview information element by calculating the section position.\r\n *\r\n * @param {Object} overlay the overlay element.\r\n */\r\nconst rePositionPreviewInfoElement = function(overlay) {\r\n    if (!overlay) {\r\n        throw new Error('Inexistent overlay element');\r\n    }\r\n    // Add relative position to the parent object.\r\n    if (!overlay.parentNode?.style?.position) {\r\n        overlay.parentNode.style.position = 'relative';\r\n        overlay.dataset.overlayPosition = \"true\";\r\n    }\r\n    // Get the element to reposition.\r\n    const target = overlay.querySelector(selectors.REPOSITION);\r\n    if (!target) {\r\n        return;\r\n    }\r\n    // Get the new bounds.\r\n    const rect = overlay.getBoundingClientRect();\r\n    const sectionHeight = parseInt(window.getComputedStyle(overlay).height, 10);\r\n    const sectionOffset = rect.top;\r\n    const previewHeight = parseInt(window.getComputedStyle(target).height, 10) +\r\n        (2 * parseInt(window.getComputedStyle(target).padding, 10));\r\n    // Calculate the new target position.\r\n    let top, bottom;\r\n    if (sectionOffset < 0) {\r\n        if (sectionHeight + sectionOffset >= previewHeight) {\r\n            // We have enough space here, just stick the preview to the top.\r\n            let offSetTop = 0 - sectionOffset;\r\n            const navBar = document.querySelector(selectors.NAVBAR);\r\n            if (navBar) {\r\n                offSetTop = offSetTop + navBar.offsetHeight;\r\n            }\r\n            top = offSetTop + 'px';\r\n            bottom = 'unset';\r\n        } else {\r\n            // We do not have enough space here, just stick the preview to the bottom.\r\n            top = 'unset';\r\n            bottom = 0;\r\n        }\r\n    } else {\r\n        top = 0;\r\n        bottom = 'unset';\r\n    }\r\n\r\n    target.style.top = top;\r\n    target.style.bottom = bottom;\r\n};\r\n\r\n// Update overlays when the page scrolls.\r\nconst init = () => {\r\n    if (isInitialized) {\r\n        return;\r\n    }\r\n    // Add scroll events.\r\n    document.addEventListener('scroll', () => {\r\n        document.querySelectorAll(selectors.OVERLAY).forEach(\r\n            (overlay) => {\r\n                rePositionPreviewInfoElement(overlay);\r\n            }\r\n        );\r\n    }, true);\r\n};\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_templates","_prefetch","Prefetch","prefetchTemplate","selectors","_exports","addOverlay","async","definition","parent","content","icon","data","css","classes","html","js","Templates","renderForPromise","appendNodeContents","overlay","querySelector","rePositionPreviewInfoElement","init","removeOverlay","parentNode","dataset","overlayPosition","style","position","removeChild","removeAllOverlays","document","querySelectorAll","forEach","Error","target","rect","getBoundingClientRect","sectionHeight","parseInt","window","getComputedStyle","height","sectionOffset","top","previewHeight","padding","bottom","offSetTop","navBar","offsetHeight","addEventListener"],"mappings":"2HA2BqC,SAAAA,uBAAAC,GAAAA,OAAAA,GAAAA,EAAAC,WAAAD,EAAAE,CAAAA,QAAAF,EAAA;;;;;;;;;;0IADrCG,WAAAJ,uBAAAI,YACAC,UAAAL,uBAAAK,WAIAC,UAAAA,QAASC,iBADe,+BAWxB,MAAMC,kBACO,iBADPA,qBAEU,yBAFVA,iBAGM,uBA+BVC,SAAAC,WAlBwBC,MAAMC,WAAYC,UAEpCD,WAAWE,SAAyC,iBAAvBF,WAAWE,UACxCF,WAAWE,cAAgBF,WAAWE,SAEtCF,WAAWG,MAAmC,iBAApBH,WAAWG,OACrCH,WAAWG,WAAaH,WAAWG,MAEvC,MAAMC,KAAO,CACTF,QAASF,WAAWE,QACpBG,IAAKL,WAAWM,SAAW,mBAEzBC,KAACA,KAAIC,GAAEA,UAAYC,WAASlB,QAACmB,iBAvCf,8BAuCiDN,MACrEK,WAASlB,QAACoB,mBAAmBV,OAAQM,KAAMC,IAC3C,MAAMI,QAAUX,OAAOY,cAAcjB,mBAGrC,OAFAkB,6BAA6BF,SAC7BG,OACOH,OAAO,EAQX,MAAMI,cAAiBJ,UACrBA,SAAYA,QAAQK,aAIrBL,QAAQM,SAASC,wBACVP,QAAQK,WAAWG,MAAMC,SAEpCT,QAAQK,WAAWK,YAAYV,SAAQ,EACzCf,SAAAmB,cAAAA,cAQAnB,SAAA0B,kBAN+BA,KAC7BC,SAASC,iBAAiB7B,mBAAmB8B,SACxCd,UACGI,cAAcJ,QAAQ,GAE7B,EAQL,MAAME,6BAA+B,SAASF,SAC1C,IAAKA,QACD,MAAM,IAAIe,MAAM,8BAGff,QAAQK,YAAYG,OAAOC,WAC5BT,QAAQK,WAAWG,MAAMC,SAAW,WACpCT,QAAQM,QAAQC,gBAAkB,QAGtC,MAAMS,OAAShB,QAAQC,cAAcjB,sBACrC,IAAKgC,OACD,OAGJ,MAAMC,KAAOjB,QAAQkB,wBACfC,cAAgBC,SAASC,OAAOC,iBAAiBtB,SAASuB,OAAQ,IAClEC,cAAgBP,KAAKQ,IACrBC,cAAgBN,SAASC,OAAOC,iBAAiBN,QAAQO,OAAQ,IAClE,EAAIH,SAASC,OAAOC,iBAAiBN,QAAQW,QAAS,IAE3D,IAAIF,IAAKG,OACT,GAAIJ,cAAgB,EAChB,GAAIL,cAAgBK,eAAiBE,cAAe,CAEhD,IAAIG,UAAY,EAAIL,cACpB,MAAMM,OAASlB,SAASX,cAAcjB,kBAClC8C,SACAD,WAAwBC,OAAOC,cAEnCN,IAAMI,UAAY,KAClBD,OAAS,OACb,MAEIH,IAAM,QACNG,OAAS,OAGbH,IAAM,EACNG,OAAS,QAGbZ,OAAOR,MAAMiB,IAAMA,IACnBT,OAAOR,MAAMoB,OAASA,QAIpBzB,KAAOA,KAKTS,SAASoB,iBAAiB,UAAU,KAChCpB,SAASC,iBAAiB7B,mBAAmB8B,SACxCd,UACGE,6BAA6BF,QAAQ,GAE5C,IACF,EAAK,CACV"}