{"version":3,"file":"dynamic_tabs.min.js","sources":["../src/dynamic_tabs.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Dynamic Tabs UI element with AJAX loading of tabs content\r\n *\r\n * @module      core/dynamic_tabs\r\n * @copyright   2021 David Matamoros <davidmc@moodle.com> based on code from Marina Glancy\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport $ from 'jquery';\r\nimport Templates from 'core/templates';\r\nimport {addIconToContainer} from 'core/loadingicon';\r\nimport Notification from 'core/notification';\r\nimport Pending from 'core/pending';\r\nimport {getStrings} from 'core/str';\r\nimport {getContent} from 'core/local/repository/dynamic_tabs';\r\nimport {isAnyWatchedFormDirty, resetAllFormDirtyStates} from 'core_form/changechecker';\r\n\r\nconst SELECTORS = {\r\n    dynamicTabs: '.dynamictabs',\r\n    activeTab: '.dynamictabs .nav-link.active',\r\n    allActiveTabs: '.dynamictabs .nav-link[data-toggle=\"tab\"]:not(.disabled)',\r\n    tabContent: '.dynamictabs .tab-pane [data-tab-content]',\r\n    tabToggle: 'a[data-toggle=\"tab\"]',\r\n    tabPane: '.dynamictabs .tab-pane',\r\n};\r\n\r\nSELECTORS.forTabName = tabName => `.dynamictabs [data-tab-content=\"${tabName}\"]`;\r\nSELECTORS.forTabId = tabName => `.dynamictabs [data-toggle=\"tab\"][href=\"#${tabName}\"]`;\r\n\r\n/**\r\n * Initialises the tabs view on the page (only one tabs view per page is supported)\r\n */\r\nexport const init = () => {\r\n    const tabToggle = $(SELECTORS.tabToggle);\r\n\r\n    // Listen to click, warn user if they are navigating away with unsaved form changes.\r\n    tabToggle.on('click', (event) => {\r\n        if (!isAnyWatchedFormDirty()) {\r\n            return;\r\n        }\r\n\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n\r\n        getStrings([\r\n            {key: 'changesmade', component: 'moodle'},\r\n            {key: 'changesmadereallygoaway', component: 'moodle'},\r\n            {key: 'confirm', component: 'moodle'},\r\n        ]).then(([strChangesMade, strChangesMadeReally, strConfirm]) =>\r\n            // Reset form dirty state on confirmation, re-trigger the event.\r\n            Notification.confirm(strChangesMade, strChangesMadeReally, strConfirm, null, () => {\r\n                resetAllFormDirtyStates();\r\n                $(event.target).trigger(event.type);\r\n            })\r\n        ).catch(Notification.exception);\r\n    });\r\n\r\n    // This code listens to Bootstrap events 'show.bs.tab' and 'shown.bs.tab' which is triggered using JQuery and\r\n    // can not be converted yet to native events.\r\n    tabToggle\r\n        .on('show.bs.tab', function() {\r\n            // Clean content from previous tab.\r\n            const previousTabName = getActiveTabName();\r\n            if (previousTabName) {\r\n                const previousTab = document.querySelector(SELECTORS.forTabName(previousTabName));\r\n                previousTab.textContent = '';\r\n            }\r\n        })\r\n        .on('shown.bs.tab', function() {\r\n            const tab = $($(this).attr('href'));\r\n            if (tab.length !== 1) {\r\n                return;\r\n            }\r\n            loadTab(tab.attr('id'));\r\n        });\r\n\r\n    if (!openTabFromHash()) {\r\n        const tabs = document.querySelector(SELECTORS.allActiveTabs);\r\n        if (tabs) {\r\n            openTab(tabs.getAttribute('aria-controls'));\r\n        } else {\r\n            // We may hide tabs if there is only one available, just load the contents of the first tab.\r\n            const tabPane = document.querySelector(SELECTORS.tabPane);\r\n            if (tabPane) {\r\n                tabPane.classList.add('active', 'show');\r\n                loadTab(tabPane.getAttribute('id'));\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Returns id/name of the currently active tab\r\n *\r\n * @return {String|null}\r\n */\r\nconst getActiveTabName = () => {\r\n    const element = document.querySelector(SELECTORS.activeTab);\r\n    return element?.getAttribute('aria-controls') || null;\r\n};\r\n\r\n/**\r\n * Returns the id/name of the first tab\r\n *\r\n * @return {String|null}\r\n */\r\nconst getFirstTabName = () => {\r\n    const element = document.querySelector(SELECTORS.tabContent);\r\n    return element?.dataset.tabContent || null;\r\n};\r\n\r\n/**\r\n * Loads contents of a tab using an AJAX request\r\n *\r\n * @param {String} tabName\r\n */\r\nconst loadTab = (tabName) => {\r\n    // If tabName is not specified find the active tab, or if is not defined, the first available tab.\r\n    tabName = tabName ?? getActiveTabName() ?? getFirstTabName();\r\n    const tab = document.querySelector(SELECTORS.forTabName(tabName));\r\n    if (!tab) {\r\n        return;\r\n    }\r\n\r\n    const pendingPromise = new Pending('core/dynamic_tabs:loadTab:' + tabName);\r\n\r\n    addIconToContainer(tab)\r\n    .then(() => {\r\n        let tabArgs = {...tab.dataset};\r\n        delete tabArgs.tabClass;\r\n        delete tabArgs.tabContent;\r\n        return getContent(tab.dataset.tabClass, JSON.stringify(tabArgs));\r\n    })\r\n    .then(response => Promise.all([\r\n        $.parseHTML(response.javascript, null, true).map(node => node.innerHTML).join(\"\\n\"),\r\n        Templates.renderForPromise(response.template, JSON.parse(response.content)),\r\n    ]))\r\n    .then(([responseJs, {html, js}]) => Templates.replaceNodeContents(tab, html, js + responseJs))\r\n    .then(() => pendingPromise.resolve())\r\n    .catch(Notification.exception);\r\n};\r\n\r\n/**\r\n * Return the tab given the tab name\r\n *\r\n * @param {String} tabName\r\n * @return {HTMLElement}\r\n */\r\nconst getTab = (tabName) => {\r\n    return document.querySelector(SELECTORS.forTabId(tabName));\r\n};\r\n\r\n/**\r\n * Return the tab pane given the tab name\r\n *\r\n * @param {String} tabName\r\n * @return {HTMLElement}\r\n */\r\nconst getTabPane = (tabName) => {\r\n    return document.getElementById(tabName);\r\n};\r\n\r\n/**\r\n * Open the tab on page load. If this script loads before theme_boost/tab we need to open tab ourselves\r\n *\r\n * @param {String} tabName\r\n * @return {Boolean}\r\n */\r\nconst openTab = (tabName) => {\r\n    const tab = getTab(tabName);\r\n    if (!tab) {\r\n        return false;\r\n    }\r\n\r\n    loadTab(tabName);\r\n    tab.classList.add('active');\r\n    getTabPane(tabName).classList.add('active', 'show');\r\n    return true;\r\n};\r\n\r\n/**\r\n * If there is a location hash that is the same as the tab name - open this tab.\r\n *\r\n * @return {Boolean}\r\n */\r\nconst openTabFromHash = () => {\r\n    const hash = document.location.hash;\r\n    if (hash.match(/^#\\w+$/g)) {\r\n        return openTab(hash.replace(/^#/g, ''));\r\n    }\r\n\r\n    return false;\r\n};\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_jquery","_templates","_notification","_pending","SELECTORS","dynamicTabs","activeTab","allActiveTabs","tabContent","tabToggle","tabPane","tabName","_exports","init","$","on","event","isAnyWatchedFormDirty","preventDefault","stopPropagation","getStrings","key","component","then","_ref","strChangesMade","strChangesMadeReally","strConfirm","Notification","confirm","resetAllFormDirtyStates","target","trigger","type","catch","exception","previousTabName","getActiveTabName","document","querySelector","forTabName","textContent","tab","this","attr","length","loadTab","openTabFromHash","tabs","openTab","getAttribute","classList","add","element","getFirstTabName","dataset","pendingPromise","Pending","addIconToContainer","tabArgs","tabClass","getContent","JSON","stringify","response","Promise","all","parseHTML","javascript","map","node","innerHTML","join","Templates","renderForPromise","template","parse","content","_ref2","responseJs","html","js","replaceNodeContents","resolve","forTabId","getTab","getElementById","getTabPane","hash","location","match","replace"],"mappings":"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"}