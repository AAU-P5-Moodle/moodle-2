{"version":3,"file":"modalform.min.js","sources":["../src/modalform.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Display a form in a modal dialogue\r\n *\r\n * Example:\r\n *    import ModalForm from 'core_form/modalform';\r\n *\r\n *    const modalForm = new ModalForm({\r\n *        formClass: 'pluginname\\\\form\\\\formname',\r\n *        modalConfig: {title: 'Here comes the title'},\r\n *        args: {categoryid: 123},\r\n *        returnFocus: e.target,\r\n *    });\r\n *    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (c) => window.console.log(c.detail));\r\n *    modalForm.show();\r\n *\r\n * See also https://docs.moodle.org/dev/Modal_and_AJAX_forms\r\n *\r\n * @module     core_form/modalform\r\n * @copyright  2018 Mitxel Moriana <mitxel@tresipunt.>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Ajax from 'core/ajax';\r\nimport * as FormChangeChecker from 'core_form/changechecker';\r\nimport * as FormEvents from 'core_form/events';\r\nimport Fragment from 'core/fragment';\r\nimport ModalEvents from 'core/modal_events';\r\nimport Notification from 'core/notification';\r\nimport Pending from 'core/pending';\r\nimport {serialize} from './util';\r\n\r\nexport default class ModalForm {\r\n\r\n    /**\r\n     * Various events that can be observed.\r\n     *\r\n     * @type {Object}\r\n     */\r\n    events = {\r\n        // Form was successfully submitted - the response is passed to the event listener.\r\n        // Cancellable (but it's hardly ever needed to cancel this event).\r\n        FORM_SUBMITTED: 'core_form_modalform_formsubmitted',\r\n        // Cancel button was pressed.\r\n        // Cancellable (but it's hardly ever needed to cancel this event).\r\n        FORM_CANCELLED: 'core_form_modalform_formcancelled',\r\n        // User attempted to submit the form but there was client-side validation error.\r\n        CLIENT_VALIDATION_ERROR: 'core_form_modalform_clientvalidationerror',\r\n        // User attempted to submit the form but server returned validation error.\r\n        SERVER_VALIDATION_ERROR: 'core_form_modalform_validationerror',\r\n        // Error occurred while performing request to the server.\r\n        // Cancellable (by default calls Notification.exception).\r\n        ERROR: 'core_form_modalform_error',\r\n        // Right after user pressed no-submit button,\r\n        // listen to this event if you want to add JS validation or processing for no-submit button.\r\n        // Cancellable.\r\n        NOSUBMIT_BUTTON_PRESSED: 'core_form_modalform_nosubmitbutton',\r\n        // Right after user pressed submit button,\r\n        // listen to this event if you want to add additional JS validation or confirmation dialog.\r\n        // Cancellable.\r\n        SUBMIT_BUTTON_PRESSED: 'core_form_modalform_submitbutton',\r\n        // Right after user pressed cancel button,\r\n        // listen to this event if you want to add confirmation dialog.\r\n        // Cancellable.\r\n        CANCEL_BUTTON_PRESSED: 'core_form_modalform_cancelbutton',\r\n        // Modal was loaded and this.modal is available (but the form content may not be loaded yet).\r\n        LOADED: 'core_form_modalform_loaded',\r\n    };\r\n\r\n    /**\r\n     * Constructor\r\n     *\r\n     * Shows the required form inside a modal dialogue\r\n     *\r\n     * @param {Object} config parameters for the form and modal dialogue:\r\n     * @paramy {String} config.formClass PHP class name that handles the form (should extend \\core_form\\modal )\r\n     * @paramy {String} config.moduleName module name to use if different to core/modal_save_cancel (optional)\r\n     * @paramy {Object} config.modalConfig modal config - title, header, footer, etc.\r\n     *              Default: {removeOnClose: true, large: true}\r\n     * @paramy {Object} config.args Arguments for the initial form rendering (for example, id of the edited entity)\r\n     * @paramy {String} config.saveButtonText the text to display on the Modal \"Save\" button (optional)\r\n     * @paramy {String} config.saveButtonClasses additional CSS classes for the Modal \"Save\" button\r\n     * @paramy {HTMLElement} config.returnFocus element to return focus to after the dialogue is closed\r\n     */\r\n    constructor(config) {\r\n        this.modal = null;\r\n        this.config = config;\r\n        this.config.modalConfig = {\r\n            removeOnClose: true,\r\n            large: true,\r\n            ...(this.config.modalConfig || {}),\r\n        };\r\n        this.config.args = this.config.args || {};\r\n        this.futureListeners = [];\r\n    }\r\n\r\n    /**\r\n     * Loads the modal module and creates an instance\r\n     *\r\n     * @returns {Promise}\r\n     */\r\n    getModalModule() {\r\n        if (!this.config.moduleName && this.config.modalConfig.type && this.config.modalConfig.type !== 'SAVE_CANCEL') {\r\n            // Legacy loader for plugins that were not updated with Moodle 4.3 changes.\r\n            window.console.warn(\r\n                'Passing config.modalConfig.type to ModalForm has been deprecated since Moodle 4.3. ' +\r\n                'Please pass config.modalName instead with the full module name.',\r\n            );\r\n            return import('core/modal_factory')\r\n                .then((ModalFactory) => ModalFactory.create(this.config.modalConfig));\r\n        } else {\r\n            // New loader for Moodle 4.3 and above.\r\n            const moduleName = this.config.moduleName ?? 'core/modal_save_cancel';\r\n            return import(moduleName)\r\n                .then((module) => module.create(this.config.modalConfig));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initialise the modal and shows it\r\n     *\r\n     * @return {Promise}\r\n     */\r\n    show() {\r\n        const pendingPromise = new Pending('core_form/modalform:init');\r\n\r\n        return this.getModalModule()\r\n        .then((modal) => {\r\n            this.modal = modal;\r\n\r\n            // Retrieve the form and set the modal body. We can not set the body in the modalConfig,\r\n            // we need to make sure that the modal already exists when we render the form. Some form elements\r\n            // such as date_selector inspect the existing elements on the page to find the highest z-index.\r\n            const formParams = serialize(this.config.args || {});\r\n            const bodyContent = this.getBody(formParams);\r\n            this.modal.setBodyContent(bodyContent);\r\n            bodyContent.catch(Notification.exception);\r\n\r\n            // After successfull submit, when we press \"Cancel\" or close the dialogue by clicking on X in the top right corner.\r\n            this.modal.getRoot().on(ModalEvents.hidden, () => {\r\n                this.notifyResetFormChanges();\r\n                this.modal.destroy();\r\n                // Focus on the element that actually launched the modal.\r\n                if (this.config.returnFocus) {\r\n                    this.config.returnFocus.focus();\r\n                }\r\n            });\r\n\r\n            // Add the class to the modal dialogue.\r\n            this.modal.getModal().addClass('modal-form-dialogue');\r\n\r\n            // We catch the press on submit buttons in the forms.\r\n            this.modal.getRoot().on('click', 'form input[type=submit][data-no-submit]',\r\n                (e) => {\r\n                    e.preventDefault();\r\n                    const event = this.trigger(this.events.NOSUBMIT_BUTTON_PRESSED, e.target);\r\n                    if (!event.defaultPrevented) {\r\n                        this.processNoSubmitButton(e.target);\r\n                    }\r\n                });\r\n\r\n            // We catch the form submit event and use it to submit the form with ajax.\r\n            this.modal.getRoot().on('submit', 'form', (e) => {\r\n                e.preventDefault();\r\n                const event = this.trigger(this.events.SUBMIT_BUTTON_PRESSED);\r\n                if (!event.defaultPrevented) {\r\n                    this.submitFormAjax();\r\n                }\r\n            });\r\n\r\n            // Change the text for the save button.\r\n            if (typeof this.config.saveButtonText !== 'undefined' &&\r\n                typeof this.modal.setSaveButtonText !== 'undefined') {\r\n                this.modal.setSaveButtonText(this.config.saveButtonText);\r\n            }\r\n            // Set classes for the save button.\r\n            if (typeof this.config.saveButtonClasses !== 'undefined') {\r\n                this.setSaveButtonClasses(this.config.saveButtonClasses);\r\n            }\r\n            // When Save button is pressed - submit the form.\r\n            this.modal.getRoot().on(ModalEvents.save, (e) => {\r\n                e.preventDefault();\r\n                this.modal.getRoot().find('form').submit();\r\n            });\r\n\r\n            // When Cancel button is pressed - allow to intercept.\r\n            this.modal.getRoot().on(ModalEvents.cancel, (e) => {\r\n                const event = this.trigger(this.events.CANCEL_BUTTON_PRESSED);\r\n                if (event.defaultPrevented) {\r\n                    e.preventDefault();\r\n                }\r\n            });\r\n            this.futureListeners.forEach(args => this.modal.getRoot()[0].addEventListener(...args));\r\n            this.futureListeners = [];\r\n            this.trigger(this.events.LOADED, null, false);\r\n            return this.modal.show();\r\n        })\r\n        .then(pendingPromise.resolve);\r\n    }\r\n\r\n    /**\r\n     * Triggers a custom event\r\n     *\r\n     * @private\r\n     * @param {String} eventName\r\n     * @param {*} detail\r\n     * @param {Boolean} cancelable\r\n     * @return {CustomEvent<unknown>}\r\n     */\r\n    trigger(eventName, detail = null, cancelable = true) {\r\n        const e = new CustomEvent(eventName, {detail, cancelable});\r\n        this.modal.getRoot()[0].dispatchEvent(e);\r\n        return e;\r\n    }\r\n\r\n    /**\r\n     * Add listener for an event\r\n     *\r\n     * @param {array} args\r\n     * @example:\r\n     *    const modalForm = new ModalForm(...);\r\n     *    dynamicForm.addEventListener(modalForm.events.FORM_SUBMITTED, e => {\r\n     *        window.console.log(e.detail);\r\n     *    });\r\n     */\r\n    addEventListener(...args) {\r\n        if (!this.modal) {\r\n            this.futureListeners.push(args);\r\n        } else {\r\n            this.modal.getRoot()[0].addEventListener(...args);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get form contents (to be used in ModalForm.setBodyContent())\r\n     *\r\n     * @param {String} formDataString form data in format of a query string\r\n     * @method getBody\r\n     * @private\r\n     * @return {Promise}\r\n     */\r\n    getBody(formDataString) {\r\n        const params = {\r\n            formdata: formDataString,\r\n            form: this.config.formClass\r\n        };\r\n        const pendingPromise = new Pending('core_form/modalform:form_body');\r\n        return Ajax.call([{\r\n            methodname: 'core_form_dynamic_form',\r\n            args: params\r\n        }])[0]\r\n        .then(response => {\r\n            pendingPromise.resolve();\r\n            return {html: response.html, js: Fragment.processCollectedJavascript(response.javascript)};\r\n        })\r\n        .catch(exception => this.onSubmitError(exception));\r\n    }\r\n\r\n    /**\r\n     * On exception during form processing or initial rendering. Caller may override.\r\n     *\r\n     * @param {Object} exception\r\n     */\r\n    onSubmitError(exception) {\r\n        const event = this.trigger(this.events.ERROR, exception);\r\n        if (event.defaultPrevented) {\r\n            return;\r\n        }\r\n\r\n        Notification.exception(exception);\r\n    }\r\n\r\n    /**\r\n     * Notifies listeners that form dirty state should be reset.\r\n     *\r\n     * @fires event:formSubmittedByJavascript\r\n     */\r\n    notifyResetFormChanges() {\r\n        const form = this.getFormNode();\r\n        if (!form) {\r\n            return;\r\n        }\r\n\r\n        FormEvents.notifyFormSubmittedByJavascript(form, true);\r\n\r\n        FormChangeChecker.resetFormDirtyState(form);\r\n    }\r\n\r\n    /**\r\n     * Get the form node from the Dialogue.\r\n     *\r\n     * @returns {HTMLFormElement}\r\n     */\r\n    getFormNode() {\r\n        return this.modal.getRoot().find('form')[0];\r\n    }\r\n\r\n    /**\r\n     * Click on a \"submit\" button that is marked in the form as registerNoSubmitButton()\r\n     *\r\n     * @param {Element} button button that was pressed\r\n     * @fires event:formSubmittedByJavascript\r\n     */\r\n    processNoSubmitButton(button) {\r\n        const form = this.getFormNode();\r\n        if (!form) {\r\n            return;\r\n        }\r\n\r\n        FormEvents.notifyFormSubmittedByJavascript(form, true);\r\n\r\n        // Add the button name to the form data and submit it.\r\n        let formData = this.modal.getRoot().find('form').serialize();\r\n        formData = formData + '&' + encodeURIComponent(button.getAttribute('name')) + '=' +\r\n            encodeURIComponent(button.getAttribute('value'));\r\n\r\n        const bodyContent = this.getBody(formData);\r\n        this.modal.setBodyContent(bodyContent);\r\n        bodyContent.catch(Notification.exception);\r\n    }\r\n\r\n    /**\r\n     * Validate form elements\r\n     * @return {Boolean} Whether client-side validation has passed, false if there are errors\r\n     * @fires event:formSubmittedByJavascript\r\n     */\r\n    validateElements() {\r\n        FormEvents.notifyFormSubmittedByJavascript(this.getFormNode());\r\n\r\n        // Now the change events have run, see if there are any \"invalid\" form fields.\r\n        /** @var {jQuery} list of elements with errors */\r\n        const invalid = this.modal.getRoot().find('[aria-invalid=\"true\"], .error');\r\n\r\n        // If we found invalid fields, focus on the first one and do not submit via ajax.\r\n        if (invalid.length) {\r\n            invalid.first().focus();\r\n            return false;\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Disable buttons during form submission\r\n     */\r\n    disableButtons() {\r\n        this.modal.getFooter().find('[data-action]').attr('disabled', true);\r\n    }\r\n\r\n    /**\r\n     * Enable buttons after form submission (on validation error)\r\n     */\r\n    enableButtons() {\r\n        this.modal.getFooter().find('[data-action]').removeAttr('disabled');\r\n    }\r\n\r\n    /**\r\n     * Submit the form via AJAX call to the core_form_dynamic_form WS\r\n     */\r\n    async submitFormAjax() {\r\n        // If we found invalid fields, focus on the first one and do not submit via ajax.\r\n        if (!this.validateElements()) {\r\n            this.trigger(this.events.CLIENT_VALIDATION_ERROR, null, false);\r\n            return;\r\n        }\r\n        this.disableButtons();\r\n\r\n        // Convert all the form elements values to a serialised string.\r\n        const form = this.modal.getRoot().find('form');\r\n        const formData = form.serialize();\r\n\r\n        // Now we can continue...\r\n        Ajax.call([{\r\n            methodname: 'core_form_dynamic_form',\r\n            args: {\r\n                formdata: formData,\r\n                form: this.config.formClass\r\n            }\r\n        }])[0]\r\n        .then((response) => {\r\n            if (!response.submitted) {\r\n                // Form was not submitted because validation failed.\r\n                const promise = new Promise(\r\n                    resolve => resolve({html: response.html, js: Fragment.processCollectedJavascript(response.javascript)}));\r\n                this.modal.setBodyContent(promise);\r\n                this.enableButtons();\r\n                this.trigger(this.events.SERVER_VALIDATION_ERROR);\r\n            } else {\r\n                // Form was submitted properly. Hide the modal and execute callback.\r\n                const data = JSON.parse(response.data);\r\n                FormChangeChecker.markFormSubmitted(form[0]);\r\n                const event = this.trigger(this.events.FORM_SUBMITTED, data);\r\n                if (!event.defaultPrevented) {\r\n                    this.modal.hide();\r\n                }\r\n            }\r\n            return null;\r\n        })\r\n        .catch(exception => {\r\n            this.enableButtons();\r\n            this.onSubmitError(exception);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Set the classes for the 'save' button.\r\n     *\r\n     * @method setSaveButtonClasses\r\n     * @param {(String)} value The 'save' button classes.\r\n     */\r\n    setSaveButtonClasses(value) {\r\n        const button = this.modal.getFooter().find(\"[data-action='save']\");\r\n        if (!button) {\r\n            throw new Error(\"Unable to find the 'save' button\");\r\n        }\r\n        button.removeClass().addClass(value);\r\n    }\r\n}\r\n"],"names":["_ajax","_interopRequireDefault","FormChangeChecker","_interopRequireWildcard","FormEvents","_fragment","_modal_events","_notification","_pending","_systemImportTransformerGlobalIdentifier","window","self","global","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_exports","events","FORM_SUBMITTED","FORM_CANCELLED","CLIENT_VALIDATION_ERROR","SERVER_VALIDATION_ERROR","ERROR","NOSUBMIT_BUTTON_PRESSED","SUBMIT_BUTTON_PRESSED","CANCEL_BUTTON_PRESSED","LOADED","constructor","config","this","modal","modalConfig","removeOnClose","large","args","futureListeners","getModalModule","moduleName","type","console","warn","define","amd","Promise","resolve","reject","require","module","exports","component","loader","then","ModalFactory","create","show","pendingPromise","Pending","formParams","serialize","bodyContent","getBody","setBodyContent","catch","Notification","exception","getRoot","on","ModalEvents","hidden","notifyResetFormChanges","destroy","returnFocus","focus","getModal","addClass","preventDefault","trigger","target","defaultPrevented","processNoSubmitButton","submitFormAjax","saveButtonText","setSaveButtonText","saveButtonClasses","setSaveButtonClasses","save","find","submit","cancel","forEach","addEventListener","eventName","CustomEvent","detail","arguments","length","undefined","cancelable","dispatchEvent","_len","Array","_key","push","formDataString","params","formdata","form","formClass","Ajax","methodname","response","html","js","Fragment","processCollectedJavascript","javascript","onSubmitError","getFormNode","notifyFormSubmittedByJavascript","resetFormDirtyState","button","formData","encodeURIComponent","getAttribute","validateElements","invalid","first","disableButtons","getFooter","attr","enableButtons","removeAttr","submitted","data","JSON","parse","markFormSubmitted","hide","promise","value","Error","removeClass"],"mappings":"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"}