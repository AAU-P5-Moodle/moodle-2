{"version":3,"file":"passwordunmask.min.js","sources":["../src/passwordunmask.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Password Unmask functionality.\r\n *\r\n * @module     core_form/passwordunmask\r\n * @copyright  2016 Andrew Nicols <andrew@nicols.co.uk>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      3.2\r\n */\r\ndefine(['jquery', 'core/templates'], function($, Template) {\r\n\r\n    /**\r\n     * Constructor for PasswordUnmask.\r\n     *\r\n     * @class core_form/passwordunmask\r\n     * @param   {String}    elementid   The element to apply the PasswordUnmask to\r\n     */\r\n    var PasswordUnmask = function(elementid) {\r\n        // Setup variables.\r\n        this.wrapperSelector = '[data-passwordunmask=\"wrapper\"][data-passwordunmaskid=\"' + elementid + '\"]';\r\n        this.wrapper = $(this.wrapperSelector);\r\n        this.editorSpace = this.wrapper.find('[data-passwordunmask=\"editor\"]');\r\n        this.editLink = this.wrapper.find('a[data-passwordunmask=\"edit\"]');\r\n        this.editInstructions = this.wrapper.find('[data-passwordunmask=\"instructions\"]');\r\n        this.displayValue = this.wrapper.find('[data-passwordunmask=\"displayvalue\"]');\r\n        this.inputFieldLabel = $('label[for=\"' + elementid + '\"]');\r\n\r\n        this.inputField = this.editorSpace.find(document.getElementById(elementid));\r\n        // Hide the field.\r\n        this.inputField.addClass('d-none');\r\n        this.inputField.removeClass('hiddenifjs');\r\n\r\n        if (!this.editInstructions.attr('id')) {\r\n            this.editInstructions.attr('id', elementid + '_instructions');\r\n        }\r\n        this.editInstructions.hide();\r\n\r\n        this.setDisplayValue();\r\n\r\n        // Add the listeners.\r\n        this.addListeners();\r\n    };\r\n\r\n    /**\r\n     * Add the event listeners required for PasswordUnmask.\r\n     *\r\n     * @method  addListeners\r\n     * @return  {PasswordUnmask}\r\n     * @chainable\r\n     */\r\n    PasswordUnmask.prototype.addListeners = function() {\r\n        this.wrapper.on('click keypress', '[data-passwordunmask=\"edit\"]', $.proxy(function(e) {\r\n            if (e.type === 'keypress' && e.keyCode !== 13) {\r\n                return;\r\n            }\r\n            e.stopImmediatePropagation();\r\n            e.preventDefault();\r\n\r\n            if (this.isEditing()) {\r\n                // Only focus on the edit link if the event was not a click, and the new target is not an input field.\r\n                if (e.type !== 'click' && !$(e.relatedTarget).is(':input')) {\r\n                    this.turnEditingOff(true);\r\n                } else {\r\n                    this.turnEditingOff(false);\r\n                }\r\n            } else {\r\n                this.turnEditingOn();\r\n            }\r\n        }, this));\r\n\r\n        this.wrapper.on('click keypress', '[data-passwordunmask=\"unmask\"]', $.proxy(function(e) {\r\n            if (e.type === 'keypress' && e.keyCode !== 13) {\r\n                return;\r\n            }\r\n            e.stopImmediatePropagation();\r\n            e.preventDefault();\r\n\r\n            // Toggle the data attribute.\r\n            this.wrapper.data('unmasked', !this.wrapper.data('unmasked'));\r\n\r\n            this.setDisplayValue();\r\n        }, this));\r\n\r\n        this.wrapper.on('keydown', 'input', $.proxy(function(e) {\r\n            if (e.type === 'keydown' && e.keyCode !== 13) {\r\n                return;\r\n            }\r\n\r\n            e.stopImmediatePropagation();\r\n            e.preventDefault();\r\n\r\n            this.turnEditingOff(true);\r\n        }, this));\r\n\r\n        this.inputFieldLabel.on('click', $.proxy(function(e) {\r\n            e.preventDefault();\r\n\r\n            this.turnEditingOn();\r\n        }, this));\r\n\r\n        return this;\r\n    };\r\n\r\n    /**\r\n     * Check whether focus was lost from the PasswordUnmask and turn editing off if required.\r\n     *\r\n     * @method  checkFocusOut\r\n     * @param   {EventFacade}   e       The EventFacade generating the suspsected Focus Out\r\n     */\r\n    PasswordUnmask.prototype.checkFocusOut = function(e) {\r\n        if (!this.isEditing()) {\r\n            // Ignore - not editing.\r\n            return;\r\n        }\r\n\r\n        window.setTimeout($.proxy(function() {\r\n            // Firefox does not have the focusout event. Instead jQuery falls back to the 'blur' event.\r\n            // The blur event does not have a relatedTarget, so instead we use a timeout and the new activeElement.\r\n            var relatedTarget = e.relatedTarget || document.activeElement;\r\n            if (this.wrapper.has($(relatedTarget)).length) {\r\n                // Ignore, some part of the element is still active.\r\n                return;\r\n            }\r\n\r\n            // Only focus on the edit link if the new related target is not an input field or anchor.\r\n            this.turnEditingOff(!$(relatedTarget).is(':input,a'));\r\n        }, this), 100);\r\n    };\r\n\r\n    /**\r\n     * Whether the password is currently visible (unmasked).\r\n     *\r\n     * @method  passwordVisible\r\n     * @return  {Boolean}            True if the password is unmasked\r\n     */\r\n    PasswordUnmask.prototype.passwordVisible = function() {\r\n        return !!this.wrapper.data('unmasked');\r\n    };\r\n\r\n    /**\r\n     * Whether the user is currently editing the field.\r\n     *\r\n     * @method  isEditing\r\n     * @return  {Boolean}            True if edit mode is enabled\r\n     */\r\n    PasswordUnmask.prototype.isEditing = function() {\r\n        return this.inputField.hasClass('d-inline-block');\r\n    };\r\n\r\n    /**\r\n     * Enable the editing functionality.\r\n     *\r\n     * @method  turnEditingOn\r\n     * @return  {PasswordUnmask}\r\n     * @chainable\r\n     */\r\n    PasswordUnmask.prototype.turnEditingOn = function() {\r\n        var value = this.getDisplayValue();\r\n        if (this.passwordVisible()) {\r\n            this.inputField.attr('type', 'text');\r\n        } else {\r\n            this.inputField.attr('type', 'password');\r\n        }\r\n        this.inputField.val(value);\r\n        this.inputField.attr('size', this.inputField.attr('data-size'));\r\n        // Show the field.\r\n        this.inputField.addClass('d-inline-block');\r\n\r\n        if (this.editInstructions.length) {\r\n            this.inputField.attr('aria-describedby', this.editInstructions.attr('id'));\r\n            this.editInstructions.show();\r\n        }\r\n\r\n        this.wrapper.attr('data-passwordunmask-visible', 1);\r\n\r\n        this.editLink.hide();\r\n        this.inputField\r\n            .focus()\r\n            .select();\r\n\r\n        // Note, this cannot be added as a delegated listener on init because Firefox does not support the FocusOut\r\n        // event (https://bugzilla.mozilla.org/show_bug.cgi?id=687787) and the blur event does not identify the\r\n        // relatedTarget.\r\n        // The act of focusing the this.inputField means that in Firefox the focusout will be triggered on blur of the edit\r\n        // link anchor.\r\n        $('body').on('focusout', this.wrapperSelector, $.proxy(this.checkFocusOut, this));\r\n\r\n        return this;\r\n    };\r\n\r\n    /**\r\n     * Disable the editing functionality, optionally focusing on the edit link.\r\n     *\r\n     * @method  turnEditingOff\r\n     * @param   {Boolean}       focusOnEditLink     Whether to focus on the edit link after disabling the editor\r\n     * @return  {PasswordUnmask}\r\n     * @chainable\r\n     */\r\n    PasswordUnmask.prototype.turnEditingOff = function(focusOnEditLink) {\r\n        $('body').off('focusout', this.wrapperSelector, this.checkFocusOut);\r\n        var value = this.getDisplayValue();\r\n        this.inputField\r\n            // Ensure that the aria-describedby is removed.\r\n            .attr('aria-describedby', null);\r\n        this.inputField.val(value);\r\n        // Hide the field again.\r\n        this.inputField.removeClass('d-inline-block');\r\n\r\n        this.editInstructions.hide();\r\n\r\n        // Remove the visible attr.\r\n        this.wrapper.removeAttr('data-passwordunmask-visible');\r\n\r\n        // Remove the size attr.\r\n        this.inputField.removeAttr('size');\r\n\r\n        this.editLink.show();\r\n        this.setDisplayValue();\r\n\r\n        if (focusOnEditLink) {\r\n            this.editLink.focus();\r\n        }\r\n\r\n        return this;\r\n    };\r\n\r\n    /**\r\n     * Get the currently value.\r\n     *\r\n     * @method  getDisplayValue\r\n     * @return  {String}\r\n     */\r\n    PasswordUnmask.prototype.getDisplayValue = function() {\r\n        return this.inputField.val();\r\n    };\r\n\r\n    /**\r\n     * Set the currently value in the display, taking into account the current settings.\r\n     *\r\n     * @method  setDisplayValue\r\n     * @return  {PasswordUnmask}\r\n     * @chainable\r\n     */\r\n    PasswordUnmask.prototype.setDisplayValue = function() {\r\n        var value = this.getDisplayValue();\r\n        if (this.isEditing()) {\r\n            if (this.wrapper.data('unmasked')) {\r\n                this.inputField.attr('type', 'text');\r\n            } else {\r\n                this.inputField.attr('type', 'password');\r\n            }\r\n            this.inputField.val(value);\r\n        }\r\n\r\n        // Update the display value.\r\n        // Note: This must always be updated.\r\n        // The unmask value can be changed whilst editing and the editing can then be disabled.\r\n        if (value && this.wrapper.data('unmasked')) {\r\n            // There is a value, and we will show it.\r\n            this.displayValue.text(value);\r\n        } else {\r\n            if (!value) {\r\n                value = \"\";\r\n            }\r\n            // There is a value, but it will be disguised.\r\n            // We use the passwordunmask-fill to allow modification of the fill and to ensure that the display does not\r\n            // change as the page loads the JS.\r\n            Template.render('core_form/element-passwordunmask-fill', {\r\n                element: {\r\n                    frozen:     this.inputField.is('[readonly]'),\r\n                    value:      value,\r\n                    valuechars: value.split(''),\r\n                },\r\n            }).done($.proxy(function(html, js) {\r\n                this.displayValue.html(html);\r\n\r\n                Template.runTemplateJS(js);\r\n            }, this));\r\n        }\r\n\r\n        return this;\r\n    };\r\n\r\n    return PasswordUnmask;\r\n});\r\n"],"names":["define","$","Template","PasswordUnmask","elementid","this","wrapperSelector","wrapper","editorSpace","find","editLink","editInstructions","displayValue","inputFieldLabel","inputField","document","getElementById","addClass","removeClass","attr","hide","setDisplayValue","addListeners","prototype","on","proxy","e","type","keyCode","stopImmediatePropagation","preventDefault","isEditing","relatedTarget","is","turnEditingOff","turnEditingOn","data","checkFocusOut","window","setTimeout","activeElement","has","length","passwordVisible","hasClass","value","getDisplayValue","val","show","focus","select","focusOnEditLink","off","removeAttr","text","render","element","frozen","valuechars","split","done","html","js","runTemplateJS"],"mappings":"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"}