{"version":3,"file":"module.min.js","sources":["../src/module.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Manager for the accessreview block.\r\n *\r\n * @module block_accessreview/module\r\n * @author      Max Larkin <max@brickfieldlabs.ie>\r\n * @copyright   2020 Brickfield Education Labs <max@brickfieldlabs.ie>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {call as fetchMany} from 'core/ajax';\r\nimport * as Templates from 'core/templates';\r\nimport {exception as displayError} from 'core/notification';\r\n\r\n/**\r\n * The number of colours used to represent the heatmap. (Indexed on 0.)\r\n * @type {number}\r\n */\r\nconst numColours = 2;\r\n\r\n/**\r\n * The toggle state of the heatmap.\r\n * @type {boolean}\r\n */\r\nlet toggleState = true;\r\n\r\n/**\r\n * Renders the HTML template onto a particular HTML element.\r\n * @param {HTMLElement} element The element to attach the HTML to.\r\n * @param {number} errorCount The number of errors on this module/section.\r\n * @param {number} checkCount The number of checks triggered on this module/section.\r\n * @param {String} displayFormat\r\n * @param {Number} minViews\r\n * @param {Number} viewDelta\r\n * @returns {Promise}\r\n */\r\nconst renderTemplate = (element, errorCount, checkCount, displayFormat, minViews, viewDelta) => {\r\n    // Calculate a weight?\r\n    const weight = parseInt((errorCount - minViews) / viewDelta * numColours);\r\n\r\n    const context = {\r\n        resultPassed: !errorCount,\r\n        classList: '',\r\n        passRate: {\r\n            errorCount,\r\n            checkCount,\r\n            failureRate: Math.round(errorCount / checkCount * 100),\r\n        },\r\n    };\r\n\r\n    if (!element) {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    const elementClassList = ['block_accessreview'];\r\n    if (context.resultPassed) {\r\n        elementClassList.push('block_accessreview_success');\r\n    } else if (weight) {\r\n        elementClassList.push('block_accessreview_danger');\r\n    } else {\r\n        elementClassList.push('block_accessreview_warning');\r\n    }\r\n\r\n    const showIcons = (displayFormat == 'showicons') || (displayFormat == 'showboth');\r\n    const showBackground = (displayFormat == 'showbackground') || (displayFormat == 'showboth');\r\n\r\n    if (showBackground && !showIcons) {\r\n        // Only the background is displayed.\r\n        // No need to display the template.\r\n        // Note: The case where both the background and icons are shown is handled later to avoid jankiness.\r\n        element.classList.add(...elementClassList, 'alert');\r\n\r\n        return Promise.resolve();\r\n    }\r\n\r\n    if (showIcons && !showBackground) {\r\n        context.classList = elementClassList.join(' ');\r\n    }\r\n\r\n    // The icons are displayed either with, or without, the background.\r\n    return Templates.renderForPromise('block_accessreview/status', context)\r\n    .then(({html, js}) => {\r\n        Templates.appendNodeContents(element, html, js);\r\n\r\n        if (showBackground) {\r\n            element.classList.add(...elementClassList, 'alert');\r\n        }\r\n\r\n        return;\r\n    })\r\n    .catch();\r\n};\r\n\r\n/**\r\n * Applies the template to all sections and modules on the course page.\r\n *\r\n * @param {Number} courseId\r\n * @param {String} displayFormat\r\n * @param {Boolean} updatePreference\r\n * @returns {Promise}\r\n */\r\nconst showAccessMap = (courseId, displayFormat, updatePreference = false) => {\r\n    // Get error data.\r\n    return Promise.all(fetchReviewData(courseId, updatePreference))\r\n    .then(([sectionData, moduleData]) => {\r\n        // Get total data.\r\n        const {minViews, viewDelta} = getErrorTotals(sectionData, moduleData);\r\n\r\n        sectionData.forEach(section => {\r\n            const element = document.querySelector(`#section-${section.section} .summary`);\r\n            if (!element) {\r\n                return;\r\n            }\r\n\r\n            renderTemplate(element, section.numerrors, section.numchecks, displayFormat, minViews, viewDelta);\r\n        });\r\n\r\n        moduleData.forEach(module => {\r\n            const element = document.getElementById(`module-${module.cmid}`);\r\n            if (!element) {\r\n                return;\r\n            }\r\n\r\n            renderTemplate(element, module.numerrors, module.numchecks, displayFormat, minViews, viewDelta);\r\n        });\r\n\r\n        // Change the icon display.\r\n        document.querySelector('.icon-accessmap').classList.remove(...['fa-eye-slash']);\r\n        document.querySelector('.icon-accessmap').classList.add(...['fa-eye']);\r\n\r\n        return {\r\n            sectionData,\r\n            moduleData,\r\n        };\r\n    })\r\n    .catch(displayError);\r\n};\r\n\r\n\r\n/**\r\n * Hides or removes the templates from the HTML of the current page.\r\n *\r\n * @param {Boolean} updatePreference\r\n */\r\nconst hideAccessMap = (updatePreference = false) => {\r\n    // Removes the added elements.\r\n    document.querySelectorAll('.block_accessreview_view').forEach(node => node.remove());\r\n\r\n    const classList = [\r\n        'block_accessreview',\r\n        'block_accessreview_success',\r\n        'block_accessreview_warning',\r\n        'block_accessreview_danger',\r\n        'block_accessreview_view',\r\n        'alert',\r\n    ];\r\n\r\n    // Removes the added classes.\r\n    document.querySelectorAll('.block_accessreview').forEach(node => node.classList.remove(...classList));\r\n\r\n    if (updatePreference) {\r\n        setToggleStatePreference(false);\r\n    }\r\n\r\n    // Change the icon display.\r\n    document.querySelector('.icon-accessmap').classList.remove(...['fa-eye']);\r\n    document.querySelector('.icon-accessmap').classList.add(...['fa-eye-slash']);\r\n};\r\n\r\n\r\n/**\r\n * Toggles the heatmap on/off.\r\n *\r\n * @param {Number} courseId\r\n * @param {String} displayFormat\r\n */\r\nconst toggleAccessMap = (courseId, displayFormat) => {\r\n    toggleState = !toggleState;\r\n    if (!toggleState) {\r\n        hideAccessMap(true);\r\n    } else {\r\n        showAccessMap(courseId, displayFormat, true);\r\n    }\r\n};\r\n\r\n/**\r\n * Parses information on the errors, generating the min, max and totals.\r\n *\r\n * @param {Object[]} sectionData The error data for course sections.\r\n * @param {Object[]} moduleData The error data for course modules.\r\n * @returns {Object} An object representing the extra error information.\r\n */\r\nconst getErrorTotals = (sectionData, moduleData) => {\r\n    const totals = {\r\n        totalErrors: 0,\r\n        totalUsers: 0,\r\n        minViews: 0,\r\n        maxViews: 0,\r\n        viewDelta: 0,\r\n    };\r\n\r\n    [].concat(sectionData, moduleData).forEach(item => {\r\n        totals.totalErrors += item.numerrors;\r\n        if (item.numerrors < totals.minViews) {\r\n            totals.minViews = item.numerrors;\r\n        }\r\n\r\n        if (item.numerrors > totals.maxViews) {\r\n            totals.maxViews = item.numerrors;\r\n        }\r\n        totals.totalUsers += item.numchecks;\r\n    });\r\n\r\n    totals.viewDelta = totals.maxViews - totals.minViews + 1;\r\n\r\n    return totals;\r\n};\r\n\r\nconst registerEventListeners = (courseId, displayFormat) => {\r\n    document.addEventListener('click', e => {\r\n        if (e.target.closest('#toggle-accessmap')) {\r\n            e.preventDefault();\r\n            toggleAccessMap(courseId, displayFormat);\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Set the user preference for the toggle value.\r\n *\r\n * @param   {Boolean} toggleState\r\n * @returns {Promise}\r\n */\r\nconst getTogglePreferenceParams = toggleState => {\r\n    return {\r\n        methodname: 'core_user_update_user_preferences',\r\n        args: {\r\n            preferences: [{\r\n                type: 'block_accessreviewtogglestate',\r\n                value: toggleState,\r\n            }],\r\n        }\r\n    };\r\n};\r\n\r\nconst setToggleStatePreference = toggleState => fetchMany([getTogglePreferenceParams(toggleState)]);\r\n\r\n/**\r\n * Fetch the review data.\r\n *\r\n * @param   {Number} courseid\r\n * @param {Boolean} updatePreference\r\n * @returns {Promise[]}\r\n */\r\nconst fetchReviewData = (courseid, updatePreference = false) => {\r\n    const calls = [\r\n        {\r\n            methodname: 'block_accessreview_get_section_data',\r\n            args: {courseid}\r\n        },\r\n        {\r\n            methodname: 'block_accessreview_get_module_data',\r\n            args: {courseid}\r\n        },\r\n    ];\r\n\r\n    if (updatePreference) {\r\n        calls.push(getTogglePreferenceParams(true));\r\n    }\r\n\r\n    return fetchMany(calls);\r\n};\r\n\r\n/**\r\n * Setting up the access review module.\r\n * @param {number} toggled A number represnting the state of the review toggle.\r\n * @param {string} displayFormat A string representing the display format for icons.\r\n * @param {number} courseId The course ID.\r\n */\r\nexport const init = (toggled, displayFormat, courseId) => {\r\n    // Settings consts.\r\n    toggleState = toggled == 1;\r\n\r\n    if (toggleState) {\r\n        showAccessMap(courseId, displayFormat);\r\n    }\r\n\r\n    registerEventListeners(courseId, displayFormat);\r\n};\r\n"],"names":["_getRequireWildcardCache","e","WeakMap","r","t","Templates","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","toggleState","renderTemplate","element","errorCount","checkCount","displayFormat","minViews","viewDelta","weight","parseInt","context","resultPassed","classList","passRate","failureRate","Math","round","Promise","resolve","elementClassList","push","showIcons","showBackground","add","join","renderForPromise","then","_ref","html","js","appendNodeContents","catch","showAccessMap","courseId","updatePreference","arguments","length","undefined","all","fetchReviewData","_ref2","sectionData","moduleData","getErrorTotals","forEach","section","document","querySelector","numerrors","numchecks","module","getElementById","cmid","remove","displayError","toggleAccessMap","querySelectorAll","node","setToggleStatePreference","hideAccessMap","totals","totalErrors","totalUsers","maxViews","concat","item","getTogglePreferenceParams","methodname","args","preferences","type","value","fetchMany","courseid","calls","_exports","init","toggled","registerEventListeners","addEventListener","target","closest","preventDefault"],"mappings":"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"}