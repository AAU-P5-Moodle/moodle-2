{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * This module is responsible for PayPal content in the gateways modal.\r\n *\r\n * @module     paygw_paypal/gateways_modal\r\n * @copyright  2020 Shamim Rezaie <shamim@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport * as Repository from './repository';\r\nimport Templates from 'core/templates';\r\nimport Truncate from 'core/truncate';\r\nimport Modal from 'core/modal';\r\nimport ModalEvents from 'core/modal_events';\r\nimport {getString} from 'core/str';\r\n\r\n/**\r\n * Creates and shows a modal that contains a placeholder.\r\n *\r\n * @returns {Promise<Modal>}\r\n */\r\nconst showModalWithPlaceholder = async() => await Modal.create({\r\n    body: await Templates.render('paygw_paypal/paypal_button_placeholder', {}),\r\n    show: true,\r\n    removeOnClose: true,\r\n});\r\n\r\n/**\r\n * Process the payment.\r\n *\r\n * @param {string} component Name of the component that the itemId belongs to\r\n * @param {string} paymentArea The area of the component that the itemId belongs to\r\n * @param {number} itemId An internal identifier that is used by the component\r\n * @param {string} description Description of the payment\r\n * @returns {Promise<string>}\r\n */\r\nexport const process = (component, paymentArea, itemId, description) => {\r\n    return Promise.all([\r\n        showModalWithPlaceholder(),\r\n        Repository.getConfigForJs(component, paymentArea, itemId),\r\n    ])\r\n    .then(([modal, paypalConfig]) => {\r\n        return Promise.all([\r\n            modal,\r\n            paypalConfig,\r\n            switchSdk(paypalConfig.clientid, paypalConfig.currency),\r\n        ]);\r\n    })\r\n    .then(([modal, paypalConfig]) => {\r\n        // We have to clear the body. The render method in paypal.Buttons will render everything.\r\n        modal.setBody('');\r\n\r\n        return new Promise(resolve => {\r\n            window.paypal.Buttons({\r\n                // Set up the transaction.\r\n                createOrder: function(data, actions) {\r\n                    return actions.order.create({\r\n                        purchase_units: [{ // eslint-disable-line\r\n                            amount: {\r\n                                currency_code: paypalConfig.currency_code, // eslint-disable-line\r\n                                value: paypalConfig.cost,\r\n                            },\r\n                            description: Truncate.truncate(description, {length: 127, stripTags: true}),\r\n                        }],\r\n                        application_context: { // eslint-disable-line\r\n                            shipping_preference: 'NO_SHIPPING', // eslint-disable-line\r\n                            brand_name: Truncate.truncate(paypalConfig.brandname, {length: 127, stripTags: true}), // eslint-disable-line\r\n                        },\r\n                    });\r\n                },\r\n                // Finalise the transaction.\r\n                onApprove: function(data) {\r\n                    modal.getRoot().on(ModalEvents.outsideClick, (e) => {\r\n                        // Prevent closing the modal when clicking outside of it.\r\n                        e.preventDefault();\r\n                    });\r\n\r\n                    modal.setBody(getString('authorising', 'paygw_paypal'));\r\n\r\n                    Repository.markTransactionComplete(component, paymentArea, itemId, data.orderID)\r\n                    .then(res => {\r\n                        modal.hide();\r\n                        return res;\r\n                    })\r\n                    .then(resolve);\r\n                }\r\n            }).render(modal.getBody()[0]);\r\n        });\r\n    })\r\n    .then(res => {\r\n        if (res.success) {\r\n            return Promise.resolve(res.message);\r\n        }\r\n\r\n        return Promise.reject(res.message);\r\n    });\r\n};\r\n\r\n/**\r\n * Unloads the previously loaded PayPal JavaScript SDK, and loads a new one.\r\n *\r\n * @param {string} clientId PayPal client ID\r\n * @param {string} currency The currency\r\n * @returns {Promise}\r\n */\r\nconst switchSdk = (clientId, currency) => {\r\n    const sdkUrl = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=${currency}`;\r\n\r\n    // Check to see if this file has already been loaded. If so just go straight to the func.\r\n    if (switchSdk.currentlyloaded === sdkUrl) {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    // PayPal can only work with one currency at the same time. We have to unload the previously loaded script\r\n    // if it was loaded for a different currency. Weird way indeed, but the only way.\r\n    // See: https://github.com/paypal/paypal-checkout-components/issues/1180\r\n    if (switchSdk.currentlyloaded) {\r\n        const suspectedScript = document.querySelector(`script[src=\"${switchSdk.currentlyloaded}\"]`);\r\n        if (suspectedScript) {\r\n            suspectedScript.parentNode.removeChild(suspectedScript);\r\n        }\r\n    }\r\n\r\n    const script = document.createElement('script');\r\n\r\n    return new Promise(resolve => {\r\n        if (script.readyState) {\r\n            script.onreadystatechange = function() {\r\n                if (this.readyState == 'complete' || this.readyState == 'loaded') {\r\n                    this.onreadystatechange = null;\r\n                    resolve();\r\n                }\r\n            };\r\n        } else {\r\n            script.onload = function() {\r\n                resolve();\r\n            };\r\n        }\r\n\r\n        script.setAttribute('src', sdkUrl);\r\n        document.head.appendChild(script);\r\n\r\n        switchSdk.currentlyloaded = sdkUrl;\r\n    });\r\n};\r\n\r\n/**\r\n * Holds the full url of loaded PayPal JavaScript SDK.\r\n *\r\n * @static\r\n * @type {string}\r\n */\r\nswitchSdk.currentlyloaded = '';\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_getRequireWildcardCache","WeakMap","r","t","Repository","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","_templates","_truncate","_modal","_modal_events","showModalWithPlaceholder","async","Modal","create","body","Templates","render","show","removeOnClose","_exports","process","component","paymentArea","itemId","description","Promise","all","getConfigForJs","then","_ref","modal","paypalConfig","switchSdk","clientid","currency","_ref2","setBody","resolve","window","paypal","Buttons","createOrder","data","actions","order","purchase_units","amount","currency_code","value","cost","Truncate","truncate","length","stripTags","application_context","shipping_preference","brand_name","brandname","onApprove","getRoot","on","ModalEvents","outsideClick","preventDefault","getString","markTransactionComplete","orderID","res","hide","getBody","success","message","reject","clientId","sdkUrl","currentlyloaded","suspectedScript","document","querySelector","parentNode","removeChild","script","createElement","readyState","onreadystatechange","this","onload","setAttribute","head","appendChild"],"mappings":"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"}