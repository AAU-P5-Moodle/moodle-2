{"version":3,"file":"edittree_index.min.js","sources":["../src/edittree_index.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Enhance the gradebook tree setup with various facilities.\r\n *\r\n * @module     core_grades/edittree_index\r\n * @copyright  2016 Andrew Nicols <andrew@nicols.co.uk>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport storage from 'core/localstorage';\r\nimport {addIconToContainer} from 'core/loadingicon';\r\nimport Notification from 'core/notification';\r\nimport Pending from 'core/pending';\r\n\r\nconst SELECTORS = {\r\n    CATEGORY_TOGGLE: '.toggle-category',\r\n    GRADEBOOK_SETUP_TABLE: '.setup-grades',\r\n    WEIGHT_OVERRIDE_CHECKBOX: '.weightoverride',\r\n    BULK_MOVE_SELECT: '#menumoveafter',\r\n    BULK_MOVE_INPUT: '#bulkmoveinput',\r\n    GRADEBOOK_SETUP_WRAPPER: '.gradetree-wrapper',\r\n    GRADEBOOK_SETUP_BOX: '.gradetreebox'\r\n};\r\n\r\n/**\r\n * Register related event listeners.\r\n *\r\n * @method registerListenerEvents\r\n * @param {int} courseId The ID of course.\r\n * @param {int} userId The ID of the current logged user.\r\n */\r\nconst registerListenerEvents = (courseId, userId) => {\r\n\r\n    document.addEventListener('change', e => {\r\n        // Toggle the availability of the weight input field based on the changed state (checked/unchecked) of the\r\n        // related checkbox element.\r\n        if (e.target.matches(SELECTORS.WEIGHT_OVERRIDE_CHECKBOX)) {\r\n            toggleWeightInput(e.target);\r\n        }\r\n        // Submit the bulk move form when the selected option in the bulk move select element has been changed.\r\n        if (e.target.matches(SELECTORS.BULK_MOVE_SELECT)) {\r\n            submitBulkMoveForm(e.target);\r\n        }\r\n    });\r\n\r\n    const gradebookSetup = document.querySelector(SELECTORS.GRADEBOOK_SETUP_TABLE);\r\n    gradebookSetup.addEventListener('click', e => {\r\n        const toggle = e.target.closest(SELECTORS.CATEGORY_TOGGLE);\r\n        // Collapse or expand the grade category when the visibility toggle button is activated.\r\n        if (toggle) {\r\n            e.preventDefault();\r\n            toggleCategory(toggle, courseId, userId, true);\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Toggle the weight input field based on its checkbox.\r\n *\r\n * @method toggleWeightInput\r\n * @param {object} weightOverrideCheckbox The weight override checkbox element.\r\n */\r\nconst toggleWeightInput = (weightOverrideCheckbox) => {\r\n    const row = weightOverrideCheckbox.closest('tr');\r\n    const itemId = row.dataset.itemid;\r\n    const weightOverrideInput = row.querySelector(`input[name=\"weight_${itemId}\"]`);\r\n    weightOverrideInput.disabled = !weightOverrideCheckbox.checked;\r\n};\r\n\r\n/**\r\n * Submit the bulk move form.\r\n *\r\n * @method toggleWeightInput\r\n * @param {object} bulkMoveSelect The bulk move select element.\r\n */\r\nconst submitBulkMoveForm = (bulkMoveSelect) => {\r\n    const form = bulkMoveSelect.closest('form');\r\n    const bulkMoveInput = form.querySelector(SELECTORS.BULK_MOVE_INPUT);\r\n    bulkMoveInput.value = 1;\r\n    form.submit();\r\n};\r\n\r\n/**\r\n * Method that collapses all relevant grade categories based on the locally stored state of collapsed grade categories\r\n * for a given user.\r\n *\r\n * @method collapseGradeCategories\r\n * @param {int} courseId The ID of course.\r\n * @param {int} userId The ID of the current logged user.\r\n */\r\nconst collapseGradeCategories = (courseId, userId) => {\r\n    const gradebookSetup = document.querySelector(SELECTORS.GRADEBOOK_SETUP_TABLE);\r\n    const storedCollapsedCategories = storage.get(`core_grade_collapsedgradecategories_${courseId}_${userId}`);\r\n\r\n    if (storedCollapsedCategories) {\r\n        // Fetch all grade categories that are locally stored as collapsed and re-apply the collapse action.\r\n        const collapsedCategories = JSON.parse(storedCollapsedCategories);\r\n\r\n        collapsedCategories.forEach((category) => {\r\n            const categoryToggleElement =\r\n                gradebookSetup.querySelector(`${SELECTORS.CATEGORY_TOGGLE}[data-category=\"${category}\"`);\r\n            if (categoryToggleElement) {\r\n                toggleCategory(categoryToggleElement, courseId, userId, false);\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\n/**\r\n * Method that updates the locally stored state of collapsed grade categories based on a performed toggle action on a\r\n * given grade category.\r\n *\r\n * @method updateCollapsedCategoriesStoredState\r\n * @param {string} category The category to be added or removed from the collapsed grade categories local storage.\r\n * @param {int} courseId The ID of course.\r\n * @param {int} userId The ID of the current logged user.\r\n * @param {boolean} isCollapsing Whether the category is being collapsed or not.\r\n */\r\nconst updateCollapsedCategoriesStoredState = (category, courseId, userId, isCollapsing) => {\r\n    const currentStoredCollapsedCategories = storage.get(`core_grade_collapsedgradecategories_${courseId}_${userId}`);\r\n    let collapsedCategories = currentStoredCollapsedCategories ?\r\n        JSON.parse(currentStoredCollapsedCategories) : [];\r\n\r\n    if (isCollapsing) {\r\n        collapsedCategories.push(category);\r\n    } else {\r\n        collapsedCategories = collapsedCategories.filter(cat => cat !== category);\r\n    }\r\n    storage.set(`core_grade_collapsedgradecategories_${courseId}_${userId}`, JSON.stringify(collapsedCategories));\r\n};\r\n\r\n/**\r\n * Method that handles the grade category toggle action.\r\n *\r\n * @method toggleCategory\r\n * @param {object} toggleElement The category toggle node that was clicked.\r\n * @param {int} courseId The ID of course.\r\n * @param {int} userId The ID of the current logged user.\r\n * @param {boolean} storeCollapsedState Whether to store (local storage) the state of collapsed grade categories.\r\n */\r\nconst toggleCategory = (toggleElement, courseId, userId, storeCollapsedState) => {\r\n    const target = toggleElement.dataset.target;\r\n    const category = toggleElement.dataset.category;\r\n    // Whether the toggle action is collapsing the category or not.\r\n    const isCollapsing = toggleElement.getAttribute('aria-expanded') === \"true\";\r\n    const gradebookSetup = toggleElement.closest(SELECTORS.GRADEBOOK_SETUP_TABLE);\r\n    // Find all targeted 'children' rows of the toggled category.\r\n    const targetRows = gradebookSetup.querySelectorAll(target);\r\n    // Find the maximum grade cell in the grade category that is being collapsed/expanded.\r\n    const toggleElementRow = toggleElement.closest('tr');\r\n    const maxGradeCell = toggleElementRow.querySelector('.column-range');\r\n\r\n    if (isCollapsing) {\r\n        toggleElement.setAttribute('aria-expanded', 'false');\r\n        // Update the 'data-target' of the toggle category node to make sure that when we perform another toggle action\r\n        // to expand this category we only target rows which have been hidden by this category toggle action.\r\n        toggleElement.dataset.target = `[data-hidden-by='${category}']`;\r\n        if (maxGradeCell) {\r\n            const relatedCategoryAggregationRow = gradebookSetup.querySelector(`[data-aggregationforcategory='${category}']`);\r\n            maxGradeCell.innerHTML = relatedCategoryAggregationRow.querySelector('.column-range').innerHTML;\r\n        }\r\n    } else {\r\n        toggleElement.setAttribute('aria-expanded', 'true');\r\n        // Update the 'data-target' of the toggle category node to make sure that when we perform another toggle action\r\n        // to collapse this category we only target rows which are children of this category and are not currently hidden.\r\n        toggleElement.dataset.target = `.${category}[data-hidden='false']`;\r\n        if (maxGradeCell) {\r\n            maxGradeCell.innerHTML = '';\r\n        }\r\n    }\r\n    // If explicitly instructed, update accordingly the locally stored state of collapsed categories based on the\r\n    // toggle action performed on the given grade category.\r\n    if (storeCollapsedState) {\r\n        updateCollapsedCategoriesStoredState(category, courseId, userId, isCollapsing);\r\n    }\r\n\r\n    // Loop through all targeted child row elements and update the required data attributes to either hide or show\r\n    // them depending on the toggle action (collapsing or expanding).\r\n    targetRows.forEach((row) => {\r\n        if (isCollapsing) {\r\n            row.dataset.hidden = 'true';\r\n            row.dataset.hiddenBy = category;\r\n        } else {\r\n            row.dataset.hidden = 'false';\r\n            row.dataset.hiddenBy = '';\r\n        }\r\n    });\r\n\r\n    // Since the user report is presented in an HTML table, rowspans are used under each category to create a visual\r\n    // hierarchy between categories and grading items. When expanding or collapsing a category we need to also update\r\n    // (subtract or add) the rowspan values associated to each parent category row to preserve the correct visual\r\n    // hierarchy in the table.\r\n    updateParentCategoryRowspans(toggleElement, targetRows.length);\r\n};\r\n\r\n/**\r\n * Method that updates the rowspan value of all 'parent' category rows of a given category node.\r\n *\r\n * @method updateParentCategoryRowspans\r\n * @param {object} toggleElement The category toggle node that was clicked.\r\n * @param {int} num The number we want to add or subtract from the rowspan value of the 'parent' category row elements.\r\n */\r\nconst updateParentCategoryRowspans = (toggleElement, num) => {\r\n    const gradebookSetup = toggleElement.closest(SELECTORS.GRADEBOOK_SETUP_TABLE);\r\n    // Get the row element which contains the category toggle node.\r\n    const rowElement = toggleElement.closest('tr');\r\n\r\n    // Loop through the class list of the toggle category row element.\r\n    // The list contains classes which identify all parent categories of the toggled category.\r\n    rowElement.classList.forEach((className) => {\r\n        // Find the toggle node of the 'parent' category that is identified by the given class name.\r\n        const parentCategoryToggleElement = gradebookSetup.querySelector(`[data-target=\".${className}[data-hidden='false']\"`);\r\n        if (parentCategoryToggleElement) {\r\n            // Get the row element which contains the parent category toggle node.\r\n            const categoryRowElement = parentCategoryToggleElement.closest('tr');\r\n            // Find the rowspan element associated to this parent category.\r\n            const categoryRowSpanElement = categoryRowElement.nextElementSibling.querySelector('[rowspan]');\r\n\r\n            // Depending on whether the toggle action has expanded or collapsed the category, either add or\r\n            // subtract from the 'parent' category rowspan.\r\n            if (toggleElement.getAttribute('aria-expanded') === \"true\") {\r\n                categoryRowSpanElement.rowSpan = categoryRowSpanElement.rowSpan + num;\r\n            } else { // The category has been collapsed.\r\n                categoryRowSpanElement.rowSpan = categoryRowSpanElement.rowSpan - num;\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Initialize module.\r\n *\r\n * @method init\r\n * @param {int} courseId The ID of course.\r\n * @param {int} userId The ID of the current logged user.\r\n */\r\nexport const init = (courseId, userId) => {\r\n    const pendingPromise = new Pending();\r\n    const gradebookSetupBox = document.querySelector(SELECTORS.GRADEBOOK_SETUP_BOX);\r\n    // Display a loader while the relevant grade categories are being re-collapsed on page load (based on the locally\r\n    // stored state for the given user).\r\n    addIconToContainer(gradebookSetupBox).then((loader) => {\r\n        setTimeout(() => {\r\n            collapseGradeCategories(courseId, userId);\r\n            // Once the grade categories have been re-collapsed, remove the loader and display the Gradebook setup content.\r\n            loader.remove();\r\n            document.querySelector(SELECTORS.GRADEBOOK_SETUP_WRAPPER).classList.remove('d-none');\r\n            pendingPromise.resolve();\r\n        }, 150);\r\n        return;\r\n    }).fail(Notification.exception);\r\n\r\n    registerListenerEvents(courseId, userId);\r\n};\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_localstorage","_notification","_pending","SELECTORS","toggleWeightInput","weightOverrideCheckbox","row","closest","itemId","dataset","itemid","querySelector","disabled","checked","submitBulkMoveForm","bulkMoveSelect","form","value","submit","toggleCategory","toggleElement","courseId","userId","storeCollapsedState","target","category","isCollapsing","getAttribute","gradebookSetup","targetRows","querySelectorAll","maxGradeCell","setAttribute","relatedCategoryAggregationRow","innerHTML","updateCollapsedCategoriesStoredState","currentStoredCollapsedCategories","storage","get","collapsedCategories","JSON","parse","push","filter","cat","set","stringify","forEach","hidden","hiddenBy","updateParentCategoryRowspans","length","num","classList","className","parentCategoryToggleElement","categoryRowSpanElement","nextElementSibling","rowSpan","_exports","init","pendingPromise","Pending","gradebookSetupBox","document","addIconToContainer","then","loader","setTimeout","collapseGradeCategories","storedCollapsedCategories","categoryToggleElement","remove","resolve","fail","Notification","exception","registerListenerEvents","addEventListener","matches","toggle","preventDefault"],"mappings":"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"}