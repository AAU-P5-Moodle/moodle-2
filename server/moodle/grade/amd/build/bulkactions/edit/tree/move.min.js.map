{"version":3,"file":"move.min.js","sources":["../../../../src/bulkactions/edit/tree/move.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Class that defines the bulk move action in the gradebook setup page.\r\n *\r\n * @module     core_grades/bulkactions/edit/tree/move\r\n * @copyright  2023 Mihail Geshoski <mihail@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport BulkAction from 'core/bulkactions/bulk_action';\r\nimport {get_string as getString} from 'core/str';\r\nimport ModalSaveCancel from 'core/modal_save_cancel';\r\nimport Templates from 'core/templates';\r\nimport Ajax from 'core/ajax';\r\nimport ModalEvents from 'core/modal_events';\r\nimport MoveOptionsTree from 'core_grades/bulkactions/edit/tree/move_options_tree';\r\n\r\n/** @constant {Object} The object containing the relevant selectors. */\r\nconst Selectors = {\r\n    editTreeForm: '#gradetreeform',\r\n    bulkMoveInput: 'input[name=\"bulkmove\"]',\r\n    bulkMoveAfterInput: 'input[name=\"moveafter\"]'\r\n};\r\n\r\nexport default class GradebookEditTreeBulkMove extends BulkAction {\r\n\r\n    /** @property {int|null} courseId The course ID. */\r\n    courseId = null;\r\n\r\n    /** @property {MoveOptionsTree|null} moveOptionsTree The move options tree object. */\r\n    moveOptionsTree = null;\r\n\r\n    /** @property {string|null} gradeTree The grade tree structure. */\r\n    gradeTree = null;\r\n\r\n    /**\r\n     * The class constructor.\r\n     *\r\n     * @param {int} courseId The course ID.\r\n     * @returns {void}\r\n     */\r\n    constructor(courseId) {\r\n        super();\r\n        this.courseId = courseId;\r\n    }\r\n\r\n    /**\r\n     * Defines the selector of the element that triggers the bulk move action.\r\n     *\r\n     * @returns {string} The bulk move action trigger selector.\r\n     */\r\n    getBulkActionTriggerSelector() {\r\n        return 'button[data-action=\"move\"]';\r\n    }\r\n\r\n    /**\r\n     * Defines the behavior once the bulk move action is triggered.\r\n     *\r\n     * @method executeBulkAction\r\n     * @returns {void}\r\n     */\r\n    async triggerBulkAction() {\r\n        const modal = await this.showModal();\r\n        this.registerCustomListenerEvents(modal);\r\n    }\r\n\r\n    /**\r\n     * Renders the bulk move action trigger element.\r\n     *\r\n     * @method renderBulkActionTrigger\r\n     * @returns {Promise} The bulk move action trigger promise\r\n     */\r\n    async renderBulkActionTrigger() {\r\n        return Templates.render('core_grades/bulkactions/edit/tree/bulk_move_trigger', {});\r\n    }\r\n\r\n    /**\r\n     * Register custom event listeners.\r\n     *\r\n     * @method registerCustomClickListenerEvents\r\n     * @param {Object} modal The modal object.\r\n     * @returns {void}\r\n     */\r\n    async registerCustomListenerEvents(modal) {\r\n        await modal.getBody();\r\n        // Initialize the move options tree once the modal is shown.\r\n        modal.getRoot().on(ModalEvents.shown, () => {\r\n            this.moveOptionsTree = new MoveOptionsTree(() => {\r\n                // Enable the 'Move' action button once something is selected.\r\n                modal.setButtonDisabled('save', false);\r\n            });\r\n        });\r\n        // Destroy the modal once it is hidden.\r\n        modal.getRoot().on(ModalEvents.hidden, () => {\r\n            modal.destroy();\r\n        });\r\n        // Define the move action event.\r\n        modal.getRoot().on(ModalEvents.save, () => {\r\n            // Make sure that a move option is selected.\r\n            if (this.moveOptionsTree && this.moveOptionsTree.selectedMoveOption) {\r\n                // Set the relevant form values.\r\n                document.querySelector(Selectors.bulkMoveInput).value = 1;\r\n                document.querySelector(Selectors.bulkMoveAfterInput).value = this.moveOptionsTree.selectedMoveOption.dataset.id;\r\n                // Submit the form.\r\n                document.querySelector(Selectors.editTreeForm).submit();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Fetch the grade tree structure for the current course.\r\n     *\r\n     * @method fetchGradeTree\r\n     * @returns {Promise} The grade tree promise\r\n     */\r\n    fetchGradeTree() {\r\n        const request = {\r\n            methodname: 'core_grades_get_grade_tree',\r\n            args: {\r\n                courseid: this.courseId,\r\n            },\r\n        };\r\n        return Ajax.call([request])[0];\r\n    }\r\n\r\n    /**\r\n     * Renders the bulk move modal body.\r\n     *\r\n     * @method renderModalBody\r\n     * @returns {Promise} The modal body promise\r\n     */\r\n    async renderModalBody() {\r\n        // We need to fetch the grade tree structure only once.\r\n        if (this.gradeTree === null) {\r\n            this.gradeTree = await this.fetchGradeTree();\r\n        }\r\n\r\n        return Templates.render('core_grades/bulkactions/edit/tree/bulk_move_grade_tree',\r\n            JSON.parse(this.gradeTree));\r\n    }\r\n\r\n    /**\r\n     * Show the bulk move modal.\r\n     *\r\n     * @method showModal\r\n     * @returns {Promise} The modal promise\r\n     */\r\n     async showModal() {\r\n        const modal = await ModalSaveCancel.create({\r\n            title: await getString('movesitems', 'grades'),\r\n            body: await this.renderModalBody(),\r\n            buttons: {\r\n                save: await getString('move')\r\n            },\r\n            large: true,\r\n        });\r\n        // Disable the 'Move' action button until something is selected.\r\n        modal.setButtonDisabled('save', true);\r\n        modal.show();\r\n\r\n        return modal;\r\n    }\r\n}\r\n"],"names":["_interopRequireDefault","e","__esModule","default","_bulk_action","_modal_save_cancel","_templates","_ajax","_modal_events","_move_options_tree","Selectors","GradebookEditTreeBulkMove","BulkAction","courseId","moveOptionsTree","gradeTree","constructor","super","this","getBulkActionTriggerSelector","triggerBulkAction","modal","showModal","registerCustomListenerEvents","renderBulkActionTrigger","Templates","render","getBody","getRoot","on","ModalEvents","shown","MoveOptionsTree","setButtonDisabled","hidden","destroy","save","selectedMoveOption","document","querySelector","value","dataset","id","submit","fetchGradeTree","request","methodname","args","courseid","Ajax","call","renderModalBody","JSON","parse","ModalSaveCancel","create","title","getString","body","buttons","large","show","_exports"],"mappings":"iVA6BkF,SAAAA,uBAAAC,GAAAA,OAAAA,GAAAA,EAAAC,WAAAD,EAAAE,CAAAA,QAAAF,EAAA;;;;;;;qFANlFG,aAAAJ,uBAAAI,cAEAC,mBAAAL,uBAAAK,oBACAC,WAAAN,uBAAAM,YACAC,MAAAP,uBAAAO,OACAC,cAAAR,uBAAAQ,eACAC,mBAAAT,uBAAAS,oBAGA,MAAMC,uBACY,iBADZA,wBAEa,yBAFbA,6BAGkB,0BAGT,MAAMC,kCAAkCC,aAAAA,QAGnDC,SAAW,KAGXC,gBAAkB,KAGlBC,UAAY,KAQZC,WAAAA,CAAYH,UACRI,QACAC,KAAKL,SAAWA,QACpB,CAOAM,4BAAAA,GACI,MAAO,4BACX,CAQA,uBAAMC,GACF,MAAMC,YAAcH,KAAKI,YACzBJ,KAAKK,6BAA6BF,MACtC,CAQA,6BAAMG,GACF,OAAOC,WAAAA,QAAUC,OAAO,sDAAuD,CAAE,EACrF,CASA,kCAAMH,CAA6BF,aACzBA,MAAMM,UAEZN,MAAMO,UAAUC,GAAGC,cAAW3B,QAAC4B,OAAO,KAClCb,KAAKJ,gBAAkB,IAAIkB,mBAAAA,SAAgB,KAEvCX,MAAMY,kBAAkB,QAAQ,EAAM,GACxC,IAGNZ,MAAMO,UAAUC,GAAGC,cAAW3B,QAAC+B,QAAQ,KACnCb,MAAMc,SAAS,IAGnBd,MAAMO,UAAUC,GAAGC,cAAW3B,QAACiC,MAAM,KAE7BlB,KAAKJ,iBAAmBI,KAAKJ,gBAAgBuB,qBAE7CC,SAASC,cAAc7B,yBAAyB8B,MAAQ,EACxDF,SAASC,cAAc7B,8BAA8B8B,MAAQtB,KAAKJ,gBAAgBuB,mBAAmBI,QAAQC,GAE7GJ,SAASC,cAAc7B,wBAAwBiC,SACnD,GAER,CAQAC,cAAAA,GACI,MAAMC,QAAU,CACZC,WAAY,6BACZC,KAAM,CACFC,SAAU9B,KAAKL,WAGvB,OAAOoC,MAAAA,QAAKC,KAAK,CAACL,UAAU,EAChC,CAQA,qBAAMM,GAMF,OAJuB,OAAnBjC,KAAKH,YACLG,KAAKH,gBAAkBG,KAAK0B,kBAGzBnB,WAAStB,QAACuB,OAAO,yDACpB0B,KAAKC,MAAMnC,KAAKH,WACxB,CAQC,eAAMO,GACH,MAAMD,YAAciC,mBAAenD,QAACoD,OAAO,CACvCC,YAAa,EAAAC,KAAAA,YAAU,aAAc,UACrCC,WAAYxC,KAAKiC,kBACjBQ,QAAS,CACLvB,WAAY,EAAAqB,KAAAA,YAAU,SAE1BG,OAAO,IAMX,OAHAvC,MAAMY,kBAAkB,QAAQ,GAChCZ,MAAMwC,OAECxC,KACX,EACH,OAAAyC,SAAA3D,QAAAQ,0BAAAmD,SAAA3D,OAAA"}