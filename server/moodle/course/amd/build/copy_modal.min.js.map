{"version":3,"file":"copy_modal.min.js","sources":["../src/copy_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * This module provides the course copy modal from the course and\r\n * category management screen.\r\n *\r\n * @module     core_course/copy_modal\r\n * @copyright  2020 onward The Moodle Users Association <https://moodleassociation.org/>\r\n * @author     Matt Porritt <mattp@catalyst-au.net>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      3.9\r\n */\r\n\r\nimport {get_string as getString} from 'core/str';\r\nimport Modal from 'core/modal';\r\nimport * as ajax from 'core/ajax';\r\nimport * as Fragment from 'core/fragment';\r\nimport Notification from 'core/notification';\r\nimport * as Config from 'core/config';\r\n\r\nexport default class CopyModal {\r\n    static init(context) {\r\n        return new CopyModal(context);\r\n    }\r\n\r\n    constructor(context) {\r\n        this.contextid = context;\r\n\r\n        this.registerEventListeners();\r\n    }\r\n\r\n    registerEventListeners() {\r\n        document.addEventListener('click', (e) => {\r\n            const copyAction = e.target.closest('.action-copy');\r\n            if (!copyAction) {\r\n                return;\r\n            }\r\n            e.preventDefault(); // Stop. Hammer time.\r\n\r\n            const url = new URL(copyAction.href);\r\n            const params = new URLSearchParams(url.search);\r\n\r\n            this.fetchCourseData(params.get('id'))\r\n            .then(([course]) => this.createModal(course))\r\n            .catch((error) => Notification.exception(error));\r\n        });\r\n    }\r\n\r\n    fetchCourseData(courseid) {\r\n        return ajax.call([{\r\n            methodname: 'core_course_get_courses',\r\n            args: {\r\n                options: {\r\n                    ids: [courseid],\r\n                },\r\n            },\r\n        }])[0];\r\n    }\r\n\r\n    submitBackupRequest(jsonformdata) {\r\n        return ajax.call([{\r\n            methodname: 'core_backup_submit_copy_form',\r\n            args: {\r\n                jsonformdata,\r\n            },\r\n        }])[0];\r\n    }\r\n\r\n    createModal(\r\n        course,\r\n        formdata = {},\r\n    ) {\r\n        const params = {\r\n            jsonformdata: JSON.stringify(formdata),\r\n            courseid: course.id,\r\n        };\r\n\r\n        // Create the Modal.\r\n        return Modal.create({\r\n            title: getString('copycoursetitle', 'backup', course.shortname),\r\n            body: Fragment.loadFragment('course', 'new_base_form', this.contextid, params),\r\n            large: true,\r\n            show: true,\r\n            removeOnClose: true,\r\n        })\r\n        .then((modal) => {\r\n            // Explicitly handle form click events.\r\n            modal.getRoot().on('click', '#id_submitreturn', (e) => {\r\n                this.processModalForm(course, modal, e);\r\n            });\r\n            modal.getRoot().on('click', '#id_cancel', (e) => {\r\n                e.preventDefault();\r\n                modal.destroy();\r\n            });\r\n            modal.getRoot().on('click', '#id_submitdisplay', (e) => {\r\n                e.formredirect = true;\r\n                this.processModalForm(course, modal, e);\r\n\r\n            });\r\n\r\n            return modal;\r\n        });\r\n    }\r\n\r\n    processModalForm(course, modal, e) {\r\n        e.preventDefault(); // Stop modal from closing.\r\n\r\n        // Form data.\r\n        const copyform = modal.getRoot().find('form').serialize();\r\n        const formjson = JSON.stringify(copyform);\r\n\r\n        // Handle invalid form fields for better UX.\r\n        const invalid = modal.getRoot()[0].querySelectorAll('[aria-invalid=\"true\"], .error');\r\n        if (invalid.length) {\r\n            invalid[0].focus();\r\n            return;\r\n        }\r\n\r\n        modal.destroy();\r\n\r\n        // Submit form via ajax.\r\n        this.submitBackupRequest(formjson)\r\n        .then(() => {\r\n            if (e.formredirect == true) {\r\n                // We are redirecting to copy progress display.\r\n                const redirect = `${Config.wwwroot}/backup/copyprogress.php?id=${course.id}`;\r\n                window.location.assign(redirect);\r\n            }\r\n\r\n            return;\r\n        })\r\n        .catch(() => {\r\n            // Form submission failed server side, redisplay with errors.\r\n            this.createModal(course, copyform);\r\n        });\r\n    }\r\n}\r\n"],"names":["_getRequireWildcardCache","e","WeakMap","r","t","_interopRequireWildcard","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireDefault","_modal","ajax","Fragment","_notification","Config","CopyModal","init","context","constructor","this","contextid","registerEventListeners","document","addEventListener","copyAction","target","closest","preventDefault","url","URL","href","params","URLSearchParams","search","fetchCourseData","then","_ref","course","createModal","catch","error","Notification","exception","courseid","methodname","args","options","ids","submitBackupRequest","jsonformdata","formdata","arguments","length","undefined","JSON","stringify","id","Modal","create","title","getString","shortname","body","loadFragment","large","show","removeOnClose","modal","getRoot","on","processModalForm","destroy","formredirect","copyform","find","serialize","formjson","invalid","querySelectorAll","focus","redirect","wwwroot","window","location","assign","_exports"],"mappings":"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"}